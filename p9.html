<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>im.PS TITAN AI Max | Pro Edition v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        body { background: #020203; color: #e2e8f0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .ps-layout { display: grid; grid-template-columns: 60px 280px 1fr 300px; grid-template-rows: 50px 1fr; height: 100vh; }
        @media (max-width: 1024px) { .ps-layout { grid-template-columns: 50px 1fr; grid-template-rows: 50px 1fr 60px; } .sidebar-right, .sidebar-layers { display: none !important; } }
        .glass-panel { background: rgba(10, 10, 15, 0.98); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .tool-btn { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: 0.2s; color: #475569; position: relative; cursor: pointer; }
        .tool-btn.active { background: #3b82f6; color: white; }
        .tool-btn:hover:not(.active) { color: #8892b0; background: rgba(255,255,255,0.05); }
        .canvas-area { background-color: #080808; background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 30px 30px; position: relative; overflow: hidden; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .layer-item { transition: 0.2s; border-left: 3px solid transparent; margin-bottom: 2px; }
        .layer-item.active { background: rgba(59, 130, 246, 0.15); border-left-color: #3b82f6; color: white; }
        .filter-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .filter-btn { background: rgba(255,255,255,0.03); padding: 6px 4px; border-radius: 6px; font-size: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .filter-btn:hover { background: #3b82f6; border-color: #3b82f6; }
        .mobile-float-panel { position: absolute; bottom: 80px; left: 10px; right: 10px; background: rgba(15,15,20,0.98); border-radius: 16px; padding: 20px; display: none; z-index: 100; border: 1px solid rgba(255,255,255,0.1); }
        input[type="range"] { accent-color: #3b82f6; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-blue-500 mb-4"></div>
    <p class="text-blue-400 font-mono text-xs tracking-widest uppercase" id="loader-text">Processing AI Vision...</p>
</div>

<div class="ps-layout">
    <header class="col-span-full glass-panel flex items-center px-4 md:px-6 justify-between border-b border-white/5 z-50">
        <div class="flex items-center space-x-4">
            <span class="font-black italic text-blue-500 text-xl tracking-tighter">im.PS AI</span>
            <div class="hidden md:flex space-x-6 text-[10px] uppercase font-bold tracking-widest text-gray-500">
                <button onclick="document.getElementById('fileInput').click()" class="hover:text-blue-400">Open</button>
                <button onclick="saveProject()" class="hover:text-blue-400">Save Project</button>
                <button onclick="downloadImage()" class="text-blue-500 hover:text-blue-300">Export</button>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <button onclick="undo()" class="p-2 hover:text-blue-400" title="Undo"><i data-lucide="undo-2" class="w-4"></i></button>
            <button onclick="redo()" class="p-2 hover:text-blue-400" title="Redo"><i data-lucide="redo-2" class="w-4"></i></button>
            <button onclick="toggleFullscreen()" class="p-2 hover:text-blue-400"><i data-lucide="maximize" class="w-4"></i></button>
        </div>
    </header>

    <aside class="glass-panel flex flex-col items-center py-4 border-r border-white/5 space-y-2 z-40">
        <button class="tool-btn active" id="tool-select" title="选择" onclick="setMode('select')"><i data-lucide="mouse-pointer-2" class="w-5"></i></button>
        <button class="tool-btn" title="方形" onclick="addRect()"><i data-lucide="square" class="w-5"></i></button>
        <button class="tool-btn" title="圆形" onclick="addCircle()"><i data-lucide="circle" class="w-5"></i></button>
        <button class="tool-btn" title="文本" onclick="addText()"><i data-lucide="type" class="w-5"></i></button>
        <button class="tool-btn" id="tool-brush" title="画笔" onclick="setMode('brush')"><i data-lucide="paintbrush" class="w-5"></i></button>
        <div class="w-6 h-[1px] bg-gray-800 my-2"></div>
        <button class="tool-btn text-purple-400 hover:bg-purple-500/20" title="AI抠图" onclick="removeBackgroundAI()"><i data-lucide="sparkles" class="w-5"></i></button>
        <button class="tool-btn text-green-400" title="背景设置" onclick="toggleCanvasBg()"><i data-lucide="layout" class="w-5"></i></button>
        <div class="flex-grow"></div>
        <button class="tool-btn text-red-500 hover:bg-red-500/20" onclick="deleteSelected()"><i data-lucide="trash-2" class="w-5"></i></button>
    </aside>

    <aside class="sidebar-right glass-panel p-6 border-r border-white/5 space-y-6 overflow-y-auto hidden lg:block">
        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">变换 Transform</h3>
            <div class="grid grid-cols-2 gap-2 text-[10px] text-gray-400">
                <div>X: <input type="number" id="prop-x" class="bg-white/5 w-full p-1" oninput="updateProp('left', this.value)"></div>
                <div>Y: <input type="number" id="prop-y" class="bg-white/5 w-full p-1" oninput="updateProp('top', this.value)"></div>
            </div>
        </section>

        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">外观 Appearance</h3>
            <div class="space-y-3 text-xs">
                <div class="flex justify-between items-center">
                    <span>不透明度</span>
                    <input type="range" id="opacity" min="0" max="1" step="0.01" value="1" oninput="updateStyle()" class="w-24">
                </div>
                <div id="brush-settings" class="hidden space-y-3">
                    <div class="flex justify-between items-center">
                        <span>画笔粗细</span>
                        <input type="range" id="brush-width" min="1" max="50" value="5" oninput="updateBrush()" class="w-24">
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span>填充颜色</span>
                    <input type="color" id="fill-color" oninput="updateStyle()" class="bg-transparent w-8 h-8 cursor-pointer border-none">
                </div>
            </div>
        </section>

        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">高级滤镜 Adjustments</h3>
            <div class="filter-grid mb-4">
                <button class="filter-btn" onclick="applyFilter('Grayscale')">黑白</button>
                <button class="filter-btn" onclick="applyFilter('Sepia')">复古</button>
                <button class="filter-btn" onclick="applyFilter('Invert')">反相</button>
                <button class="filter-btn" onclick="applyFilter('none')">重置</button>
            </div>
            <div class="space-y-3 text-[10px] text-gray-400">
                <div class="flex justify-between">亮度 <input type="range" min="-1" max="1" step="0.1" value="0" oninput="applyComplexFilter('Brightness', this.value)"></div>
                <div class="flex justify-between">对比度 <input type="range" min="-1" max="1" step="0.1" value="0" oninput="applyComplexFilter('Contrast', this.value)"></div>
                <div class="flex justify-between">模糊 <input type="range" min="0" max="1" step="0.1" value="0" oninput="applyComplexFilter('Blur', this.value)"></div>
            </div>
        </section>

        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">混合模式 Blending</h3>
            <select id="blend-mode" class="w-full bg-white/5 text-[11px] p-2 rounded border border-white/10" onchange="updateStyle()">
                <option value="source-over">Normal</option>
                <option value="multiply">Multiply</option>
                <option value="screen">Screen</option>
                <option value="overlay">Overlay</option>
                <option value="difference">Difference</option>
            </select>
        </section>
    </aside>

    <main class="canvas-area flex items-center justify-center">
        <canvas id="main-canvas"></canvas>
        <input type="file" id="fileInput" class="hidden" accept="image/*">
        
        <div class="absolute bottom-4 left-4 bg-black/60 backdrop-blur px-3 py-1 rounded-full text-[9px] font-mono text-gray-300 md:block hidden">
            SPACE + DRAG: PAN | SCROLL: ZOOM | DEL: REMOVE | CTRL+S: SAVE
        </div>
    </main>

    <aside class="sidebar-layers glass-panel border-l border-white/5 p-4 hidden lg:block overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">图层 Layers</h3>
            <div class="flex space-x-1">
                <button onclick="moveLayer('up')" class="hover:text-blue-400"><i data-lucide="chevron-up" class="w-3"></i></button>
                <button onclick="moveLayer('down')" class="hover:text-blue-400"><i data-lucide="chevron-down" class="w-3"></i></button>
            </div>
        </div>
        <div id="layer-stack" class="space-y-1"></div>
    </aside>

    <footer class="mobile-bottom-bar fixed bottom-0 left-0 right-0 h-[60px] glass-panel border-t border-white/5 px-6 flex items-center justify-between lg:hidden z-50">
        <button onclick="document.getElementById('fileInput').click()" class="text-gray-400"><i data-lucide="image-plus"></i></button>
        <button onclick="setMode('select')" class="text-blue-400"><i data-lucide="mouse-pointer-2"></i></button>
        <button onclick="addRect()" class="text-gray-400"><i data-lucide="square"></i></button>
        <button onclick="removeBackgroundAI()" class="text-purple-400"><i data-lucide="sparkles"></i></button>
        <button onclick="downloadImage()" class="text-green-400"><i data-lucide="download"></i></button>
    </footer>
</div>

<script>
    // 1. 初始化核心
    const canvas = new fabric.Canvas('main-canvas', {
        width: window.innerWidth > 1024 ? window.innerWidth - 640 : window.innerWidth - 70,
        height: window.innerHeight - 100,
        backgroundColor: '#080808',
        preserveObjectStacking: true
    });

    let history = [];
    let mods = 0;
    let canvasBgMode = 'dark'; // dark, grid, light
    lucide.createIcons();

    // 智能辅助线设置
    fabric.Object.prototype.set({
        transparentCorners: false,
        cornerColor: '#3b82f6',
        cornerStrokeColor: '#ffffff',
        borderColor: '#3b82f6',
        cornerSize: 8,
        padding: 5
    });

    // 2. AI & 抠图
    const selfieSegmentation = new SelfieSegmentation({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
    });
    selfieSegmentation.setOptions({ modelSelection: 1 });
    selfieSegmentation.onResults(onAIResults);

    async function removeBackgroundAI() {
        const obj = canvas.getActiveObject();
        if (!obj || obj.type !== 'image') return alert("请先选中一张图片");
        showLoader("AI Segmenting Background...");
        await selfieSegmentation.send({ image: obj._element });
    }

    function onAIResults(results) {
        const temp = document.createElement('canvas');
        temp.width = results.image.width; temp.height = results.image.height;
        const ctx = temp.getContext('2d');
        ctx.drawImage(results.segmentationMask, 0, 0, temp.width, temp.height);
        ctx.globalCompositeOperation = 'source-in';
        ctx.drawImage(results.image, 0, 0, temp.width, temp.height);

        fabric.Image.fromURL(temp.toDataURL(), (newImg) => {
            const old = canvas.getActiveObject();
            newImg.set({ left: old.left, top: old.top, scaleX: old.scaleX, scaleY: old.scaleY });
            canvas.remove(old).add(newImg).setActiveObject(newImg);
            hideLoader();
            saveHistory(); renderLayers();
        });
    }

    // 3. 基础功能 & 形状扩展
    function addRect() { addObject(new fabric.Rect({ left: 100, top: 100, fill: '#3b82f6', width: 100, height: 100 })); }
    function addCircle() { addObject(new fabric.Circle({ left: 150, top: 150, fill: '#ef4444', radius: 50 })); }
    function addText() { addObject(new fabric.IText('Double Click', { left: 100, top: 100, fill: '#fff', fontSize: 24, fontFamily: 'Inter' })); }
    
    function addObject(obj) {
        canvas.add(obj).setActiveObject(obj);
        saveHistory(); renderLayers();
    }

    // 4. 画布 & 背景控制
    function toggleCanvasBg() {
        const bgMap = { 'dark': '#080808', 'light': '#ffffff', 'grid': 'transparent' };
        const modes = ['dark', 'light', 'grid'];
        canvasBgMode = modes[(modes.indexOf(canvasBgMode) + 1) % 3];
        
        const area = document.querySelector('.canvas-area');
        if(canvasBgMode === 'grid') {
            area.style.backgroundImage = `linear-gradient(45deg, #111 25%, transparent 25%), linear-gradient(-45deg, #111 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #111 75%), linear-gradient(-45deg, transparent 75%, #111 75%)`;
            area.style.backgroundSize = '20px 20px';
            canvas.setBackgroundColor('rgba(0,0,0,0)', canvas.renderAll.bind(canvas));
        } else {
            area.style.backgroundImage = 'none';
            canvas.setBackgroundColor(bgMap[canvasBgMode], canvas.renderAll.bind(canvas));
        }
    }

    // 5. 滤镜系统
    function applyFilter(type) {
        const obj = canvas.getActiveObject();
        if (!obj || obj.type !== 'image') return;
        obj.filters = [];
        if (type === 'Grayscale') obj.filters.push(new fabric.Image.filters.Grayscale());
        if (type === 'Sepia') obj.filters.push(new fabric.Image.filters.Sepia());
        if (type === 'Invert') obj.filters.push(new fabric.Image.filters.Invert());
        obj.applyFilters();
        canvas.renderAll();
    }

    function applyComplexFilter(filterName, value) {
        const obj = canvas.getActiveObject();
        if (!obj || obj.type !== 'image') return;
        let f = null;
        if(filterName === 'Brightness') f = new fabric.Image.filters.Brightness({ brightness: parseFloat(value) });
        if(filterName === 'Contrast') f = new fabric.Image.filters.Contrast({ contrast: parseFloat(value) });
        if(filterName === 'Blur') f = new fabric.Image.filters.Blur({ blur: parseFloat(value) });
        
        const index = obj.filters.findIndex(i => i.type === filterName);
        if(index > -1) obj.filters[index] = f; else obj.filters.push(f);
        obj.applyFilters();
        canvas.renderAll();
    }

    // 6. 属性实时同步
    function updateStyle() {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        obj.set({
            fill: document.getElementById('fill-color').value,
            opacity: parseFloat(document.getElementById('opacity').value),
            globalCompositeOperation: document.getElementById('blend-mode').value
        });
        canvas.renderAll();
    }

    function updateProp(prop, val) {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        obj.set(prop, parseFloat(val));
        canvas.renderAll();
    }

    canvas.on('object:moving', (e) => {
        document.getElementById('prop-x').value = Math.round(e.target.left);
        document.getElementById('prop-y').value = Math.round(e.target.top);
    });

    // 7. 画笔管理
    function updateBrush() {
        if(!canvas.isDrawingMode) return;
        canvas.freeDrawingBrush.width = parseInt(document.getElementById('brush-width').value);
        canvas.freeDrawingBrush.color = document.getElementById('fill-color').value;
    }

    // 8. 图层进阶管理
    function renderLayers() {
        const stack = document.getElementById('layer-stack');
        if (!stack) return;
        stack.innerHTML = '';
        const objects = canvas.getObjects();
        
        [...objects].reverse().forEach((obj, index) => {
            const actualIndex = objects.indexOf(obj);
            const div = document.createElement('div');
            div.className = `layer-item flex items-center justify-between p-2 text-[10px] cursor-pointer rounded ${canvas.getActiveObject() === obj ? 'active' : 'bg-white/5'}`;
            div.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 rounded border border-white/10" style="background:${obj.fill || '#555'}"></div>
                    <span class="font-mono">Layer ${actualIndex}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleLayerVis(${actualIndex}, event)"><i data-lucide="${obj.visible?'eye':'eye-off'}" class="w-3"></i></button>
                    <button onclick="removeLayer(${actualIndex}, event)" class="hover:text-red-400"><i data-lucide="trash-2" class="w-3"></i></button>
                </div>
            `;
            div.onclick = () => { canvas.setActiveObject(obj); canvas.renderAll(); renderLayers(); };
            stack.appendChild(div);
        });
        lucide.createIcons();
    }

    function moveLayer(dir) {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        if(dir === 'up') canvas.bringForward(obj);
        else canvas.sendBackwards(obj);
        renderLayers();
    }

    function toggleLayerVis(index, e) { e.stopPropagation(); const obj = canvas.getObjects()[index]; obj.visible = !obj.visible; canvas.renderAll(); renderLayers(); }
    function removeLayer(index, e) { e.stopPropagation(); canvas.remove(canvas.getObjects()[index]); renderLayers(); }

    // 9. 撤销/重做 & 自动保存
    function saveHistory() {
        if(mods < history.length) history = history.slice(0, mods);
        history.push(JSON.stringify(canvas)); mods++;
        localStorage.setItem('ps_titan_project', JSON.stringify(canvas));
    }

    function saveProject() {
        saveHistory();
        alert("Project saved to local storage!");
    }

    function undo() { if(mods > 1) { mods--; canvas.loadFromJSON(history[mods-1], () => { canvas.renderAll(); renderLayers(); }); } }
    function redo() { if(mods < history.length) { canvas.loadFromJSON(history[mods], () => { canvas.renderAll(); renderLayers(); }); mods++; } }

    // 10. 全屏与系统交互
    function toggleFullscreen() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else document.exitFullscreen();
    }

    function setMode(mode) {
        canvas.isDrawingMode = (mode === 'brush');
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tool-' + mode).classList.add('active');
        document.getElementById('brush-settings').style.display = (mode === 'brush' ? 'block' : 'none');
        if(mode === 'brush') updateBrush();
    }

    function showLoader(text) { 
        document.getElementById('loader-text').innerText = text;
        document.getElementById('loader').style.display = 'flex'; 
    }
    function hideLoader() { document.getElementById('loader').style.display = 'none'; }

    // 初始化事件
    window.addEventListener('keydown', (e) => { 
        if(e.code === 'Space') isPanning = true; 
        if(e.code === 'Delete' || e.code === 'Backspace') deleteSelected();
        if(e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
        if(e.ctrlKey && e.key === 's') { e.preventDefault(); saveProject(); }
    });

    let isPanning = false;
    canvas.on('mouse:move', (opt) => { if (isPanning && opt.e) canvas.relativePan(new fabric.Point(opt.e.movementX, opt.e.movementY)); });
    window.addEventListener('keyup', (e) => { if(e.code === 'Space') isPanning = false; });

    canvas.on('mouse:wheel', function(opt) {
        let zoom = canvas.getZoom() * (0.999 ** opt.e.deltaY);
        zoom = Math.min(Math.max(0.01, zoom), 20);
        canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
        opt.e.preventDefault();
    });

    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => fabric.Image.fromURL(f.target.result, img => {
            img.scaleToWidth(400);
            addObject(img);
        });
        reader.readAsDataURL(e.target.files[0]);
    };

    function downloadImage() {
        const dataURL = canvas.toDataURL({ format: 'png', quality: 1 });
        const link = document.createElement('a');
        link.download = `TITAN_PRO_${Date.now()}.png`;
        link.href = dataURL;
        link.click();
    }

    function deleteSelected() { 
        canvas.getActiveObjects().forEach(obj => canvas.remove(obj));
        canvas.discardActiveObject(); 
        renderLayers(); 
    }

    window.addEventListener('resize', () => {
        canvas.setDimensions({ 
            width: window.innerWidth > 1024 ? window.innerWidth - 640 : window.innerWidth - 70, 
            height: window.innerHeight - 100 
        });
    });

    // 启动时加载本地缓存
    window.onload = () => {
        const saved = localStorage.getItem('ps_titan_project');
        if(saved) {
            canvas.loadFromJSON(saved, () => {
                canvas.renderAll();
                renderLayers();
                saveHistory();
            });
        } else {
            saveHistory();
        }
    }
</script>
</body>
</html>