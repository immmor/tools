<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>im.PS TITAN AI Max | Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        body { background: #020203; color: #e2e8f0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        
        /* 响应式布局 */
        .ps-layout { 
            display: grid; 
            grid-template-columns: 60px 280px 1fr 300px; 
            grid-template-rows: 50px 1fr; 
            height: 100vh; 
        }

        @media (max-width: 1024px) {
            .ps-layout {
                grid-template-columns: 50px 1fr;
                grid-template-rows: 50px 1fr 60px;
            }
            .sidebar-right, .sidebar-layers { display: none !important; }
            .mobile-bottom-bar { display: flex !important; }
        }

        .glass-panel { background: rgba(10, 10, 15, 0.98); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .tool-btn { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: 0.2s; color: #475569; position: relative; cursor: pointer; }
        .tool-btn.active { background: #3b82f6; color: white; }
        .tool-btn:hover:not(.active) { color: #8892b0; background: rgba(255,255,255,0.05); }
        
        .canvas-area { background-color: #080808; background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 30px 30px; position: relative; overflow: hidden; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        
        /* 图层样式增强 */
        .layer-item { transition: 0.2s; border-left: 3px solid transparent; margin-bottom: 2px; }
        .layer-item.active { background: rgba(59, 130, 246, 0.15); border-left-color: #3b82f6; color: white; }
        
        /* 滤镜按钮 */
        .filter-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .filter-btn { background: rgba(255,255,255,0.03); padding: 10px 4px; border-radius: 6px; font-size: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .filter-btn:hover { background: #3b82f6; border-color: #3b82f6; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #2d2d39; border-radius: 10px; }
        .mobile-float-panel { position: absolute; bottom: 80px; left: 10px; right: 10px; background: rgba(15,15,20,0.98); border-radius: 16px; padding: 20px; display: none; z-index: 100; border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-blue-500 mb-4"></div>
    <p class="text-blue-400 font-mono text-xs tracking-widest uppercase">Processing AI Vision...</p>
</div>

<div class="ps-layout">
    <header class="col-span-full glass-panel flex items-center px-4 md:px-6 justify-between border-b border-white/5 z-50">
        <div class="flex items-center space-x-4">
            <span class="font-black italic text-blue-500 text-xl tracking-tighter">im.PS AI</span>
            <div class="hidden md:flex space-x-6 text-[10px] uppercase font-bold tracking-widest text-gray-500">
                <button onclick="document.getElementById('fileInput').click()" class="hover:text-blue-400">Open</button>
                <button onclick="downloadImage()" class="text-blue-500 hover:text-blue-300">Export</button>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <button onclick="undo()" class="p-2 hover:text-blue-400" title="Undo (Ctrl+Z)"><i data-lucide="undo-2" class="w-4"></i></button>
            <button onclick="redo()" class="p-2 hover:text-blue-400" title="Redo (Ctrl+Y)"><i data-lucide="redo-2" class="w-4"></i></button>
            <button class="md:hidden p-2 text-white" onclick="toggleMobilePanel()"><i data-lucide="settings-2" class="w-4"></i></button>
        </div>
    </header>

    <aside class="glass-panel flex flex-col items-center py-4 border-r border-white/5 space-y-2 z-40">
        <button class="tool-btn active" id="tool-select" onclick="setMode('select')"><i data-lucide="mouse-pointer-2" class="w-5"></i></button>
        <button class="tool-btn" onclick="addRect()"><i data-lucide="square" class="w-5"></i></button>
        <button class="tool-btn" onclick="addText()"><i data-lucide="type" class="w-5"></i></button>
        <button class="tool-btn" id="tool-brush" onclick="toggleDrawing()"><i data-lucide="paintbrush" class="w-5"></i></button>
        <button class="tool-btn text-purple-400 hover:bg-purple-500/20" onclick="removeBackgroundAI()"><i data-lucide="sparkles" class="w-5"></i></button>
        <div class="w-6 h-[1px] bg-gray-800 my-2"></div>
        <button class="tool-btn text-red-500 hover:bg-red-500/20" onclick="deleteSelected()"><i data-lucide="trash-2" class="w-5"></i></button>
    </aside>

    <aside class="sidebar-right glass-panel p-6 border-r border-white/5 space-y-8 overflow-y-auto hidden lg:block">
        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">外观 Appearance</h3>
            <div class="space-y-4 text-xs">
                <div class="flex justify-between items-center">
                    <span>不透明度 Opacity</span>
                    <input type="range" id="opacity" min="0" max="1" step="0.01" value="1" oninput="updateStyle()" class="w-24">
                </div>
                <div class="flex justify-between items-center">
                    <span>圆角半径 Radius</span>
                    <input type="range" id="radius" min="0" max="100" step="1" value="0" oninput="updateStyle()" class="w-24">
                </div>
                <div class="flex justify-between items-center">
                    <span>填充颜色 Color</span>
                    <input type="color" id="fill-color" oninput="updateStyle()" class="bg-transparent w-8 h-8 cursor-pointer">
                </div>
            </div>
        </section>

        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">AI 滤镜 Filters</h3>
            <div class="filter-grid">
                <button class="filter-btn" onclick="applyFilter('Grayscale')">黑白</button>
                <button class="filter-btn" onclick="applyFilter('Sepia')">复古</button>
                <button class="filter-btn" onclick="applyFilter('Invert')">反相</button>
                <button class="filter-btn" onclick="applyFilter('none')">重置</button>
            </div>
        </section>

        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">混合模式 Blending</h3>
            <select id="blend-mode" class="w-full bg-white/5 text-[11px] p-3 rounded border border-white/10 outline-none" onchange="updateStyle()">
                <option value="source-over">Normal</option>
                <option value="multiply">Multiply</option>
                <option value="screen">Screen</option>
                <option value="overlay">Overlay</option>
            </select>
        </section>
    </aside>

    <main class="canvas-area flex items-center justify-center">
        <canvas id="main-canvas"></canvas>
        <input type="file" id="fileInput" class="hidden" accept="image/*">
        
        <div id="mobile-panel" class="mobile-float-panel glass-panel">
            <div class="flex justify-between items-center mb-6">
                <span class="text-xs font-bold text-blue-500">QUICK ADJUST</span>
                <button onclick="toggleMobilePanel()" class="text-gray-500"><i data-lucide="x" class="w-5"></i></button>
            </div>
            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] text-gray-500">OPACITY</label>
                    <input type="range" id="mob-opacity" min="0" max="1" step="0.01" value="1" oninput="updateStyle(true)" class="w-full">
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadImage()" class="flex-1 py-3 bg-blue-600 rounded-lg text-xs font-bold">EXPORT</button>
                    <button onclick="document.getElementById('fileInput').click()" class="flex-1 py-3 bg-white/5 rounded-lg text-xs">IMPORT</button>
                </div>
            </div>
        </div>

        <div class="absolute bottom-4 left-4 bg-black/40 backdrop-blur px-3 py-1 rounded-full text-[9px] font-mono text-gray-400 md:block hidden">
            SPACE + DRAG TO PAN | SCROLL TO ZOOM | DEL TO REMOVE
        </div>
    </main>

    <aside class="sidebar-layers glass-panel border-l border-white/5 p-4 hidden lg:block overflow-y-auto">
        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">图层 Layers</h3>
        <div id="layer-stack" class="space-y-1">
            </div>
    </aside>

    <footer class="mobile-bottom-bar fixed bottom-0 left-0 right-0 h-[60px] glass-panel border-t border-white/5 px-6 flex items-center justify-between lg:hidden z-50">
        <button onclick="document.getElementById('fileInput').click()" class="text-gray-400"><i data-lucide="image-plus"></i></button>
        <button onclick="setMode('select')" class="text-blue-400"><i data-lucide="mouse-pointer-2"></i></button>
        <button onclick="addRect()" class="text-gray-400"><i data-lucide="square"></i></button>
        <button onclick="removeBackgroundAI()" class="text-purple-400"><i data-lucide="sparkles"></i></button>
        <button onclick="downloadImage()" class="text-green-400"><i data-lucide="download"></i></button>
    </footer>
</div>

<script>
    // 1. 初始化核心
    const canvas = new fabric.Canvas('main-canvas', {
        width: window.innerWidth > 1024 ? 900 : window.innerWidth - 70,
        height: window.innerHeight - 150,
        backgroundColor: '#080808',
        preserveObjectStacking: true
    });

    let history = [];
    let mods = 0;
    lucide.createIcons();

    // 2. AI 抠图引擎
    const selfieSegmentation = new SelfieSegmentation({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
    });
    selfieSegmentation.setOptions({ modelSelection: 1 });
    selfieSegmentation.onResults(onAIResults);

    async function removeBackgroundAI() {
        const obj = canvas.getActiveObject();
        if (!obj || obj.type !== 'image') return alert("请先选中一张图片");
        document.getElementById('loader').style.display = 'flex';
        await selfieSegmentation.send({ image: obj._element });
    }

    function onAIResults(results) {
        const temp = document.createElement('canvas');
        temp.width = results.image.width; temp.height = results.image.height;
        const ctx = temp.getContext('2d');
        ctx.drawImage(results.segmentationMask, 0, 0, temp.width, temp.height);
        ctx.globalCompositeOperation = 'source-in';
        ctx.drawImage(results.image, 0, 0, temp.width, temp.height);

        fabric.Image.fromURL(temp.toDataURL(), (newImg) => {
            const old = canvas.getActiveObject();
            newImg.set({ left: old.left, top: old.top, scaleX: old.scaleX, scaleY: old.scaleY });
            canvas.remove(old).add(newImg).setActiveObject(newImg);
            document.getElementById('loader').style.display = 'none';
            saveHistory(); renderLayers();
        });
    }

    // 3. 基础功能
    function addRect() { addObject(new fabric.Rect({ left: 100, top: 100, fill: '#3b82f6', width: 150, height: 150, rx: 0, ry: 0 })); }
    function addText() { addObject(new fabric.IText('Double Click Edit', { left: 100, top: 100, fill: '#fff', fontSize: 24, fontFamily: 'Inter' })); }
    
    function addObject(obj) {
        obj.set({ cornerColor: '#3b82f6', cornerSize: 10, transparentCorners: false, borderColor: '#3b82f6' });
        canvas.add(obj).setActiveObject(obj);
        saveHistory(); renderLayers();
    }

    function updateStyle(isMobile = false) {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        
        const op = document.getElementById(isMobile ? 'mob-opacity' : 'opacity').value;
        const rad = document.getElementById('radius').value;
        const color = document.getElementById('fill-color').value;
        const blend = document.getElementById('blend-mode').value;

        obj.set({
            fill: obj.type === 'image' ? obj.fill : color,
            opacity: parseFloat(op),
            rx: parseInt(rad),
            ry: parseInt(rad),
            globalCompositeOperation: blend
        });
        canvas.renderAll();
    }

    function applyFilter(type) {
        const obj = canvas.getActiveObject();
        if (!obj || obj.type !== 'image') return;
        
        obj.filters = [];
        if (type === 'Grayscale') obj.filters.push(new fabric.Image.filters.Grayscale());
        if (type === 'Sepia') obj.filters.push(new fabric.Image.filters.Sepia());
        if (type === 'Invert') obj.filters.push(new fabric.Image.filters.Invert());
        
        obj.applyFilters();
        canvas.renderAll();
    }

    // 4. 图层管理增强
    function renderLayers() {
        const stack = document.getElementById('layer-stack');
        if (!stack) return;
        stack.innerHTML = '';
        const objects = canvas.getObjects();
        
        [...objects].reverse().forEach((obj, index) => {
            const actualIndex = objects.indexOf(obj);
            const div = document.createElement('div');
            div.className = `layer-item flex items-center justify-between p-3 text-[10px] cursor-pointer rounded ${canvas.getActiveObject() === obj ? 'active' : 'bg-white/5'}`;
            
            div.innerHTML = `
                <span class="font-mono">#${actualIndex} ${obj.type.toUpperCase()}</span>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleLayerVis(${actualIndex}, event)" class="hover:text-blue-400">
                        <i data-lucide="${obj.visible ? 'eye' : 'eye-off'}" class="w-3"></i>
                    </button>
                    <button onclick="removeLayer(${actualIndex}, event)" class="hover:text-red-400">
                        <i data-lucide="x" class="w-3"></i>
                    </button>
                </div>
            `;
            div.onclick = () => { canvas.setActiveObject(obj); canvas.renderAll(); renderLayers(); };
            stack.appendChild(div);
        });
        lucide.createIcons();
    }

    function toggleLayerVis(index, e) {
        e.stopPropagation();
        const obj = canvas.getObjects()[index];
        obj.visible = !obj.visible;
        canvas.renderAll();
        renderLayers();
    }

    function removeLayer(index, e) {
        e.stopPropagation();
        canvas.remove(canvas.getObjects()[index]);
        renderLayers();
    }

    // 5. 交互交互与快捷键
    let isPanning = false;
    window.addEventListener('keydown', (e) => { 
        if(e.code === 'Space') isPanning = true; 
        if(e.code === 'Delete' || e.code === 'Backspace') deleteSelected();
        if(e.ctrlKey && e.key === 'z') undo();
        if(e.ctrlKey && e.key === 'y') redo();
    });
    window.addEventListener('keyup', (e) => { if(e.code === 'Space') isPanning = false; });

    canvas.on('mouse:move', (opt) => {
        if (isPanning && opt.e) canvas.relativePan(new fabric.Point(opt.e.movementX, opt.e.movementY));
    });

    canvas.on('mouse:wheel', function(opt) {
        let zoom = canvas.getZoom() * (0.999 ** opt.e.deltaY);
        if (zoom > 20) zoom = 20; if (zoom < 0.01) zoom = 0.01;
        canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
        opt.e.preventDefault();
    });

    canvas.on('selection:created', renderLayers);
    canvas.on('selection:cleared', renderLayers);

    // 6. 系统功能
    function saveHistory() {
        if(mods < history.length) history = history.slice(0, mods);
        history.push(JSON.stringify(canvas)); mods++;
    }
    function undo() { if(mods > 1) { mods--; canvas.loadFromJSON(history[mods-1], () => { canvas.renderAll(); renderLayers(); }); } }
    function redo() { if(mods < history.length) { canvas.loadFromJSON(history[mods], () => { canvas.renderAll(); renderLayers(); }); mods++; } }

    function setMode(mode) {
        canvas.isDrawingMode = (mode === 'brush');
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        if(mode === 'select') document.getElementById('tool-select').classList.add('active');
        if(mode === 'brush') document.getElementById('tool-brush').classList.add('active');
    }

    function toggleDrawing() { setMode(canvas.isDrawingMode ? 'select' : 'brush'); }
    function toggleMobilePanel() { const p = document.getElementById('mobile-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }

    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => fabric.Image.fromURL(f.target.result, img => {
            img.scaleToWidth(400);
            addObject(img);
        });
        reader.readAsDataURL(e.target.files[0]);
    };

    function downloadImage() {
        const dataURL = canvas.toDataURL({ format: 'png', quality: 1 });
        const link = document.createElement('a');
        link.download = `TITAN_PS_${Date.now()}.png`;
        link.href = dataURL;
        link.click();
    }

    function deleteSelected() { 
        canvas.getActiveObjects().forEach(obj => canvas.remove(obj));
        canvas.discardActiveObject(); 
        renderLayers(); 
    }

    window.addEventListener('resize', () => {
        canvas.setDimensions({ 
            width: window.innerWidth > 1024 ? 900 : window.innerWidth - 70, 
            height: window.innerHeight - 150 
        });
    });

    renderLayers();
</script>
</body>
</html>