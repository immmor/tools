<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>immmor MindMap | 脑图编辑器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: radial-gradient(circle at top right, #1e293b, #0f172a, #000000);
            min-height: 100vh;
            color: white;
            overflow: hidden; /* 防止滚动条出现，因为有固定定位的元素 */
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .glass:hover {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }
        .gradient-text {
            background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .canvas-bg {
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="font-sans">

    <nav class="fixed top-0 left-0 right-0 glass px-4 md:px-6 py-3 z-50 flex justify-between items-center shadow-lg">
        <div class="flex items-center space-x-2 md:space-x-4">
            <a href="/" class="text-lg md:text-xl font-bold tracking-tighter gradient-text">immmor</a>
            <span class="text-gray-400 text-xs md:text-sm hidden md:block">/ 脑图编辑器</span>
            <div class="ml-4 md:ml-8 text-white text-sm md:text-lg">
                <input type="text" value="我的新脑图" class="bg-transparent border-none focus:outline-none focus:ring-0 w-24 md:w-48" />
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <button class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-white/10 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-2-4l-4 4m0 0l4 4m-4-4h8" /></svg>
            </button>
            <button class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-white/10 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
            </button>
            <button class="bg-blue-600 text-white px-3 py-1 rounded-md text-xs md:text-sm hover:bg-blue-700 transition">保存</button>
        </div>
    </nav>

    <div class="flex flex-1 pt-16" style="height: calc(100vh - 64px);">
        
        <aside class="w-14 md:w-16 flex-shrink-0 bg-gray-900/50 pt-4 flex flex-col items-center space-y-4 shadow-lg z-30">
            <button class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-white/10 transition" title="新建节点">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>
            <button class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-white/10 transition" title="删除节点">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
            <button class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-white/10 transition" title="撤销">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12.062 12.062a2 2 0 10-2.828-2.828l-4.95 4.95a2 2 0 102.828 2.828l4.95-4.95zm0 0l1.414 1.414M15.062 12.062a2 2 0 10-2.828-2.828l-4.95 4.95a2 2 0 102.828 2.828l4.95-4.95zm0 0L19 14.5" /></svg>
            </button>
            <button class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-white/10 transition" title="重做">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-2 2m0 0l-2-2m2 2V10a2 2 0 00-2-2H5m11 0a2 2 0 01-2 2H5" /></svg>
            </button>
            <div class="border-t border-white/10 w-8 mt-4 pt-4"></div>
            <button class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-white/10 transition" title="主题">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343h.01M17 7.343h.01M17 11.343h.01M17 15.343h.01" /></svg>
            </button>
            <button class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-white/10 transition" title="导出">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
            </button>
        </aside>

        <div id="mindmap-canvas" class="flex-1 canvas-bg relative overflow-hidden">
            <div class="absolute inset-0 flex items-center justify-center text-gray-600 text-sm md:text-lg px-4">
                <p class="text-center">拖拽此处创建新节点 或 点击左侧工具栏按钮</p>
            </div>
        </div>

        <aside class="w-full md:w-72 lg:w-72 flex-shrink-0 glass p-6 z-40 overflow-auto md:block hidden">
            <h2 class="text-xl font-semibold mb-6">节点属性</h2>
            
            <div class="mb-6">
                <label for="node-text" class="block text-gray-400 text-sm mb-2">节点文本</label>
                <input type="text" id="node-text" value="中心主题" class="w-full px-3 py-2 rounded-md bg-white/5 border border-white/10 focus:outline-none focus:border-blue-500 text-white" />
            </div>

            <div class="mb-6">
                <label for="node-color" class="block text-gray-400 text-sm mb-2">背景颜色</label>
                <div class="flex space-x-2">
                    <button class="w-7 h-7 rounded-full bg-blue-600 border-2 border-transparent focus:border-blue-400 transition"></button>
                    <button class="w-7 h-7 rounded-full bg-green-600 border-2 border-transparent focus:border-green-400 transition"></button>
                    <button class="w-7 h-7 rounded-full bg-purple-600 border-2 border-transparent focus:border-purple-400 transition"></button>
                    <input type="color" class="w-7 h-7 rounded-full bg-transparent border-none p-0 cursor-pointer" value="#ff0000">
                </div>
            </div>

            <div class="mb-6">
                <label for="font-size" class="block text-gray-400 text-sm mb-2">字体大小</label>
                <input type="range" id="font-size" min="12" max="36" value="16" class="w-full accent-blue-500" />
                <span class="text-sm text-gray-400 mt-1 block">当前：16px</span>
            </div>

            <div class="mb-6">
                <label for="node-icon" class="block text-gray-400 text-sm mb-2">图标</label>
                <select id="node-icon" class="w-full px-3 py-2 rounded-md bg-white/5 border border-white/10 focus:outline-none focus:border-blue-500 text-white">
                    <option value="">无</option>
                    <option value="star">⭐ 星星</option>
                    <option value="check">✅ 完成</option>
                    <option value="alert">⚠️ 警告</option>
                </select>
            </div>

            <div class="border-t border-white/10 pt-6 mt-6">
                <button class="w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700 transition">删除节点</button>
            </div>

        </aside>
    </div>

    <script>
        // 脑图编辑器核心功能
        let selectedNode = null;
        let selectedNodeData = null;
        let isDragging = false;
        let offsetX, offsetY;

        // 初始化事件监听
        function init() {
            // 新建节点按钮
            document.querySelector('aside button:first-child').addEventListener('click', createCentralNode);
            // 删除节点按钮
            document.querySelector('aside button:nth-child(2)').addEventListener('click', deleteSelectedNode);
            // 节点文本输入框
            document.getElementById('node-text').addEventListener('input', updateNodeText);
            // 颜色选择按钮
            document.querySelectorAll('.mb-6:nth-child(2) button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (selectedNode) {
                        selectedNode.style.backgroundColor = getComputedStyle(e.target).backgroundColor;
                    }
                });
            });
            // 颜色输入框
            document.querySelector('input[type="color"]').addEventListener('input', (e) => {
                if (selectedNode) {
                    selectedNode.style.backgroundColor = e.target.value;
                }
            });
            // 字体大小滑块
            document.getElementById('font-size').addEventListener('input', (e) => {
                if (selectedNode) {
                    selectedNode.style.fontSize = e.target.value + 'px';
                    document.querySelector('.mb-6:nth-child(3) span').textContent = `当前：${e.target.value}px`;
                }
            });
            // 画布拖拽创建节点
            const canvas = document.getElementById('mindmap-canvas');
            canvas.addEventListener('dblclick', (e) => {
                if (!selectedNode) {
                    createCentralNode();
                } else {
                    createChildNode(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
                }
            });
        }

        // 节点数据结构
        class MindMapNode {
            constructor(id, text, x, y, parentId = null) {
                this.id = id;
                this.text = text;
                this.x = x;
                this.y = y;
                this.parentId = parentId;
                this.children = [];
            }
        }

        let nodes = [];
        let edges = [];
        let nextNodeId = 1;

        // 创建中心节点
        function createCentralNode() {
            const canvas = document.getElementById('mindmap-canvas');
            canvas.innerHTML = '';
            nodes = [];
            edges = [];
            
            const centralNode = new MindMapNode(nextNodeId++, '中心主题', canvas.clientWidth / 2, canvas.clientHeight / 2);
            nodes.push(centralNode);
            
            const nodeElement = createNodeElement(centralNode);
            setupNodeEvents(nodeElement, centralNode);
            canvas.appendChild(nodeElement);
            selectNode(nodeElement, centralNode);
        }

        // 创建子节点
        function createChildNode(x, y) {
            if (!selectedNode || !selectedNodeData) return;
            
            const canvas = document.getElementById('mindmap-canvas');
            const childNode = new MindMapNode(nextNodeId++, '子主题', x, y, selectedNodeData.id);
            nodes.push(childNode);
            selectedNodeData.children.push(childNode);
            
            const nodeElement = createNodeElement(childNode);
            setupNodeEvents(nodeElement, childNode);
            canvas.appendChild(nodeElement);
            
            // 创建连接线
            createEdge(selectedNodeData, childNode);
            
            selectNode(nodeElement, childNode);
        }

        // 创建节点元素
        function createNodeElement(node) {
            const nodeElement = document.createElement('div');
            nodeElement.className = 'absolute px-4 py-2 bg-green-600 rounded-lg shadow-lg cursor-move select-none';
            if (node.parentId === null) {
                nodeElement.className = 'absolute px-6 py-3 bg-blue-600 rounded-lg shadow-lg cursor-move select-none';
            }
            nodeElement.style.left = node.x + 'px';
            nodeElement.style.top = node.y + 'px';
            nodeElement.textContent = node.text;
            nodeElement.dataset.nodeId = node.id;
            return nodeElement;
        }

        // 创建连接线
        function createEdge(parentNode, childNode) {
            const canvas = document.getElementById('mindmap-canvas');
            const edge = document.createElement('div');
            edge.className = 'absolute pointer-events-none';
            edge.style.zIndex = '5';
            
            const parentRect = canvas.querySelector(`[data-node-id="${parentNode.id}"]`).getBoundingClientRect();
            const childRect = canvas.querySelector(`[data-node-id="${childNode.id}"]`).getBoundingClientRect();
            
            const parentCenterX = parentRect.left + parentRect.width / 2 - canvas.getBoundingClientRect().left;
            const parentCenterY = parentRect.top + parentRect.height / 2 - canvas.getBoundingClientRect().top;
            const childCenterX = childRect.left + childRect.width / 2 - canvas.getBoundingClientRect().left;
            const childCenterY = childRect.top + childRect.height / 2 - canvas.getBoundingClientRect().top;
            
            const dx = childCenterX - parentCenterX;
            const dy = childCenterY - parentCenterY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            edge.style.width = length + 'px';
            edge.style.height = '2px';
            edge.style.backgroundColor = '#60a5fa';
            edge.style.left = parentCenterX + 'px';
            edge.style.top = parentCenterY + 'px';
            edge.style.transformOrigin = '0 50%';
            edge.style.transform = `rotate(${angle}deg)`;
            
            canvas.appendChild(edge);
            edges.push({ parentId: parentNode.id, childId: childNode.id, element: edge });
        }

        // 设置节点事件
        function setupNodeEvents(nodeElement, nodeData) {
            // 点击选中
            nodeElement.addEventListener('click', (e) => {
                e.stopPropagation();
                selectNode(nodeElement, nodeData);
            });
            
            // 拖拽开始
            nodeElement.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - nodeElement.getBoundingClientRect().left;
                offsetY = e.clientY - nodeElement.getBoundingClientRect().top;
                nodeElement.style.zIndex = '100';
            });
            
            // 拖拽移动
            nodeElement.addEventListener('mousemove', (e) => {
                if (!isDragging || !nodeElement) return;
                const canvas = document.getElementById('mindmap-canvas');
                const rect = canvas.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left - offsetX, canvas.clientWidth - nodeElement.offsetWidth));
                const y = Math.max(0, Math.min(e.clientY - rect.top - offsetY, canvas.clientHeight - nodeElement.offsetHeight));
                
                nodeElement.style.left = x + 'px';
                nodeElement.style.top = y + 'px';
                
                // 更新节点数据
                const node = nodes.find(n => n.id === parseInt(nodeElement.dataset.nodeId));
                if (node) {
                    node.x = x;
                    node.y = y;
                    // 更新连接线
                    updateEdges();
                }
                e.stopPropagation();
            });
            
            // 拖拽结束
            document.addEventListener('mouseup', () => {
                isDragging = false;
                if (nodeElement) nodeElement.style.zIndex = '10';
            });
        }

        // 更新所有连接线
        function updateEdges() {
            const canvas = document.getElementById('mindmap-canvas');
            edges.forEach(edge => {
                const parentNode = nodes.find(n => n.id === edge.parentId);
                const childNode = nodes.find(n => n.id === edge.childId);
                if (parentNode && childNode) {
                    const parentElement = canvas.querySelector(`[data-node-id="${parentNode.id}"]`);
                    const childElement = canvas.querySelector(`[data-node-id="${childNode.id}"]`);
                    if (parentElement && childElement) {
                        const parentRect = parentElement.getBoundingClientRect();
                        const childRect = childElement.getBoundingClientRect();
                        const canvasRect = canvas.getBoundingClientRect();
                        
                        const parentCenterX = parentRect.left + parentRect.width / 2 - canvasRect.left;
                        const parentCenterY = parentRect.top + parentRect.height / 2 - canvasRect.top;
                        const childCenterX = childRect.left + childRect.width / 2 - canvasRect.left;
                        const childCenterY = childRect.top + childRect.height / 2 - canvasRect.top;
                        
                        const dx = childCenterX - parentCenterX;
                        const dy = childCenterY - parentCenterY;
                        const length = Math.sqrt(dx * dx + dy * dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        
                        edge.element.style.width = length + 'px';
                        edge.element.style.left = parentCenterX + 'px';
                        edge.element.style.top = parentCenterY + 'px';
                        edge.element.style.transform = `rotate(${angle}deg)`;
                    }
                }
            });
        }

        // 选中节点
        function selectNode(nodeElement, nodeData) {
            if (selectedNode) {
                selectedNode.style.border = 'none';
            }
            selectedNode = nodeElement;
            selectedNodeData = nodeData;
            nodeElement.style.border = '2px solid #60a5fa';
            // 更新属性面板
            document.getElementById('node-text').value = nodeData.text;
            document.getElementById('font-size').value = parseInt(getComputedStyle(nodeElement).fontSize);
            document.querySelector('.mb-6:nth-child(3) span').textContent = `当前：${parseInt(getComputedStyle(nodeElement).fontSize)}px`;
        }

        // 更新节点文本
        function updateNodeText(e) {
            if (selectedNode && selectedNodeData) {
                selectedNode.textContent = e.target.value;
                selectedNodeData.text = e.target.value;
            }
        }

        // 删除选中节点
        function deleteSelectedNode() {
            if (selectedNode && selectedNodeData) {
                // 删除节点及其所有子节点
                deleteNodeRecursive(selectedNodeData.id);
                // 更新画布
                redrawMindMap();
                selectedNode = null;
                selectedNodeData = null;
            }
        }

        // 递归删除节点
        function deleteNodeRecursive(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (node) {
                // 删除子节点
                node.children.forEach(child => deleteNodeRecursive(child.id));
                // 删除节点
                nodes = nodes.filter(n => n.id !== nodeId);
                // 删除相关连接线
                edges = edges.filter(e => e.parentId !== nodeId && e.childId !== nodeId);
                // 更新父节点的子节点列表
                const parentNode = nodes.find(n => n.id === node.parentId);
                if (parentNode) {
                    parentNode.children = parentNode.children.filter(c => c.id !== nodeId);
                }
            }
        }

        // 重绘整个脑图
        function redrawMindMap() {
            const canvas = document.getElementById('mindmap-canvas');
            canvas.innerHTML = '';
            
            // 绘制所有节点
            nodes.forEach(node => {
                const nodeElement = createNodeElement(node);
                setupNodeEvents(nodeElement, node);
                canvas.appendChild(nodeElement);
            });
            
            // 绘制所有连接线
            edges.forEach(edge => {
                const parentNode = nodes.find(n => n.id === edge.parentId);
                const childNode = nodes.find(n => n.id === edge.childId);
                if (parentNode && childNode) {
                    createEdge(parentNode, childNode);
                }
            });
        }

        // 修复窗口大小变化时的节点位置
        window.addEventListener('resize', () => {
            if (nodes.length === 0) return;
            const canvas = document.getElementById('mindmap-canvas');
            // 仅调整中心节点位置
            const centralNode = nodes.find(n => n.parentId === null);
            if (centralNode) {
                const nodeElement = canvas.querySelector(`[data-node-id="${centralNode.id}"]`);
                if (nodeElement) {
                    centralNode.x = canvas.clientWidth / 2;
                    centralNode.y = canvas.clientHeight / 2;
                    nodeElement.style.left = centralNode.x + 'px';
                    nodeElement.style.top = centralNode.y + 'px';
                    updateEdges();
                }
            }
        });

        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>