<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Qwen2.5 æé€Ÿé‡åŒ–ç‰ˆ - æç¤ºè¯ä¼˜åŒ–</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; width: 100%; max-width: 650px; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { margin-top: 0; color: #1a1a1a; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .info { font-size: 13px; color: #666; background: #eef2ff; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; margin-top: 10px; }
        button { width: 100%; background: #4f46e5; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.3s; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }
        #output { margin-top: 25px; padding: 15px; background: #f9fafb; border: 1px dashed #4f46e5; border-radius: 8px; white-space: pre-wrap; min-height: 80px; font-size: 14px; line-height: 1.6; color: #374151; }
        .progress-box { height: 6px; background: #eee; border-radius: 3px; margin: 15px 0; display: none; overflow: hidden; }
        #bar { height: 100%; background: #4f46e5; width: 0%; transition: width 0.2s; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸª„ æç¤ºè¯ä¸“å®¶ <small style="font-size: 12px; font-weight: normal;">(Qwen2.5-0.5B-Q4)</small></h2>
    
    <div id="status" class="info">æ­£åœ¨å‡†å¤‡ç¯å¢ƒä¸­...</div>
    <div class="progress-box" id="progressWrapper"><div id="bar"></div></div>

    <textarea id="userInput" placeholder="è¾“å…¥ç®€å•çš„æƒ³æ³•ï¼Œå¦‚ï¼šå¸®æˆ‘å†™ä¸€æ®µå…³äºæ˜Ÿç©ºçš„æ–‡æ¡ˆ"></textarea>
    <button id="runBtn" disabled>ç­‰å¾…ä¸‹è½½å®Œæˆ...</button>

    <div id="output">ä¼˜åŒ–åçš„ Prompt ä¼šå‡ºç°åœ¨è¿™é‡Œ...</div>
</div>

<script type="module">
    // ä½¿ç”¨ Transformers.js v3
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0-alpha.19';

    // ç¦ç”¨æœ¬åœ°æ¨¡å‹æ£€æŸ¥ï¼Œå¼ºåˆ¶èµ° CDN ä¸‹è½½å¹¶ç¼“å­˜
    env.allowLocalModels = false;

    const status = document.getElementById('status');
    const btn = document.getElementById('runBtn');
    const output = document.getElementById('output');
    const bar = document.getElementById('bar');
    const progressWrapper = document.getElementById('progressWrapper');

    let generator;

    async function init() {
        try {
            // æ ¸å¿ƒä¿®å¤ï¼šæŒ‡å®š dtype: 'q4' å¼ºåˆ¶åŠ è½½é‡åŒ–ç‰ˆï¼ˆçº¦300MB+ï¼‰
            generator = await pipeline('text-generation', 'onnx-community/Qwen2.5-0.5B-Instruct', {
                dtype: 'q4', 
                device: 'webgpu', // å¦‚æœæ”¯æŒ WebGPU ä¼šæå…¶é¡ºæ»‘
                progress_callback: (p) => {
                    progressWrapper.style.display = 'block';
                    if (p.status === 'progress') {
                        status.innerText = `ä¸‹è½½é‡åŒ–æ¨¡å‹ä¸­: ${Math.round(p.loaded/1024/1024)}MB / çº¦350MB`;
                        bar.style.width = `${p.progress}%`;
                    }
                    if (p.status === 'done') {
                        status.innerText = 'âœ… åŠ è½½å®Œæˆï¼å·²å­˜å‚¨åœ¨æµè§ˆå™¨ç¼“å­˜ä¸­ã€‚';
                        progressWrapper.style.display = 'none';
                        btn.disabled = false;
                        btn.innerText = 'å¼€å§‹ä¼˜åŒ–æç¤ºè¯';
                    }
                }
            });
        } catch (e) {
            status.innerText = 'âš ï¸ åˆå§‹åŒ–å¤±è´¥ï¼š' + e.message;
            console.error(e);
        }
    }

    btn.onclick = async () => {
        const text = document.getElementById('userInput').value.trim();
        if (!text) return;

        btn.disabled = true;
        btn.innerText = 'æ­£åœ¨ç”Ÿæˆ...';
        output.innerText = 'æ­£åœ¨æœ¬åœ°è®¡ç®—ä¸­ï¼Œè¯·ç¨å...';

        const messages = [
            { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æç¤ºè¯ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ç”¨æˆ·ç®€å•çš„æŒ‡ä»¤æ‰©å……æˆé«˜è´¨é‡çš„æç¤ºè¯ã€‚ç›´æ¥ç»™å‡ºä¼˜åŒ–åçš„ Promptï¼Œä¸éœ€è¦è§£é‡Šã€‚" },
            { role: "user", content: `ä¼˜åŒ–è¿™ä¸ªæç¤ºè¯: ${text}` }
        ];

        try {
            const result = await generator(messages, { 
                max_new_tokens: 512,
                temperature: 0.6,
                do_sample: true 
            });

            // è·å–ç”Ÿæˆçš„æœ€æ–°å†…å®¹
            const response = result[0].generated_text.at(-1).content;
            output.innerText = response;
        } catch (err) {
            output.innerText = 'å‡ºé”™å•¦ï¼š' + err.message;
        } finally {
            btn.disabled = false;
            btn.innerText = 'å†æ¬¡ä¼˜åŒ–';
        }
    };

    init();
</script>
</body>
</html>