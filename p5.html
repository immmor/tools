<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>immmor PS TITAN AI | 极客 AI 图像实验室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        body { background: #020203; color: #e2e8f0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .ps-layout { display: grid; grid-template-columns: 60px 280px 1fr 300px; grid-template-rows: 50px 1fr; height: 100vh; }
        .glass-panel { background: rgba(10, 10, 15, 0.98); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .tool-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 12px; transition: 0.2s; color: #475569; margin-bottom: 6px; position: relative; }
        .tool-btn:hover, .tool-btn.active { background: #3b82f6; color: white; }
        .canvas-area { background-color: #080808; background-image: conic-gradient(#111 90deg, #080808 90deg 180deg, #111 180deg 270deg, #080808 270deg); background-size: 40px 40px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        .layer-item.active { border: 1px solid #3b82f6; background: rgba(59, 130, 246, 0.15); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .ai-badge { background: linear-gradient(90deg, #3b82f6, #8b5cf6); padding: 2px 8px; border-radius: 4px; font-size: 9px; color: white; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-blue-500 mb-4"></div>
    <p class="text-blue-400 text-sm font-mono tracking-widest">AI MODEL PROCESSING...</p>
</div>

<div class="ps-layout">
    <header class="col-span-4 glass-panel flex items-center px-6 justify-between border-b border-white/5">
        <div class="flex items-center space-x-8">
            <span class="font-black italic text-blue-500 text-2xl tracking-tighter">im.PS AI</span>
            <div class="flex space-x-6 text-[10px] uppercase font-bold tracking-widest text-gray-500">
                <button onclick="document.getElementById('fileInput').click()">Open Image</button>
                <button onclick="undo()">Undo</button>
                <button onclick="downloadImage()" class="text-blue-500">Export WebP</button>
            </div>
        </div>
        <div class="ai-badge">MEDIA-PIPE VISION ENABLED</div>
    </header>

    <aside class="glass-panel flex flex-col items-center py-6 border-r border-white/5">
        <button class="tool-btn active" onclick="setMode('select')"><i data-lucide="mouse-pointer-2"></i></button>
        <button class="tool-btn" onclick="addText()"><i data-lucide="type"></i></button>
        <button class="tool-btn" onclick="addRect()"><i data-lucide="square"></i></button>
        <button class="tool-btn" onclick="toggleDrawing()"><i data-lucide="paintbrush"></i></button>
        <button class="tool-btn text-purple-400" onclick="removeBackgroundAI()" title="AI 抠图"><i data-lucide="sparkles"></i></button>
        <div class="w-8 h-[1px] bg-gray-800 my-4"></div>
        <button class="tool-btn" onclick="pickColor()"><i data-lucide="pipette"></i></button>
        <button class="tool-btn text-red-500" onclick="deleteSelected()"><i data-lucide="trash-2"></i></button>
    </aside>

    <aside class="glass-panel p-6 border-r border-white/5 space-y-8 overflow-y-auto text-xs">
        <section>
            <p class="text-gray-500 font-bold mb-4 uppercase tracking-tighter">Layer Appearance</p>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span>Opacity</span>
                    <input type="range" id="opacity" min="0" max="1" step="0.01" value="1" oninput="updateStyle()" class="ml-4">
                </div>
                <div class="flex justify-between items-center">
                    <span>Fill Color</span>
                    <input type="color" id="fill-color" oninput="updateStyle()" class="bg-transparent w-8 h-8">
                </div>
            </div>
        </section>

        <section>
            <p class="text-gray-500 font-bold mb-4 uppercase tracking-tighter">AI Actions</p>
            <button onclick="removeBackgroundAI()" class="w-full py-3 bg-purple-600/20 text-purple-400 rounded-xl hover:bg-purple-600/40 transition flex items-center justify-center gap-2">
                <i data-lucide="user-minus" class="w-4"></i> AI 提取人像
            </button>
        </section>
    </aside>

    <main class="canvas-area" id="canvas-wrapper">
        <canvas id="titan-canvas"></canvas>
        <input type="file" id="fileInput" class="hidden">
    </main>

    <aside class="glass-panel border-l border-white/5 p-4">
        <p class="text-gray-500 font-bold mb-4 uppercase tracking-tighter text-[10px]">Layers Stack</p>
        <div id="layer-stack" class="space-y-2"></div>
    </aside>
</div>

<script>
    // 1. 初始化
    const canvas = new fabric.Canvas('titan-canvas', {
        width: 900, height: 650,
        preserveObjectStacking: true
    });
    lucide.createIcons();

    let history = [];
    
    // 2. AI 抠图引擎核心 (MediaPipe)
    const selfieSegmentation = new SelfieSegmentation({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
    });

    selfieSegmentation.setOptions({ modelSelection: 1 }); // 1 为普通模式，0 为通用快显
    selfieSegmentation.onResults(onAIResults);

    let currentAIImage = null;

    async function removeBackgroundAI() {
        const activeObj = canvas.getActiveObject();
        if (!activeObj || activeObj.type !== 'image') {
            alert("请先选中一张人像图片");
            return;
        }
        
        document.getElementById('loader').style.display = 'flex';
        currentAIImage = activeObj;
        
        // 发送图像给 AI 模型
        await selfieSegmentation.send({ image: activeObj._element });
    }

    function onAIResults(results) {
        const tempCanvas = document.createElement('canvas');
        const tCtx = tempCanvas.getContext('2d');
        tempCanvas.width = results.image.width;
        tempCanvas.height = results.image.height;

        // 绘制掩码
        tCtx.drawImage(results.segmentationMask, 0, 0, tempCanvas.width, tempCanvas.height);
        
        // 使用 Source-In 模式提取人像
        tCtx.globalCompositeOperation = 'source-in';
        tCtx.drawImage(results.image, 0, 0, tempCanvas.width, tempCanvas.height);

        // 生成新图片并替换原图
        fabric.Image.fromURL(tempCanvas.toDataURL(), (newImg) => {
            newImg.set({
                left: currentAIImage.left,
                top: currentAIImage.top,
                scaleX: currentAIImage.scaleX,
                scaleY: currentAIImage.scaleY
            });
            canvas.remove(currentAIImage);
            canvas.add(newImg);
            canvas.setActiveObject(newImg);
            document.getElementById('loader').style.display = 'none';
            renderLayers();
        });
    }

    // 3. 基础功能
    function addText() { 
        const text = new fabric.IText('Double Click To Edit', { left: 100, top: 100, fill: '#fff', fontSize: 30 });
        addObject(text);
    }
    
    function addObject(obj) {
        canvas.add(obj);
        canvas.setActiveObject(obj);
        renderLayers();
    }

    function renderLayers() {
        const stack = document.getElementById('layer-stack');
        stack.innerHTML = '';
        canvas.getObjects().reverse().forEach((obj, i) => {
            const div = document.createElement('div');
            div.className = `layer-item flex items-center p-3 rounded-lg text-[10px] cursor-pointer ${canvas.getActiveObject() === obj ? 'active' : ''}`;
            div.innerHTML = `图层: ${obj.type.toUpperCase()}`;
            div.onclick = () => { canvas.setActiveObject(obj); canvas.renderAll(); renderLayers(); };
            stack.appendChild(div);
        });
    }

    // 4. 吸管工具
    async function pickColor() {
        if (!window.EyeDropper) {
            alert("您的浏览器不支持吸管工具");
            return;
        }
        const eyeDropper = new EyeDropper();
        const result = await eyeDropper.open();
        document.getElementById('fill-color').value = result.sRGBHex;
        updateStyle();
    }

    function updateStyle() {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        obj.set({
            fill: document.getElementById('fill-color').value,
            opacity: parseFloat(document.getElementById('opacity').value)
        });
        canvas.renderAll();
    }

    // 初始化文件导入
    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => fabric.Image.fromURL(f.target.result, img => {
            img.scaleToWidth(500);
            addObject(img);
        });
        reader.readAsDataURL(e.target.files[0]);
    };

    function deleteSelected() {
        canvas.remove(...canvas.getActiveObjects());
        canvas.discardActiveObject().renderAll();
        renderLayers();
    }

    function downloadImage() {
        const dataURL = canvas.toDataURL({ format: 'webp', quality: 0.9 });
        const link = document.createElement('a');
        link.download = 'immmor_ai_design.webp';
        link.href = dataURL;
        link.click();
    }

    canvas.on('selection:created', renderLayers);
    canvas.on('selection:updated', renderLayers);
</script>
</body>
</html>