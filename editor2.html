<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>immmor code - Multi-AI Edition</title>
    <link rel="icon" type="image/png" href="iwe.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        :root {
            --amber: #ffb000;
            --amber-dim: #714e00;
            --bg: #12100b;
            --panel-bg: #1c1912;
            --border-w: 2px;
            --term-red: #ff3e3e;
            --term-green: #00ff41;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; cursor: default; }
        
        body, html {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: var(--bg); color: var(--amber);
            font-family: 'Courier New', Courier, monospace; overflow: hidden;
            background-image: linear-gradient(rgba(18, 16, 11, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 255, 0, 0.06));
            background-size: 100% 4px, 3px 100%;
        }

        .header {
            height: 40px; border-bottom: var(--border-w) solid var(--amber);
            display: flex; align-items: center; padding: 0 15px;
            font-size: 14px; font-weight: bold; background: var(--panel-bg);
            text-shadow: 0 0 5px var(--amber); gap: 20px;
        }

        .menu-btn { cursor: pointer !important; padding: 5px 10px; border: 1px solid transparent; }
        .menu-btn:hover { border-color: var(--amber); background: rgba(255, 176, 0, 0.1); }

        .workspace { display: flex; flex-direction: row; height: calc(100vh - 40px); width: 100%; position: relative; }

        .panel { 
            background: var(--panel-bg); display: flex; flex-direction: column; 
            overflow: hidden; position: relative; height: 100%;
        }

        .panel.maximized {
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            z-index: 999999 !important; background: var(--bg) !important;
            display: flex !important; flex-direction: column !important;
            margin: 0 !important; padding: 0 !important;
        }

        .divider-h { width: 6px; background: var(--amber-dim); cursor: col-resize !important; flex-shrink: 0; }
        .divider-h:hover, .divider-h.active { background: var(--amber); box-shadow: 0 0 10px var(--amber); }

        .divider-v { height: 6px; background: var(--amber-dim); cursor: row-resize !important; flex-shrink: 0; }
        .divider-v:hover, .divider-v.active { background: var(--amber); box-shadow: 0 0 10px var(--amber); }

        .p-head {
            height: 30px; border-bottom: 1px solid var(--amber-dim);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; font-size: 11px; background: rgba(113, 78, 0, 0.1);
        }
        .ctrl-group { display: flex; gap: 5px; }
        .ctrl { cursor: pointer !important; padding: 2px 6px; border: 1px solid var(--amber-dim); }
        .ctrl:hover { background: var(--amber); color: var(--bg); }

        #explorer { width: 200px; border-right: 1px solid var(--amber-dim); }
        #file-list, #plugin-list { overflow-y: auto; flex: 1; }
        
        .file-item, .plugin-item { 
            padding: 8px 15px; font-size: 13px; cursor: pointer !important; 
            border-bottom: 1px solid rgba(113, 78, 0, 0.05); 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center; color: var(--amber); opacity: 0.7;
        }
        .file-item:hover { background: rgba(255, 176, 0, 0.05); opacity: 0.9; }
        .file-item.active { background: var(--amber); color: var(--bg) !important; font-weight: bold; opacity: 1; }
        .file-item.folder { color: var(--amber); font-weight: bold; opacity: 1; border-left: 2px solid var(--amber-dim); }

        #main-stack { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        #editor {
            flex: 1; background: transparent; border: none; outline: none;
            padding: 20px; color: var(--amber); font-size: 16px;
            line-height: 1.5; resize: none; font-family: inherit; cursor: text !important;
        }

        #terminal { height: 220px; }
        .term-tabs { display: flex; background: #000; border-bottom: 1px solid var(--amber-dim); overflow-x: auto; scrollbar-width: none; }
        .term-tab { 
            padding: 5px 12px; font-size: 10px; border-right: 1px solid var(--amber-dim); 
            cursor: pointer !important; opacity: 0.6; display: flex; align-items: center; gap: 8px; 
            white-space: nowrap;
        }
        .term-tab.active { background: var(--amber-dim); color: #fff; opacity: 1; }
        .term-close { font-size: 12px; font-weight: bold; cursor: pointer !important; color: var(--term-red); }
        
        .term-body { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .term-body.active { display: flex; }
        .term-out { flex: 1; padding: 10px; overflow-y: auto; font-size: 12px; color: rgba(255, 176, 0, 0.8); white-space: pre-wrap; word-break: break-all; }
        .term-input-wrap { display: flex; padding: 8px 10px; background: #000; border-top: 1px solid var(--amber-dim); gap: 10px; align-items: center; }
        .cmd-in { background: transparent; border: none; outline: none; flex: 1; color: #fff; font-family: inherit; cursor: text !important; }

        #ai-panel { width: 300px; border-left: 1px solid var(--amber-dim); }
        .msg { margin-bottom: 15px; line-height: 1.4; border-left: 2px solid var(--amber-dim); padding-left: 10px; word-wrap: break-word; font-size: 12px; }
        .msg.ai { border-left-color: var(--amber); }
        .msg.user { color: #fff; opacity: 0.8; }
        
        .ai-tools { padding: 8px 10px; background: rgba(113, 78, 0, 0.1); border-top: 1px solid var(--amber-dim); font-size: 10px; }
        .custom-select-trigger { 
            background: #000; color: var(--amber); border: 1px solid var(--amber-dim); 
            font-size: 10px; width: 100%; padding: 6px; cursor: pointer !important;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;
        }
        .custom-select-options {
            position: absolute; bottom: 150px; left: 10px; right: 10px; background: var(--panel-bg);
            border: 1px solid var(--amber); display: none; z-index: 600; max-height: 200px; overflow-y: auto;
        }
        .custom-select-options div { padding: 8px; border-bottom: 1px solid var(--amber-dim); cursor: pointer !important; }
        .custom-select-options div:hover { background: var(--amber); color: #000; }

        .ai-input-area { padding: 10px; background: rgba(0,0,0,0.3); border-top: 1px solid var(--amber-dim); display: flex; gap: 5px; }
        #ai-in { background: transparent; border: 1px solid var(--amber-dim); color: #fff; flex: 1; padding: 5px; outline: none; font-size: 12px; }
        .ai-btn { background: var(--amber-dim); color: #fff; border: none; padding: 5px 10px; cursor: pointer !important; font-size: 10px; }
        .ai-btn:hover { background: var(--amber); color: var(--bg); }

        #ctx, #plugin-ctx, .custom-modal {
            position: fixed; display: none; background: var(--panel-bg);
            border: 2px solid var(--amber); z-index: 1000; min-width: 200px;
            box-shadow: 8px 8px 0px #000;
        }
        .opt { padding: 12px 15px; font-size: 12px; font-weight: bold; cursor: pointer !important; }
        .opt:hover { background: var(--amber); color: var(--bg); }
        .opt.disabled { opacity: 0.5; pointer-events: none; }

        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 2000; display: none;
            align-items: center; justify-content: center;
        }
        .custom-modal { display: block; position: relative; width: 350px; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-input { width: 100%; background: #000; border: 1px solid var(--amber); color: #fff; padding: 8px; outline: none; font-family: inherit; margin-bottom: 10px; font-size: 12px; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        
        .provider-card { border: 1px solid var(--amber-dim); padding: 10px; margin-bottom: 15px; position: relative; }
        .provider-card label { display: block; font-size: 9px; margin-bottom: 3px; color: var(--amber-dim); }
        
        .editor-tools {
            display: flex; gap: 2px; padding: 5px; background: rgba(28, 25, 18, 0.8);
            border-bottom: 1px solid var(--amber-dim); overflow-x: auto; scrollbar-width: none;
        }
        .key-btn { padding: 4px 10px; background: var(--bg); border: 1px solid var(--amber-dim); color: var(--amber); font-size: 10px; cursor: pointer !important; }
        .key-btn:active { background: var(--amber); color: var(--bg); }

        .inject-btn { display: inline-block; margin-top: 8px; font-size: 9px; padding: 2px 6px; border: 1px solid var(--amber); cursor: pointer !important; color: var(--amber); }
    </style>
</head>
<body>

<div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div style="display: flex; gap: 0px;">
            <div class="menu-btn" onclick="handleCtx(event, 10, 40)">FILE</div>
            <div class="menu-btn" onclick="saveZip()">ARCHIVE</div>
            <div class="menu-btn" onclick="clearTerm()">RESET</div>
        </div>
        <div style="text-shadow: 0 0 10px var(--amber); padding-right:10px;">IMMMOR_CORE</div>
    </div>
</div>

<div class="workspace">
    <aside class="panel" id="explorer">
        <div id="file-section" style="height: 60%; display:flex; flex-direction:column;">  
            <div class="p-head">
                <span>FILESYSTEM</span>
                <div class="ctrl-group">
                    <span class="ctrl" onclick="openModal()">+</span>
                    <span class="ctrl" onclick="toggleMax('file-section')">◰</span>
                </div>
            </div>
            <div id="file-list"></div>
        </div>
        <div class="divider-v" id="v-drag-explorer"></div>
        <div id="plugin-section" style="flex: 1; display:flex; flex-direction:column;">
            <div class="p-head"><span>PLUGINS</span><span class="ctrl" onclick="openPluginModal()">+</span></div>
            <div id="plugin-list"></div>
        </div>
    </aside>

    <div class="divider-h" id="h-drag-left"></div>

    <div id="main-stack">
        <main class="panel" id="editor-p" style="flex:1">
            <div class="p-head">
                <span id="cur-filename">DATA_NODE.01</span>
                <div class="ctrl-group">
                    <span class="ctrl" onclick="runCurrentFile()" style="color:var(--amber)">▶</span>
                    <span class="ctrl" onclick="toggleMax('editor-p')">◰</span>
                </div>
            </div>
            <div class="editor-tools">
                <div class="key-btn" onclick="insertAtCursor('\t')">TAB</div>
                <div class="key-btn" onclick="editorAction('selectAll')">ALL</div>
                <div class="key-btn" onclick="editorAction('copy')">COPY</div>
                <div class="key-btn" onclick="editorAction('paste')">PASTE</div>
            </div>
            <textarea id="editor" spellcheck="false" oninput="autoSave()"></textarea>
        </main>
        
        <div class="divider-v" id="v-drag"></div>

        <footer class="panel" id="terminal">
            <div class="p-head"><span>COMMAND</span><span class="ctrl" onclick="addTerminal()">+</span></div>
            <div class="term-tabs" id="term-tabs"></div>
            <div id="term-container" style="flex:1; display:flex; flex-direction:column; overflow:hidden;"></div>
        </footer>
    </div>

    <div class="divider-h" id="h-drag-right"></div>

    <aside class="panel" id="ai-panel">
        <div class="p-head">
            <span>AI_MODELS</span>
            <div class="ctrl-group">
                <span class="ctrl" onclick="addAiTab()">+</span>
                <span class="ctrl" onclick="openSettings()">⚙</span>
            </div>
        </div>
        <div class="term-tabs" id="ai-tabs"></div>
        <div id="ai-container" style="flex:1; display:flex; flex-direction:column; overflow:hidden;"></div>

        <div class="ai-tools">
            <label>ACTIVE_PROVIDER:</label>
            <select id="ai-provider-selector" onchange="switchProvider(this.value)" style="background:#000; color:var(--amber); border:1px solid var(--amber-dim); font-size:10px; width:100%; padding:5px; margin-bottom:8px;">
            </select>
            
            <label>CONTEXT_NODE:</label>
            <div class="custom-select-trigger" id="ai-ctx-trigger" onclick="toggleAiSelect()">
                <span id="ai-ctx-val">-- NO_CONTEXT --</span>
                <span>▼</span>
            </div>
            <div class="custom-select-options" id="ai-ctx-options"></div>
        </div>
        <div class="ai-input-area">
            <input type="text" id="ai-in" placeholder="Ask AI..." autocomplete="off">
            <button class="ai-btn" onclick="sendAi()">SEND</button>
        </div>
    </aside>
</div>

<div id="ctx">
    <div class="opt" onclick="openModal()">[+] NEW_NODE</div>
    <div class="opt" id="ctx-rename" onclick="startRenameFromCtx()">[R] RENAME</div>
    <div class="opt" id="ctx-delete" onclick="deleteNodeFromCtx()" style="color:var(--term-red)">[X] PURGE</div>
    <div class="opt" onclick="saveZip()">ARCHIVE_ALL</div>
</div>

<div id="plugin-ctx">
    <div class="opt" onclick="startEditPlugin()">EDIT</div>
    <div class="opt" onclick="confirmDeletePlugin()" style="color:var(--term-red)">UNINSTALL</div>
</div>

<div id="modal-overlay" class="modal-overlay">
    <div class="custom-modal">
        <div class="p-head"><span id="modal-title">SYSTEM_PROMPT</span></div>
        <div class="modal-body" id="modal-content"></div>
    </div>
</div>

<script>
    // --- Data Storage ---
    let storage = JSON.parse(localStorage.getItem('ind_console_storage')) || {
        'PROTOCOL.txt': 'SYSTEM OVERRIDE: ACTIVE\nENCRYPTION: ENABLED',
        'main.py': 'print("Python WASM initialized")'
    };
    let plugins = JSON.parse(localStorage.getItem('ind_console_plugins')) || [];
    
    let config = JSON.parse(localStorage.getItem('ind_console_config')) || {
        activeProviderIndex: 0,
        providers: [
            {
                name: 'Default',
                apiKey: '',
                apiBaseUrl: 'https://mrok.dpdns.org/v1',
                model: 'gemini-flash-latest'
            }
        ]
    };

    let activeFile = localStorage.getItem('ind_console_active') || 'PROTOCOL.txt';
    let expandedDirs = JSON.parse(localStorage.getItem('ind_console_expanded')) || [];
    let termCount = 0, activeTermId = null;
    let aiCount = 0, activeAiId = null;
    let selectedAiCtx = 'none';
    let pyodideInstance = null;
    let ctxTarget = null, pluginCtxTarget = null;

    // --- AI Settings & Provider Management ---
    function openSettings() {
        const providers = config.providers;
        let providersHtml = Object.keys(providers).map(id => `
            <div class="provider-card" data-id="${id}">
                <label>NAME</label>
                <input type="text" class="modal-input cfg-name" value="${providers[id].name}">
                <label>API BASE URL</label>
                <input type="text" class="modal-input cfg-base" value="${providers[id].apiBaseUrl}">
                <label>MODEL ID</label>
                <input type="text" class="modal-input cfg-model" value="${providers[id].model}">
                <label>API KEY</label>
                <input type="password" class="modal-input cfg-key" value="${providers[id].apiKey}">
                <div style="display:flex; justify-content: space-between; align-items:center;">
                    <label style="color:var(--amber); cursor:pointer">
                        <input type="radio" name="active-p" value="${id}" ${config.activeProvider === id ? 'checked' : ''}> USE_ACTIVE
                    </label>
                    <button class="ai-btn" style="background:var(--term-red)" onclick="deleteProvider('${id}')">DELETE</button>
                </div>
            </div>
        `).join('');

        document.getElementById('modal-title').innerText = "AI_CORE_CONFIG";
        document.getElementById('modal-content').innerHTML = `
            <div id="provider-list">${providersHtml}</div>
            <button class="ai-btn" style="width:100%; margin-top:10px; border:1px dashed var(--amber)" onclick="addNewProvider()">+ ADD_NEW_PROVIDER</button>
            <div class="modal-btns">
                <button class="ai-btn" onclick="closeModal()">CANCEL</button>
                <button class="ai-btn" style="background:var(--amber); color:#000" onclick="saveSettings()">SAVE_SYSTEM_STATE</button>
            </div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function addNewProvider() {
        const id = 'p_' + Date.now();
        config.providers[id] = { name: 'New API', apiKey: '', apiBaseUrl: '', model: '' };
        openSettings();
    }

    function deleteProvider(id) {
        if (Object.keys(config.providers).length <= 1) return;
        delete config.providers[id];
        if (config.activeProvider === id) config.activeProvider = Object.keys(config.providers)[0];
        openSettings();
    }

    function saveSettings() {
        const newProviders = {};
        document.querySelectorAll('.provider-card').forEach(card => {
            const id = card.dataset.id;
            newProviders[id] = {
                name: card.querySelector('.cfg-name').value,
                apiBaseUrl: card.querySelector('.cfg-base').value,
                model: card.querySelector('.cfg-model').value,
                apiKey: card.querySelector('.cfg-key').value
            };
        });
        config.providers = newProviders;
        config.activeProvider = document.querySelector('input[name="active-p"]:checked').value;
        localStorage.setItem('ind_console_config', JSON.stringify(config));
        updateProviderSelector();
        closeModal();
    }

    function updateProviderSelector() {
        const sel = document.getElementById('ai-provider-selector');
        sel.innerHTML = Object.keys(config.providers).map(id => 
            `<option value="${id}" ${config.activeProvider === id ? 'selected' : ''}>${config.providers[id].name}</option>`
        ).join('');
    }

    function switchProvider(id) {
        config.activeProvider = id;
        localStorage.setItem('ind_console_config', JSON.stringify(config));
    }

    // --- AI Chat Logic ---
    function addAiTab() {
        const id = 'ai-' + (++aiCount);
        const tab = document.createElement('div');
        tab.className = 'term-tab'; tab.id = 'tab-' + id;
        tab.innerHTML = `<span>CHAT_${aiCount}</span><span class="term-close" onclick="removeAiTab(event, '${id}')">×</span>`;
        tab.onclick = () => switchAiTab(id);
        document.getElementById('ai-tabs').appendChild(tab);

        const body = document.createElement('div');
        body.className = 'term-body'; body.id = id;
        body.style.padding = '15px'; body.style.overflowY = 'auto'; body.style.flex = '1';
        body.innerHTML = `<div class="msg ai">SYSTEM: Chat node ${aiCount} online.</div>`;
        document.getElementById('ai-container').appendChild(body);
        switchAiTab(id);
    }

    function switchAiTab(id) {
        document.querySelectorAll('#ai-tabs .term-tab, #ai-container .term-body').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.getElementById(id).classList.add('active');
        activeAiId = id;
    }

    function removeAiTab(e, id) {
        e.stopPropagation();
        if (document.querySelectorAll('#ai-tabs .term-tab').length <= 1) return;
        document.getElementById('tab-' + id).remove();
        document.getElementById(id).remove();
        const first = document.querySelector('#ai-tabs .term-tab');
        if (first) switchAiTab(first.id.replace('tab-', ''));
    }

    async function sendAi() {
        const input = document.getElementById('ai-in');
        const query = input.value.trim();
        const prov = config.providers[config.activeProvider];

        if (!query || !prov.apiKey || !activeAiId) return;

        const chat = document.getElementById(activeAiId);
        const uMsg = document.createElement('div');
        uMsg.className = 'msg user'; uMsg.innerText = `[${selectedAiCtx}] > ${query}`;
        chat.appendChild(uMsg); input.value = '';

        const aiMsg = document.createElement('div');
        aiMsg.className = 'msg ai'; aiMsg.innerText = 'AI: connecting...';
        chat.appendChild(aiMsg);
        chat.scrollTop = chat.scrollHeight;

        try {
            const response = await fetch(`${prov.apiBaseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${prov.apiKey}` },
                body: JSON.stringify({
                    model: prov.model,
                    messages: [{ role: 'user', content: selectedAiCtx !== 'none' ? `Context: ${storage[selectedAiCtx]}\n\nQuery: ${query}` : query }]
                })
            });
            const data = await response.json();
            const content = data.choices[0].message.content;
            aiMsg.innerText = 'AI: ' + content;
            if (content.includes('```')) {
                const btn = document.createElement('div');
                btn.className = 'inject-btn'; btn.innerText = '>> EXTRACT_CODE';
                btn.onclick = () => {
                    const code = content.split('```')[1].split('\n').slice(1).join('\n');
                    document.getElementById('editor').value += "\n" + code;
                };
                aiMsg.appendChild(btn);
            }
        } catch (e) { aiMsg.innerText = 'AI_ERR: ' + e.message; }
        chat.scrollTop = chat.scrollHeight;
    }

    // --- Core Filesystem & Resizer ---
    function autoSave() {
        if (storage[activeFile] !== undefined && !activeFile.endsWith('/')) {
            storage[activeFile] = document.getElementById('editor').value;
        }
        localStorage.setItem('ind_console_storage', JSON.stringify(storage));
        localStorage.setItem('ind_console_active', activeFile);
    }

    function renderFiles() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        Object.keys(storage).sort().forEach(k => {
            const div = document.createElement('div');
            div.className = `file-item ${k === activeFile ? 'active' : ''} ${k.endsWith('/') ? 'folder' : ''}`;
            div.innerText = k;
            div.onclick = () => {
                activeFile = k;
                if (!k.endsWith('/')) {
                    document.getElementById('editor').value = storage[k];
                    document.getElementById('cur-filename').innerText = k;
                }
                renderFiles();
            };
            div.oncontextmenu = (e) => { ctxTarget = {path: k}; handleCtx(e); };
            list.appendChild(div);
        });
        updateAiCtxOptions();
    }

    function updateAiCtxOptions() {
        const container = document.getElementById('ai-ctx-options');
        container.innerHTML = `<div onclick="selectAiCtx('none')">-- NO_CONTEXT --</div>`;
        Object.keys(storage).forEach(k => { if(!k.endsWith('/')) {
            const d = document.createElement('div'); d.innerText = k;
            d.onclick = () => selectAiCtx(k); container.appendChild(d);
        }});
    }

    function selectAiCtx(val) {
        selectedAiCtx = val;
        document.getElementById('ai-ctx-val').innerText = val;
        document.getElementById('ai-ctx-options').style.display = 'none';
    }

    function toggleAiSelect() { 
        const opt = document.getElementById('ai-ctx-options');
        opt.style.display = opt.style.display === 'block' ? 'none' : 'block';
    }

    async function runCurrentFile() {
        addLog(`[SYSTEM]: EXEC >> ${activeFile}`, 'var(--amber)');
        const code = document.getElementById('editor').value;
        if (activeFile.endsWith('.js')) {
            try { new Function(code)(); } catch(e) { addLog(e.message, 'var(--term-red)'); }
        } else if (activeFile.endsWith('.py')) {
            if (!pyodideInstance) pyodideInstance = await loadPyodide();
            try { await pyodideInstance.runPythonAsync(code); } catch(e) { addLog(e.message, 'var(--term-red)'); }
        }
    }

    function addTerminal() {
        const id = 't-' + (++termCount);
        const tab = document.createElement('div');
        tab.className = 'term-tab'; tab.id = 'tab-' + id;
        tab.innerHTML = `<span>TERM_${termCount}</span>`;
        tab.onclick = () => switchTerminal(id);
        document.getElementById('term-tabs').appendChild(tab);
        const body = document.createElement('div');
        body.className = 'term-body'; body.id = id;
        body.innerHTML = `<div class="term-out">Terminal ${termCount} Ready.</div><div class="term-input-wrap"><span>>></span><input type="text" class="cmd-in"></div>`;
        document.getElementById('term-container').appendChild(body);
        switchTerminal(id);
    }

    function switchTerminal(id) {
        document.querySelectorAll('.term-tab, .term-body').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.getElementById(id).classList.add('active');
        activeTermId = id;
    }

    function addLog(msg, color) {
        if (!activeTermId) return;
        const out = document.getElementById(activeTermId).querySelector('.term-out');
        const d = document.createElement('div'); d.style.color = color; d.innerText = msg;
        out.appendChild(d); out.scrollTop = out.scrollHeight;
    }

    function handleCtx(e) {
        e.preventDefault();
        const m = document.getElementById('ctx');
        m.style.display = 'block'; m.style.left = e.pageX + 'px'; m.style.top = e.pageY + 'px';
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function openModal() {
        document.getElementById('modal-title').innerText = "NEW_NODE";
        document.getElementById('modal-content').innerHTML = `
            <input type="text" id="node-name" class="modal-input" placeholder="FILENAME.ext">
            <div class="modal-btns">
                <button class="ai-btn" onclick="closeModal()">CANCEL</button>
                <button class="ai-btn" style="background:var(--amber); color:#000" onclick="confirmNewNode()">CREATE</button>
            </div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function confirmNewNode() {
        const name = document.getElementById('node-name').value;
        if(name) { storage[name] = ""; renderFiles(); closeModal(); }
    }

    async function saveZip() {
        const zip = new JSZip();
        Object.keys(storage).forEach(k => { if(!k.endsWith('/')) zip.file(k, storage[k]); });
        const blob = await zip.generateAsync({type:"blob"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "immmor_archive.zip"; a.click();
    }

    function insertAtCursor(text) {
        const el = document.getElementById('editor');
        const start = el.selectionStart, end = el.selectionEnd;
        el.value = el.value.substring(0, start) + text + el.value.substring(end);
        el.selectionStart = el.selectionEnd = start + text.length;
        el.focus();
    }

    async function editorAction(action) {
        const el = document.getElementById('editor');
        if(action === 'selectAll') el.select();
        if(action === 'copy') navigator.clipboard.writeText(el.value.substring(el.selectionStart, el.selectionEnd));
        if(action === 'paste') insertAtCursor(await navigator.clipboard.readText());
    }

    // --- Init Resizers ---
    function initResizer(bar, target, isH, isInverse) {
        let dragging = false;
        bar.onmousedown = () => dragging = true;
        document.onmousemove = (e) => {
            if(!dragging) return;
            if(isH) {
                let w = isInverse ? window.innerWidth - e.clientX : e.clientX;
                target.style.width = Math.max(100, w) + 'px';
            } else {
                let h = isInverse ? window.innerHeight - e.clientY : e.clientY;
                target.style.height = Math.max(50, h) + 'px';
            }
        };
        document.onmouseup = () => dragging = false;
    }

    initResizer(document.getElementById('h-drag-left'), document.getElementById('explorer'), true, false);
    initResizer(document.getElementById('h-drag-right'), document.getElementById('ai-panel'), true, true);
    initResizer(document.getElementById('v-drag'), document.getElementById('terminal'), false, true);
    initResizer(document.getElementById('v-drag-explorer'), document.getElementById('file-section'), false, false);

    document.onclick = () => { 
        document.getElementById('ctx').style.display = 'none';
        document.getElementById('ai-ctx-options').style.display = 'none';
    };
    document.getElementById('ai-in').onkeydown = (e) => { if(e.key==='Enter') sendAi(); };

    // Boot
    renderFiles(); addTerminal(); addAiTab(); updateProviderSelector();
    document.getElementById('editor').value = storage[activeFile] || "";
</script>
</body>
</html>