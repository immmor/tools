<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMMMOR CODE // AI EVOLVED</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

    <style>
        :root {
            --amber: #ffb000;
            --amber-dim: #714e00;
            --bg: #0d0c08;
            --panel-bg: #161410;
            --term-green: #00ff41;
            --term-red: #ff3e3e;
            --border-w: 2px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: var(--bg); color: var(--amber);
            font-family: 'Courier New', monospace; overflow: hidden;
        }

        .layout { display: flex; height: 100vh; flex-direction: column; }
        .workspace { display: flex; flex: 1; overflow: hidden; }

        /* 编辑器主区域 */
        .editor-container { flex: 1; display: flex; flex-direction: column; position: relative; border-right: 1px solid var(--amber-dim); }
        #main-editor {
            flex: 1; background: transparent; color: var(--amber); border: none;
            padding: 20px; font-size: 15px; outline: none; resize: none; font-family: inherit; line-height: 1.6;
        }

        /* --- 新增：Diff 样式 --- */
        #diff-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 100; overflow-y: auto; padding: 20px;
        }
        .diff-line { display: block; padding: 0 5px; white-space: pre-wrap; }
        .diff-add { background: rgba(0, 255, 65, 0.15); border-left: 3px solid var(--term-green); color: #fff; }
        .diff-rem { background: rgba(255, 62, 62, 0.15); border-left: 3px solid var(--term-red); color: #ccc; text-decoration: line-through; }
        
        /* Diff 确认底栏 */
        .diff-actions {
            position: sticky; bottom: 0; left: 0; width: 100%; background: var(--panel-bg);
            padding: 10px; border-top: 2px solid var(--amber); display: flex; gap: 10px; justify-content: center;
        }
        .btn-merge { background: var(--term-green); color: #000; border: none; padding: 8px 20px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: transparent; color: var(--term-red); border: 1px solid var(--term-red); padding: 8px 20px; cursor: pointer; }

        /* --- 新增：AI 面板代码块样式 --- */
        .ai-panel { width: 380px; display: flex; flex-direction: column; background: var(--panel-bg); }
        #ai-messages { flex: 1; overflow-y: auto; padding: 15px; }
        
        .bubble { margin-bottom: 20px; border-left: 3px solid var(--amber-dim); padding: 10px; font-size: 13px; }
        .bubble.ai { border-color: var(--term-green); background: rgba(0, 255, 65, 0.02); }

        /* AI 代码块容器 */
        .code-block-wrapper { margin: 15px 0; border: 1px solid var(--amber-dim); background: #000; }
        .code-header {
            background: #222; padding: 5px 10px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--amber-dim);
        }
        .code-lang { font-size: 10px; color: var(--amber-dim); font-weight: bold; }
        .code-btns { display: flex; gap: 8px; }
        .btn-mini {
            font-size: 9px; padding: 2px 6px; cursor: pointer; border: 1px solid var(--amber-dim);
            background: transparent; color: var(--amber); transition: 0.2s;
        }
        .btn-mini:hover { background: var(--amber); color: #000; }
        .btn-mini.primary { border-color: var(--term-green); color: var(--term-green); }
        .btn-mini.primary:hover { background: var(--term-green); color: #000; }

        pre { margin: 0 !important; padding: 10px !important; background: transparent !important; }

        /* 输入区 */
        .ai-input-box { padding: 15px; border-top: 1px solid var(--amber-dim); background: #000; }
        #ai-text { width: 100%; background: transparent; border: 1px solid var(--amber-dim); color: var(--amber); padding: 10px; outline: none; resize: none; font-family: inherit; }
    </style>
</head>
<body>

<div class="layout">
    <div class="workspace">
        <div class="editor-container">
            <div style="padding: 5px 15px; font-size: 11px; background: #000; border-bottom: 1px solid var(--amber-dim);">EDITOR // main.js</div>
            <textarea id="main-editor" spellcheck="false">function updateCore() {
    const power = 100;
    console.log("Core Power:", power);
}</textarea>

            <div id="diff-overlay">
                <div id="diff-content"></div>
                <div class="diff-actions">
                    <button class="btn-merge" onclick="confirmMerge()">ACCEPT & MERGE</button>
                    <button class="btn-cancel" onclick="closeDiff()">DISCARD</button>
                </div>
            </div>
        </div>

        <div class="ai-panel">
            <div style="padding: 10px; font-size: 11px; font-weight: bold; border-bottom: 1px solid var(--amber-dim);">AI_CO-PROCESSOR</div>
            <div id="ai-messages">
                <div class="bubble ai">Ready for synchronization. How should we evolve the code?</div>
            </div>
            <div class="ai-input-box">
                <textarea id="ai-text" rows="2" placeholder="Input command... (Ctrl+Enter)"></textarea>
            </div>
        </div>
    </div>
</div>

<script>
    const editor = document.getElementById('main-editor');
    const aiMessages = document.getElementById('ai-messages');
    const aiInput = document.getElementById('ai-text');
    let pendingCode = "";

    // 1. 初始化 Markdown 配置
    marked.setOptions({
        highlight: (code, lang) => Prism.highlight(code, Prism.languages.javascript || Prism.languages.clike, lang)
    });

    // 2. 发送逻辑
    async function handleSend() {
        const query = aiInput.value.trim();
        if(!query) return;

        addBubble('user', query);
        aiInput.value = '';
        const aiBubble = addBubble('ai', 'Thinking...');

        // 模拟 AI 返回 (实际连接你的接口)
        setTimeout(() => {
            const mockCode = `function updateCore() {\n    const power = 9000;\n    const status = "OVERLOAD";\n    console.log(\`Core Power: \${power} - Status: \${status}\`);\n}`;
            const markdown = `已优化核心函数，提升了能量输出并增加了状态检测：\n\n\`\`\`javascript\n${mockCode}\n\`\`\``;
            
            // 渲染 Markdown
            aiBubble.innerHTML = marked.parse(markdown);
            
            // 3. 处理代码块：替换为带样式的 Wrapper
            aiBubble.querySelectorAll('pre').forEach(pre => {
                const code = pre.querySelector('code').innerText;
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';
                wrapper.innerHTML = `
                    <div class="code-header">
                        <span class="code-lang">JAVASCRIPT</span>
                        <div class="code-btns">
                            <button class="btn-mini" onclick="showDiff(\`${code}\`)">VIEW DIFF</button>
                            <button class="btn-mini primary" onclick="applyDirectly(\`${code}\`)">APPLY</button>
                        </div>
                    </div>
                `;
                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(pre);
            });
            
            Prism.highlightAll();
        }, 800);
    }

    // 4. Diff 视图逻辑
    function showDiff(newCode) {
        pendingCode = newCode;
        const oldCode = editor.value;
        const diffContent = document.getElementById('diff-content');
        
        // 极简 Diff 算法演示
        const oldLines = oldCode.split('\n');
        const newLines = newCode.split('\n');
        let html = "";
        
        // 简单逻辑：显示旧的（删掉）和新的（增加）
        oldLines.forEach(line => html += `<div class="diff-line diff-rem">- ${line}</div>`);
        newLines.forEach(line => html += `<div class="diff-line diff-add">+ ${line}</div>`);

        diffContent.innerHTML = html;
        document.getElementById('diff-overlay').style.display = 'block';
    }

    function confirmMerge() {
        editor.value = pendingCode;
        closeDiff();
        addBubble('ai', '✓ Code merged into editor.');
    }

    function applyDirectly(code) {
        editor.value = code;
        addBubble('ai', '✓ Code applied directly.');
    }

    function closeDiff() { document.getElementById('diff-overlay').style.display = 'none'; }

    // 辅助 UI 函数
    function addBubble(role, text) {
        const div = document.createElement('div');
        div.className = `bubble ${role}`;
        div.innerHTML = text;
        aiMessages.appendChild(div);
        aiMessages.scrollTop = aiMessages.scrollHeight;
        return div;
    }

    // 热键发送
    aiInput.onkeydown = (e) => {
        if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)) handleSend();
    };
</script>

</body>
</html>