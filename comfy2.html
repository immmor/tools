<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SmolLM 极速提示词专家</title>
    <style>
        body { font-family: system-ui, sans-serif; background: #fdfdfd; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; width: 100%; max-width: 600px; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
        h2 { margin-top: 0; color: #333; font-size: 1.2rem; }
        .status-box { font-size: 12px; color: #888; margin-bottom: 10px; }
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        button { width: 100%; background: #10b981; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:disabled { background: #d1d5db; }
        #output { margin-top: 20px; padding: 12px; background: #f0fdf4; border-radius: 6px; white-space: pre-wrap; font-size: 13px; color: #166534; min-height: 40px; }
        .prog { height: 4px; background: #eee; border-radius: 2px; margin: 10px 0; display: none; }
        #bar { height: 100%; background: #10b981; width: 0%; }
    </style>
</head>
<body>

<div class="card">
    <h2>⚡ SmolLM 极速优化器</h2>
    <div id="status" class="status-box">准备中...</div>
    <div class="prog" id="prog"><div id="bar"></div></div>

    <textarea id="userInput" placeholder="输入简单描述，例如：写个带猫的科幻故事背景"></textarea>
    <button id="runBtn" disabled>加载模型中...</button>

    <div id="output">等待指令...</div>
</div>

<script type="module">
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0-alpha.19';

    env.allowLocalModels = false;

    const status = document.getElementById('status');
    const btn = document.getElementById('runBtn');
    const output = document.getElementById('output');
    const bar = document.getElementById('bar');
    const prog = document.getElementById('prog');

    let generator;

    async function init() {
        try {
            // SmolLM-135M 是极小规模模型，这里强制 q4 量化
            generator = await pipeline('text-generation', 'onnx-community/SmolLM-135M-Instruct', {
                dtype: 'q4', 
                device: 'webgpu', 
                progress_callback: (p) => {
                    prog.style.display = 'block';
                    if (p.status === 'progress') {
                        status.innerText = `下载中: ${Math.round(p.loaded/1024/1024)}MB (总共约40-80MB)`;
                        bar.style.width = `${p.progress}%`;
                    }
                    if (p.status === 'done') {
                        status.innerText = '✅ 模型已就绪';
                        prog.style.display = 'none';
                        btn.disabled = false;
                        btn.innerText = '立即优化';
                    }
                }
            });
        } catch (e) {
            status.innerText = '加载失败：' + e.message;
        }
    }

    btn.onclick = async () => {
        const text = document.getElementById('userInput').value.trim();
        if (!text) return;

        btn.disabled = true;
        output.innerText = '生成中...';

        // 注意：SmolLM 对中文支持较弱，建议用简单的中文系统提示
        const messages = [
            { role: "system", content: "You are a prompt engineer. Refine the user's input into a high-quality, detailed AI prompt. Output the refined prompt only." },
            { role: "user", content: `Optimize: ${text}` }
        ];

        try {
            const result = await generator(messages, { 
                max_new_tokens: 256,
                temperature: 0.6,
                do_sample: true 
            });

            output.innerText = result[0].generated_text.at(-1).content;
        } catch (err) {
            output.innerText = '错误：' + err.message;
        } finally {
            btn.disabled = false;
        }
    };

    init();
</script>
</body>
</html>