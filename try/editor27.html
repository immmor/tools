<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INDUSTRIAL_AI_V8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --amber: #ffb000;
            --amber-dim: #714e00;
            --bg: #12100b;
            --panel: #1c1912;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; cursor: default; }
        body, html {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: var(--bg); color: var(--amber);
            font-family: 'Courier New', Courier, monospace; overflow: hidden;
        }

        /* 扫描线特效 */
        body::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 11, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03));
            z-index: 1000; pointer-events: none; background-size: 100% 4px, 3px 100%;
        }

        .header { height: 35px; border-bottom: 2px solid var(--amber); display: flex; align-items: center; padding: 0 15px; font-size: 12px; font-weight: bold; }

        /* 核心布局 */
        .workspace { display: flex; height: calc(100vh - 35px); width: 100%; position: relative; }
        .panel { background: var(--panel); display: flex; flex-direction: column; overflow: hidden; position: relative; height: 100%; border-right: 1px solid var(--amber-dim); }
        .panel.maximized { position: fixed !important; top: 0; left: 0; width: 100% !important; height: 100% !important; z-index: 2000; }

        /* 拖拽条 */
        .divider-h { width: 4px; background: var(--amber-dim); cursor: col-resize !important; flex-shrink: 0; transition: 0.2s; }
        .divider-h:hover, .divider-h.active { background: var(--amber); box-shadow: 0 0 10px var(--amber); }

        .p-head { height: 30px; border-bottom: 1px solid var(--amber-dim); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; font-size: 11px; flex-shrink: 0; }
        .ctrl { cursor: pointer !important; padding: 2px 5px; border: 1px solid var(--amber-dim); }
        .ctrl:hover { background: var(--amber); color: #000; }

        /* 文件列表 */
        #explorer { width: 180px; }
        .file-item { padding: 10px 15px; font-size: 12px; border-bottom: 1px solid rgba(113, 78, 0, 0.2); user-select: none; }
        .file-item.active { background: var(--amber); color: #000; font-weight: bold; }

        /* 编辑器 */
        #editor-p { flex: 1; min-width: 0; }
        #editor { flex: 1; background: transparent; border: none; outline: none; padding: 20px; color: var(--amber); font-size: 15px; resize: none; font-family: inherit; cursor: text !important; }

        /* AI 面板 */
        #ai-p { width: 300px; border-left: 1px solid var(--amber-dim); background: #16140e; }
        #ai-chat { flex: 1; overflow-y: auto; padding: 15px; font-size: 12px; line-height: 1.5; border-bottom: 1px solid var(--amber-dim); }
        .ai-msg { margin-bottom: 15px; border-left: 2px solid var(--amber-dim); padding-left: 10px; }
        .ai-msg.user { border-left-color: #fff; color: #ccc; }
        .ai-input-box { display: flex; padding: 10px; background: #000; }
        #ai-in { background: transparent; border: none; outline: none; color: #fff; flex: 1; font-family: inherit; font-size: 12px; cursor: text !important; }

        /* 终端 */
        #terminal { height: 120px; border-top: 1px solid var(--amber); }

        /* 右键菜单 */
        #ctx { position: fixed; display: none; background: var(--panel); border: 2px solid var(--amber); z-index: 3000; min-width: 180px; box-shadow: 6px 6px 0 #000; }
        .opt { padding: 10px 15px; font-size: 12px; cursor: pointer !important; }
        .opt:hover { background: var(--amber); color: #000; }
    </style>
</head>
<body oncontextmenu="handleGlobalCtx(event)">

<div class="header">AI_INTEGRATED_OS // CORE_ACTIVE</div>

<div class="workspace">
    <aside class="panel" id="explorer" onmousedown="startLongPress(event)" ontouchstart="startLongPress(event)" ontouchend="cancelLongPress()" ontouchmove="cancelLongPress()">
        <div class="p-head">
            <span>NODES</span>
            <span class="ctrl" onclick="toggleMax('explorer')">[ ◰ ]</span>
        </div>
        <div id="file-list"></div>
    </aside>

    <div class="divider-h" id="h1-drag"></div>

    <div id="editor-p" class="panel">
        <div class="p-head">
            <span id="cur-filename">buffer.src</span>
            <span class="ctrl" onclick="toggleMax('editor-p')">[ ◰ ]</span>
        </div>
        <textarea id="editor" spellcheck="false"></textarea>
        
        <footer id="terminal" class="panel">
            <div class="p-head"><span>TERMINAL</span></div>
            <div id="term-out" style="flex:1; padding:8px; font-size:11px; overflow-y:auto;">Awaiting input...</div>
        </footer>
    </div>

    <div class="divider-h" id="h2-drag"></div>

    <aside class="panel" id="ai-p">
        <div class="p-head">
            <span>AI_COPROCESSOR</span>
            <span class="ctrl" onclick="toggleMax('ai-p')">[ ◰ ]</span>
        </div>
        <div id="ai-chat">
            <div class="ai-msg">System: AI Core Link Established. How can I assist with your code?</div>
        </div>
        <div class="ai-input-box">
            <input type="text" id="ai-in" placeholder="Ask AI to generate code..." autocomplete="off">
        </div>
    </aside>
</div>

<div id="ctx">
    <div class="opt" onclick="newFile()">[+] NEW_DATA_NODE</div>
    <div class="opt" onclick="saveZip()">[↓] ARCHIVE_ZIP</div>
    <div class="opt" onclick="location.reload()">[R] REBOOT_LINK</div>
</div>

<script>
    let files = { 'main.js': '// System initialized\nconsole.log("READY");', 'style.css': 'body { background: #000; }' };
    let activeKey = 'main.js';

    // 1. 长按/右键逻辑 (仅限文件预览区)
    let pressTimer;
    function startLongPress(e) {
        if (e.type === 'mousedown' && e.button !== 0) return; // 排除鼠标右键（由 contextmenu 处理）
        cancelLongPress();
        const pos = e.touches ? e.touches[0] : e;
        pressTimer = setTimeout(() => showMenu(pos.pageX, pos.pageY), 600);
    }
    function cancelLongPress() { clearTimeout(pressTimer); }
    function handleGlobalCtx(e) {
        e.preventDefault();
        // 只有在 Explorer 面板内才显示菜单
        if (e.target.closest('#explorer')) showMenu(e.pageX, e.pageY);
    }
    function showMenu(x, y) {
        const menu = document.getElementById('ctx');
        menu.style.display = 'block';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
    }
    document.addEventListener('click', () => document.getElementById('ctx').style.display = 'none');

    // 2. 拖拽引擎
    function setupDrag(bar, target, type) {
        let dragging = false;
        bar.addEventListener('mousedown', () => dragging = true);
        bar.addEventListener('touchstart', () => dragging = true);
        document.addEventListener('mousemove', (e) => {
            if (!dragging) return;
            let x = (e.touches ? e.touches[0].clientX : e.clientX);
            let p = (x / window.innerWidth) * 100;
            if (p < 5) p = 0; if (p > 95) p = 100;
            target.style.width = p + '%';
        });
        // 针对右侧 AI 面板的特殊处理 (从右往左拖)
        if (target.id === 'ai-p') {
            document.addEventListener('mousemove', (e) => {
                if (!dragging) return;
                let x = (e.touches ? e.touches[0].clientX : e.clientX);
                let p = 100 - (x / window.innerWidth) * 100;
                if (p < 5) p = 0; if (p > 95) p = 100;
                target.style.width = p + '%';
            });
        }
        document.addEventListener('mouseup', () => dragging = false);
        document.addEventListener('touchend', () => dragging = false);
    }
    setupDrag(document.getElementById('h1-drag'), document.getElementById('explorer'), 'L');
    setupDrag(document.getElementById('h2-drag'), document.getElementById('ai-p'), 'R');

    // 3. AI 对话与代码生成
    const aiIn = document.getElementById('ai-in');
    const aiChat = document.getElementById('ai-chat');

    aiIn.onkeydown = async (e) => {
        if (e.key === 'Enter' && aiIn.value.trim()) {
            const prompt = aiIn.value;
            appendChat('User', prompt);
            aiIn.value = '';
            
            // 模拟 AI 生成过程
            const response = `Analyzing request... I have generated a code snippet for you: \n\n\`\`\`javascript\n// AI Generated\nfunction automate() {\n  console.log("Task Executed: ${prompt}");\n}\n\`\`\``;
            await typeWriter(response);
        }
    };

    function appendChat(sender, text) {
        const div = document.createElement('div');
        div.className = `ai-msg ${sender === 'User' ? 'user' : ''}`;
        div.innerText = `${sender}: ${text}`;
        aiChat.appendChild(div);
        aiChat.scrollTop = aiChat.scrollHeight;
        return div;
    }

    async function typeWriter(text) {
        const div = appendChat('AI', '');
        let i = 0;
        return new Promise(resolve => {
            const timer = setInterval(() => {
                div.innerText += text[i];
                i++;
                aiChat.scrollTop = aiChat.scrollHeight;
                if (i >= text.length) {
                    clearInterval(timer);
                    resolve();
                }
            }, 30); // 丝滑逐字打印速度
        });
    }

    // 4. 其他功能
    function toggleMax(id) { document.getElementById(id).classList.toggle('maximized'); }
    function render() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        Object.keys(files).forEach(k => {
            const el = document.createElement('div');
            el.className = `file-item ${k === activeKey ? 'active' : ''}`;
            el.innerText = k;
            el.onclick = () => {
                files[activeKey] = document.getElementById('editor').value;
                activeKey = k;
                document.getElementById('editor').value = files[k];
                document.getElementById('cur-filename').innerText = k;
                render();
            };
            list.appendChild(el);
        });
    }
    function newFile() {
        const n = prompt("ENTER NODE NAME:");
        if(n) { files[n] = "// init"; activeKey = n; render(); }
    }
    async function saveZip() {
        const zip = new JSZip();
        Object.keys(files).forEach(k => zip.file(k, files[k]));
        const b = await zip.generateAsync({type:"blob"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b); a.download = "archive.zip"; a.click();
    }

    render();
    document.getElementById('editor').value = files[activeKey];
</script>
</body>
</html>