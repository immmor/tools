name: Build Music Player APK
on:
  # åªæœ‰æäº¤ä¿¡æ¯åŒ…å«[build]æ—¶æ‰è§¦å‘APKæ‰“åŒ…
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    # åªåœ¨æäº¤ä¿¡æ¯åŒ…å«[build]æ—¶æ‰§è¡Œæ„å»º
    if: contains(github.event.head_commit.message, '[build music]')
    
    steps:
      - uses: actions/checkout@v4
      
      # ä½¿ç”¨ Capacitor å°† HTML è½¬æ¢ä¸ºå®‰å“å·¥ç¨‹
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: { node-version: '20' }
        
      - name: Install Dependencies
        run: |
          npm init -y
          npm i @capacitor/core @capacitor/cli @capacitor/android
          npx cap init "Liquid Future Player" "com.liquid.future.player" --web-dir music
          npx cap add android
          
          # æ£€æŸ¥å›¾æ ‡æ–‡ä»¶
          echo "ğŸ“± æ£€æŸ¥å›¾æ ‡æ–‡ä»¶..."
          if [ -f "music/icon.png" ]; then
            echo "âœ… æ‰¾åˆ°è‡ªå®šä¹‰å›¾æ ‡: music/icon.png"
            ls -la music/icon.png
          else
            echo "âŒ æœªæ‰¾åˆ°è‡ªå®šä¹‰å›¾æ ‡æ–‡ä»¶"
            exit 1
          fi
          
          # é…ç½®åº”ç”¨å›¾æ ‡ - ä½¿ç”¨ Capacitor æ¨èçš„æ–¹å¼
          echo "ğŸ”„ é…ç½®åº”ç”¨å›¾æ ‡..."
          
          # åˆ›å»º Capacitor é…ç½®æ–‡ä»¶
          cat > capacitor.config.json <<'EOF'
          {
            "appId": "com.liquid.future.player",
            "appName": "Liquid Future Player",
            "webDir": "music",
            "android": {
              "path": "android"
            }
          }
          EOF
          
          # æ‰‹åŠ¨å¤åˆ¶å›¾æ ‡åˆ° Android èµ„æºç›®å½•
          mkdir -p android/app/src/main/res
          
          # å¤åˆ¶å›¾æ ‡åˆ° mipmap ç›®å½•ï¼ˆAndroid æ¨èï¼‰
          mkdir -p android/app/src/main/res/mipmap-mdpi
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          
          cp music/icon.png android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          cp music/icon.png android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          cp music/icon.png android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          cp music/icon.png android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          cp music/icon.png android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          
          # å¤åˆ¶åœ†å½¢å›¾æ ‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
          cp music/icon.png android/app/src/main/res/mipmap-mdpi/ic_launcher_round.png
          cp music/icon.png android/app/src/main/res/mipmap-hdpi/ic_launcher_round.png
          cp music/icon.png android/app/src/main/res/mipmap-xhdpi/ic_launcher_round.png
          cp music/icon.png android/app/src/main/res/mipmap-xxhdpi/ic_launcher_round.png
          cp music/icon.png android/app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png
          
          # æ›´æ–° AndroidManifest.xml ä»¥ä½¿ç”¨æ­£ç¡®çš„å›¾æ ‡
          cat > android/app/src/main/AndroidManifest.xml <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:label="@string/app_name"
                  android:theme="@style/AppTheme">
                  <activity
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|locale|smallestScreenSize|screenLayout|uiMode"
                      android:name=".MainActivity"
                      android:exported="true"
                      android:label="@string/title_activity_main"
                      android:theme="@style/AppTheme.NoActionBarLaunch">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          
          # æ›´æ–°åº”ç”¨ä¸»é¢˜ä»¥ç¡®ä¿å›¾æ ‡æ­£ç¡®æ˜¾ç¤º
          cat > android/app/src/main/res/values/styles.xml <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <style name="AppTheme" parent="Theme.AppCompat.Light.DarkActionBar">
                  <item name="colorPrimary">@color/colorPrimary</item>
                  <item name="colorPrimaryDark">@color/colorPrimaryDark</item>
                  <item name="colorAccent">@color/colorAccent</item>
              </style>
              <style name="AppTheme.NoActionBarLaunch" parent="AppTheme">
                  <item name="windowActionBar">false</item>
                  <item name="windowNoTitle">true</item>
              </style>
          </resources>
          EOF
          
          # å®šä¹‰é¢œè‰²èµ„æº
          cat > android/app/src/main/res/values/colors.xml <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <color name="colorPrimary">#3a1c71</color>
              <color name="colorPrimaryDark">#2c1357</color>
              <color name="colorAccent">#d76d77</color>
          </resources>
          EOF
          
          # æ›´æ–°å­—ç¬¦ä¸²èµ„æº
          cat > android/app/src/main/res/values/strings.xml <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">Liquid Future Player</string>
              <string name="title_activity_main">Liquid Future Player</string>
              <string name="package_name">com.liquid.future.player</string>
              <string name="custom_url_scheme">liquidplayer</string>
          </resources>
          EOF
          
          echo "âœ… å›¾æ ‡é…ç½®å®Œæˆ"
          npx cap copy

      - name: Fix Kotlin versions to avoid duplicate stdlib
        run: |
          BUILD_FILE=android/build.gradle
          if [ -f "$BUILD_FILE" ]; then
            cat >> "$BUILD_FILE" <<'EOF'
          subprojects {
            configurations.all {
              resolutionStrategy {
                force 'org.jetbrains.kotlin:kotlin-stdlib:1.8.22', 'org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.8.22'
                eachDependency { details ->
                  if (details.requested.group == 'org.jetbrains.kotlin' && details.requested.name.startsWith('kotlin-stdlib')) {
                    details.useVersion '1.8.22'
                  }
                }
              }
            }
          }
          EOF
          fi
          
      # çœŸæ­£æ‰“åŒ…æˆ APK (éœ€è¦ Java ç¯å¢ƒ)
      - name: set up JDK 21
        uses: actions/setup-java@v4
        with: { java-version: '21', distribution: 'temurin' }
        
      - name: Build with Gradle
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug
          
      # å°†æ‰“åŒ…å¥½çš„ APK å˜æˆå¯ä¸‹è½½çš„"å·¥ä»¶"
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: liquid-future-player-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          
      # å‘å¸ƒåˆ° GitHub Releases
      - name: Create Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          files: android/app/build/outputs/apk/debug/app-debug.apk
          tag_name: "music-build-${{ github.run_number }}"
          name: "Liquid Future Player Build #${{ github.run_number }}"
          body: |
            Liquid Future Player Android APK - Automated Build
            
            **Build Information:**
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            - Build Number: #${{ github.run_number }}
            - Date: ${{ github.event.head_commit.timestamp }}
            
            **Features:**
            - Liquid future music player with modern UI
            - Advanced audio visualization
            - Responsive design for mobile devices
            - Smooth animations and transitions
            - Cross-platform compatibility
            
            **Download:**
            Click the APK file above to download and install on your Android device.
          draft: false
          prerelease: true