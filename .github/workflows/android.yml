name: Build Android APK
on: [push] # 每次你推代码到 Cloudflare，这里也会同步打包

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # 使用 Capacitor 将 HTML 转换为安卓工程
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: { node-version: '20' }
        
      - name: Install Dependencies
        run: |
          npm init -y
          npm i @capacitor/core @capacitor/cli @capacitor/android
          npx cap init "ImmmorEditor" "com.immmor.editor" --web-dir editor
          npx cap add android
          
          # 配置应用图标和启动画面
          mkdir -p android/app/src/main/res/drawable
          cp editor/iwe.png android/app/src/main/res/drawable/icon.png
          
          # 更新Android配置以使用自定义图标
          cat > android/app/src/main/res/values/strings.xml <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">Immmor Editor</string>
          </resources>
          EOF
          
          npx cap copy

      - name: Fix Kotlin versions to avoid duplicate stdlib
        run: |
          BUILD_FILE=android/build.gradle
          if [ -f "$BUILD_FILE" ]; then
            cat >> "$BUILD_FILE" <<'EOF'
          subprojects {
            configurations.all {
              resolutionStrategy {
                force 'org.jetbrains.kotlin:kotlin-stdlib:1.8.22', 'org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.8.22'
                eachDependency { details ->
                  if (details.requested.group == 'org.jetbrains.kotlin' && details.requested.name.startsWith('kotlin-stdlib')) {
                    details.useVersion '1.8.22'
                  }
                }
              }
            }
          }
          EOF
          fi
          
      # 真正打包成 APK (需要 Java 环境)
      - name: set up JDK 21
        uses: actions/setup-java@v4
        with: { java-version: '21', distribution: 'temurin' }
        
      - name: Build with Gradle
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug
          
      # 将打包好的 APK 变成可下载的"工件"
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: immmor-editor-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          
      # 发布到 GitHub Releases
      - name: Create Release
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: android/app/build/outputs/apk/debug/app-debug.apk
          body: |
            Immmor Editor Android APK
            
            - Built from commit ${{ github.sha }}
            - Version: ${{ github.ref_name }}
            - Date: ${{ github.event.head_commit.timestamp }}
            
            Features:
            - Full-featured code editor with Monaco
            - AI assistant integration
            - Terminal support
            - File system management
          draft: false
          prerelease: false