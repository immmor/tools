<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>immmor code</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        :root {
            --amber: #ffb000;
            --amber-dim: #714e00;
            --bg: #12100b;
            --panel-bg: #1c1912;
            --border-w: 2px;
            --term-red: #ff3e3e;
            --term-green: #00ff41;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; cursor: default; }
        
        body, html {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: var(--bg); color: var(--amber);
            font-family: 'Courier New', Courier, monospace; overflow: hidden;
            background-image: linear-gradient(rgba(18, 16, 11, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 255, 0, 0.06));
            background-size: 100% 4px, 3px 100%;
        }

        .header {
            height: 40px; border-bottom: var(--border-w) solid var(--amber);
            display: flex; align-items: center; padding: 0 15px;
            font-size: 14px; font-weight: bold; background: var(--panel-bg);
            text-shadow: 0 0 5px var(--amber); gap: 20px;
        }

        .menu-btn { cursor: pointer !important; padding: 5px 10px; border: 1px solid transparent; }
        .menu-btn:hover { border-color: var(--amber); background: rgba(255, 176, 0, 0.1); }

        .workspace { display: flex; flex-direction: row; height: calc(100vh - 40px); width: 100%; position: relative; }

        .panel { 
            background: var(--panel-bg); display: flex; flex-direction: column; 
            overflow: hidden; position: relative; height: 100%;
        }

        .panel.maximized {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; z-index: 500;
        }

        .divider-h { width: 6px; background: var(--amber-dim); cursor: col-resize !important; flex-shrink: 0; }
        .divider-h:hover, .divider-h.active { background: var(--amber); box-shadow: 0 0 10px var(--amber); }

        .divider-v { height: 6px; background: var(--amber-dim); cursor: row-resize !important; flex-shrink: 0; }
        .divider-v:hover, .divider-v.active { background: var(--amber); box-shadow: 0 0 10px var(--amber); }

        .p-head {
            height: 30px; border-bottom: 1px solid var(--amber-dim);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; font-size: 11px; background: rgba(113, 78, 0, 0.1);
        }
        .ctrl-group { display: flex; gap: 5px; }
        .ctrl { cursor: pointer !important; padding: 2px 6px; border: 1px solid var(--amber-dim); }
        .ctrl:hover { background: var(--amber); color: var(--bg); }

        #explorer { width: 200px; border-right: 1px solid var(--amber-dim); }
        #file-list, #plugin-list { overflow-y: auto; flex: 1; }
        #plugin-section { height: 35%; border-top: 1px solid var(--amber-dim); display: flex; flex-direction: column; }
        
        .file-item, .plugin-item { 
            padding: 8px 15px; font-size: 13px; cursor: pointer !important; 
            border-bottom: 1px solid rgba(113, 78, 0, 0.05); 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center; gap: 8px;
            color: var(--amber); opacity: 0.7;
        }
        .file-item:hover, .plugin-item:hover { background: rgba(255, 176, 0, 0.05); opacity: 0.9; }
        .file-item.active { background: var(--amber); color: var(--bg); font-weight: bold; opacity: 1; }
        .file-item.folder { color: #fff; font-weight: bold; opacity: 1; border-left: 2px solid var(--amber-dim); }
        .file-icon { font-size: 12px; width: 14px; text-align: center; display: inline-block; transition: transform 0.2s; }
        .file-icon.open { transform: rotate(90deg); }

        .plugin-item { justify-content: space-between; font-size: 11px; }
        .plugin-status { width: 8px; height: 8px; border-radius: 50%; background: var(--amber-dim); }
        .plugin-status.active { background: var(--term-green); box-shadow: 0 0 5px var(--term-green); }

        .file-rename-input {
            background: var(--amber); color: var(--bg); border: none; outline: none;
            font-family: inherit; font-size: 13px; width: 100%; padding: 0; margin: 0; font-weight: bold;
        }

        #main-stack { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        #editor {
            flex: 1; background: transparent; border: none; outline: none;
            padding: 20px; color: var(--amber); font-size: 16px;
            line-height: 1.5; resize: none; font-family: inherit; cursor: text !important;
        }

        #terminal { height: 220px; border-top: var(--border-w) solid var(--amber); }
        .term-tabs { display: flex; background: #000; border-bottom: 1px solid var(--amber-dim); }
        .term-tab { padding: 5px 12px; font-size: 10px; border-right: 1px solid var(--amber-dim); cursor: pointer !important; opacity: 0.6; }
        .term-tab.active { background: var(--amber-dim); color: #fff; opacity: 1; }
        
        .term-body { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .term-body.active { display: flex; }
        .term-out { flex: 1; padding: 10px; overflow-y: auto; font-size: 12px; color: rgba(255, 176, 0, 0.8); white-space: pre-wrap; word-break: break-all; }
        .term-input-wrap { display: flex; padding: 8px 10px; background: #000; border-top: 1px solid var(--amber-dim); gap: 10px; align-items: center; }
        .cmd-in { background: transparent; border: none; outline: none; flex: 1; color: #fff; font-family: inherit; cursor: text !important; }

        #ai-panel { width: 280px; border-left: 1px solid var(--amber-dim); }
        #ai-chat { flex: 1; padding: 15px; overflow-y: auto; font-size: 13px; scroll-behavior: smooth; }
        
        .msg { margin-bottom: 15px; line-height: 1.4; border-left: 2px solid var(--amber-dim); padding-left: 10px; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; }
        .msg.ai { border-left-color: var(--amber); }
        .msg.user { color: #fff; opacity: 0.8; }
        
        .ai-tools { padding: 8px 10px; background: rgba(113, 78, 0, 0.1); border-top: 1px solid var(--amber-dim); font-size: 10px; position: relative; }
        
        .custom-select-trigger { 
            background: #000; color: var(--amber); border: 1px solid var(--amber-dim); 
            font-size: 10px; width: 100%; padding: 6px; cursor: pointer !important;
            display: flex; justify-content: space-between; align-items: center;
        }
        .custom-select-options {
            position: absolute; bottom: 100%; left: 10px; right: 10px; background: var(--panel-bg);
            border: 1px solid var(--amber); display: none; z-index: 600; max-height: 200px; overflow-y: auto;
        }
        .custom-select-options div { padding: 8px; border-bottom: 1px solid var(--amber-dim); cursor: pointer !important; }
        .custom-select-options div:hover { background: var(--amber); color: #000; }

        .ai-input-area { padding: 10px; background: rgba(0,0,0,0.3); border-top: 1px solid var(--amber-dim); display: flex; gap: 5px; }
        #ai-in { background: transparent; border: 1px solid var(--amber-dim); color: #fff; flex: 1; padding: 5px; outline: none; cursor: text !important; }
        .ai-btn { background: var(--amber-dim); color: #fff; border: none; padding: 5px 10px; cursor: pointer !important; font-size: 10px; }
        .ai-btn:hover { background: var(--amber); color: var(--bg); }

        .inject-btn { display: inline-block; margin-top: 8px; font-size: 9px; padding: 2px 6px; border: 1px solid var(--amber); cursor: pointer !important; color: var(--amber); }
        .inject-btn:hover { background: var(--amber); color: #000; }

        #ctx, #plugin-ctx, .custom-modal {
            position: fixed; display: none; background: var(--panel-bg);
            border: 2px solid var(--amber); z-index: 1000; min-width: 200px;
            box-shadow: 8px 8px 0px #000;
        }
        .opt { padding: 12px 15px; font-size: 12px; font-weight: bold; cursor: pointer !important; }
        .opt:hover { background: var(--amber); color: var(--bg); }
        .opt.disabled { opacity: 0.5; pointer-events: none; }

        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 2000; display: none;
            align-items: center; justify-content: center;
        }
        .custom-modal { display: block; position: relative; width: 320px; }
        .modal-body { padding: 20px; }
        .modal-input { width: 100%; background: #000; border: 1px solid var(--amber); color: #fff; padding: 8px; outline: none; font-family: inherit; margin-top: 10px; margin-bottom: 15px; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px; }
        
        .type-selector { display: flex; gap: 15px; margin-bottom: 10px; font-size: 11px; }
        .type-opt { cursor: pointer !important; display: flex; align-items: center; gap: 5px; }
        .type-opt input { cursor: pointer !important; accent-color: var(--amber); }
    </style>
</head>
<body>

<div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div style="display: flex; gap: 0px;">
            <div class="menu-btn" onclick="handleCtx(event, 10, 40)">FILE</div>
            <div class="menu-btn" onclick="saveZip()">ARCHIVE</div>
            <div class="menu-btn" onclick="clearTerm()">RESET</div>
        </div>
        <div style="text-shadow: 0 0 10px var(--amber);">IMMMOR</div>
    </div>
</div>

<div class="workspace">
    <aside class="panel" id="explorer">
        <div id="file-section" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
            <div class="p-head">
                <span>FILESYSTEM</span>
                <div class="ctrl-group">
                    <span class="ctrl" onclick="openModal()" title="NEW NODE">+</span>
                </div>
            </div>
            <div id="file-list"></div>
        </div>

        <div id="plugin-section">
            <div class="p-head">
                <span>PLUGINS</span>
                <div class="ctrl-group">
                    <span class="ctrl" onclick="openPluginModal()" title="ADD PLUGIN">+</span>
                </div>
            </div>
            <div id="plugin-list"></div>
        </div>
    </aside>

    <div class="divider-h" id="h-drag-left"></div>

    <div id="main-stack">
        <main class="panel" id="editor-p" style="flex:1">
            <div class="p-head">
                <span id="cur-filename">DATA_NODE.01</span>
                <span class="ctrl" onclick="toggleMax('editor-p')">◰</span>
            </div>
            <textarea id="editor" spellcheck="false" oninput="autoSave()"></textarea>
        </main>
        
        <div class="divider-v" id="v-drag"></div>

        <footer class="panel" id="terminal">
            <div class="p-head">
                <span>COMMAND</span>
                <div class="ctrl-group">
                    <span class="ctrl" onclick="addTerminal()">+</span>
                    <span class="ctrl" onclick="toggleMax('terminal')">◰</span>
                </div>
            </div>
            <div class="term-tabs" id="term-tabs"></div>
            <div id="term-container" style="flex:1; display:flex; flex-direction:column; overflow:hidden;"></div>
        </footer>
    </div>

    <div class="divider-h" id="h-drag-right"></div>

    <aside class="panel" id="ai-panel">
        <div class="p-head">
            <span>AI</span>
            <div class="ctrl-group">
                <span class="ctrl" onclick="openSettings()" title="CONFIG">⚙</span>
                <span class="ctrl" onclick="toggleMax('ai-panel')">◰</span>
            </div>
        </div>
        <div id="ai-chat">
            <div class="msg ai">SYSTEM: Neural connection established. Select context and query.</div>
        </div>
        <div class="ai-tools">
            <label style="display:block; margin-bottom:5px">CONTEXT_NODE:</label>
            <div class="custom-select-trigger" id="ai-ctx-trigger" onclick="toggleAiSelect()">
                <span id="ai-ctx-val">-- NO_CONTEXT --</span>
                <span>▼</span>
            </div>
            <div class="custom-select-options" id="ai-ctx-options"></div>
        </div>
        <div class="ai-input-area">
            <input type="text" id="ai-in" placeholder="Query..." autocomplete="off">
            <button class="ai-btn" onclick="sendAi()">SEND</button>
        </div>
    </aside>
</div>

<div id="ctx">
    <div class="opt" id="ctx-new-node" onclick="openModal()">[+] NEW_DATA_NODE</div>
    <div class="opt" id="ctx-rename" onclick="startRenameFromCtx()">[R] RENAME_NODE</div>
    <div class="opt" id="ctx-copy-path" onclick="copyPathFromCtx()">[C] COPY_PATH</div>
    <div style="border-top:1px solid var(--amber-dim); margin:4px 0;"></div>
    <div class="opt" onclick="saveActive()">DOWNLOAD_ACTIVE_NODE</div>
    <div class="opt" onclick="saveZip()">ARCHIVE_ALL_NODES</div>
    <div class="opt" onclick="clearTerm()">RESET_CONSOLE</div>
</div>

<div id="plugin-ctx">
    <div class="opt" onclick="startEditPlugin()">[E] EDIT_MODULE</div>
    <div class="opt" onclick="confirmDeletePlugin()" style="color:var(--term-red)">[X] UNINSTALL_MODULE</div>
</div>

<div id="modal-overlay" class="modal-overlay">
    <div class="custom-modal">
        <div class="p-head"><span id="modal-title">SYSTEM_PROMPT</span></div>
        <div class="modal-body" id="modal-content"></div>
    </div>
</div>

<script>
    let storage = JSON.parse(localStorage.getItem('ind_console_storage')) || {
        'PROTOCOL.txt': 'SYSTEM OVERRIDE: ACTIVE\nENCRYPTION: ENABLED',
        'script.js': 'console.log("Node WASM active");',
        'main.py': 'print("Python WASM initialized")'
    };
    let plugins = JSON.parse(localStorage.getItem('ind_console_plugins')) || [
        { 
            name: 'Matrix_Rain', 
            code: 'const canvas = document.createElement(\'canvas\');const ctx = canvas.getContext(\'2d\');canvas.id = \'matrix-canvas\';canvas.style.cssText = \'position:fixed;top:0;left:0;width:100%;height:100%;z-index:22;opacity:0.4;pointer-events:none;\';document.body.appendChild(canvas);let w = canvas.width = window.innerWidth;let h = canvas.height = window.innerHeight;const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ$+-*/=<>!%";const fontSize = 14;const columns = Math.floor(w / fontSize);const drops = new Array(columns).fill(1);function draw() { ctx.fillStyle = \'rgba(18, 16, 11, 0.05)\'; ctx.fillRect(0, 0, w, h); ctx.fillStyle = \'#ffb000\'; ctx.font = fontSize + \'px "Courier New"\'; for (let i = 0; i < drops.length; i++) { const text = chars[Math.floor(Math.random() * chars.length)]; ctx.fillText(text, i * fontSize, drops[i] * fontSize); if (drops[i] * fontSize > h && Math.random() > 0.975) drops[i] = 0; drops[i]++; } }const interval = setInterval(draw, 33);const resizeHandler = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };window.addEventListener(\'resize\', resizeHandler);return () => { clearInterval(interval); window.removeEventListener(\'resize\', resizeHandler); if (canvas.parentNode) canvas.parentNode.removeChild(canvas); };', 
            active: false 
        }
    ];
    let config = JSON.parse(localStorage.getItem('ind_console_config')) || {
        apiKey: '',
        apiBaseUrl: 'https://mrok.dpdns.org/v1'
    };
    let activeFile = localStorage.getItem('ind_console_active') || 'PROTOCOL.txt';
    let expandedDirs = JSON.parse(localStorage.getItem('ind_console_expanded')) || ['SYSTEM/'];
    let termCount = 0;
    let activeTermId = null;
    let selectedAiCtx = 'none';
    let pyodideInstance = null;
    let ctxTarget = null;
    let pluginCtxTarget = null; // 记录当前右键点击的插件索引

    // --- Plugins Logic ---
    function renderPlugins() {
        const list = document.getElementById('plugin-list');
        list.innerHTML = '';
        plugins.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = 'plugin-item';
            div.innerHTML = `
                <span>${p.name}</span>
                <div class="plugin-status ${p.active ? 'active' : ''}"></div>
            `;
            div.onclick = () => togglePlugin(index);
            div.oncontextmenu = (e) => {
                e.preventDefault();
                e.stopPropagation();
                pluginCtxTarget = index;
                showPluginCtx(e);
            };
            list.appendChild(div);
        });
    }

    function showPluginCtx(e) {
        const pCtx = document.getElementById('plugin-ctx');
        pCtx.style.display = 'block';
        pCtx.style.left = e.pageX + 'px';
        pCtx.style.top = e.pageY + 'px';
    }

    function startEditPlugin() {
        if (pluginCtxTarget === null) return;
        const p = plugins[pluginCtxTarget];
        document.getElementById('plugin-ctx').style.display = 'none';
        
        document.getElementById('modal-title').innerText = "EDIT_EXTERNAL_MODULE";
        document.getElementById('modal-content').innerHTML = `
            <input type="text" id="pl-name" class="modal-input" value="${p.name}">
            <textarea id="pl-code" class="modal-input" style="height:150px; resize:none" placeholder="JS_INJECTION_CODE">${p.code}</textarea>
            <div class="modal-btns">
                <button class="ai-btn" onclick="closeModal()">CANCEL</button>
                <button class="ai-btn" style="background:var(--amber); color:#000" onclick="confirmPluginEdit(${pluginCtxTarget})">UPDATE</button>
            </div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function confirmPluginEdit(index) {
        const name = document.getElementById('pl-name').value.trim();
        const code = document.getElementById('pl-code').value.trim();
        if(name && code) {
            plugins[index].name = name;
            plugins[index].code = code;
            savePlugins(); closeModal();
        }
    }

    function confirmDeletePlugin() {
        if (pluginCtxTarget === null) return;
        if(confirm(`UNINSTALL ${plugins[pluginCtxTarget].name}?`)) {
            plugins.splice(pluginCtxTarget, 1);
            savePlugins();
        }
        document.getElementById('plugin-ctx').style.display = 'none';
    }

    function togglePlugin(index) {
        plugins[index].active = !plugins[index].active;
        if (plugins[index].active) {
            try { 
                const pluginReturn = new Function(plugins[index].code)(); 
                plugins[index]._cleanup = typeof pluginReturn === 'function' ? pluginReturn : null;
            } catch(e) { console.error("PLUGIN_BOOT_ERR:", e); }
        } else {
            if (plugins[index]._cleanup) {
                plugins[index]._cleanup();
            } else {
                console.log("REBOOT_REQUIRED: Plugin state persists.");
            }
        }
        savePlugins();
    }

    function savePlugins() {
        localStorage.setItem('ind_console_plugins', JSON.stringify(plugins));
        renderPlugins();
    }

    function openPluginModal() {
        document.getElementById('modal-title').innerText = "INSTALL_EXTERNAL_MODULE";
        document.getElementById('modal-content').innerHTML = `
            <input type="text" id="pl-name" class="modal-input" placeholder="MODULE_NAME">
            <textarea id="pl-code" class="modal-input" style="height:150px; resize:none" placeholder="JS_INJECTION_CODE"></textarea>
            <div class="modal-btns">
                <button class="ai-btn" onclick="closeModal()">CANCEL</button>
                <button class="ai-btn" style="background:var(--amber); color:#000" onclick="confirmPlugin()">INSTALL</button>
            </div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function confirmPlugin() {
        const name = document.getElementById('pl-name').value.trim();
        const code = document.getElementById('pl-code').value.trim();
        if(name && code) {
            plugins.push({ name, code, active: false });
            savePlugins(); closeModal();
        }
    }

    // --- Core Logic ---
    async function initPython() {
        if (!pyodideInstance) pyodideInstance = await loadPyodide();
        return pyodideInstance;
    }

    function autoSave() {
        if (!activeFile.endsWith('/')) storage[activeFile] = document.getElementById('editor').value;
        localStorage.setItem('ind_console_storage', JSON.stringify(storage));
        localStorage.setItem('ind_console_active', activeFile);
        localStorage.setItem('ind_console_expanded', JSON.stringify(expandedDirs));
    }

    function initResizer(bar, target, isH, isRight = false) {
        let dragging = false;
        const start = () => { dragging = true; bar.classList.add('active'); };
        const stop = () => { dragging = false; bar.classList.remove('active'); };
        const move = (e) => {
            if (!dragging) return;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            if (isH) {
                let p = isRight ? 100 - (x / window.innerWidth) * 100 : (x / window.innerWidth) * 100;
                target.style.width = Math.min(Math.max(p, 0), 100) + '%';
            } else {
                let rect = document.getElementById('main-stack').getBoundingClientRect();
                let p = 100 - ((y - rect.top) / rect.height * 100);
                target.style.height = Math.min(Math.max(p, 0), 100) + '%';
            }
        };
        bar.addEventListener('mousedown', start);
        bar.addEventListener('touchstart', start);
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', stop);
    }

    function toggleMax(id) { document.getElementById(id).classList.toggle('maximized'); }

    function renderFiles() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        const sortedKeys = Object.keys(storage).sort((a,b) => {
            const aDir = a.includes('/') ? 0 : 1;
            const bDir = b.includes('/') ? 0 : 1;
            return aDir - bDir || a.localeCompare(b);
        });

        sortedKeys.forEach(k => {
            const isFolder = k.endsWith('/');
            const pathParts = k.split('/').filter(p => p);
            const depth = pathParts.length - 1;
            
            if (depth > 0) {
                let parentPath = "";
                for(let i=0; i<depth; i++) {
                    parentPath += pathParts[i] + "/";
                    if (!expandedDirs.includes(parentPath)) return;
                }
            }

            const div = document.createElement('div');
            div.className = `file-item ${k === activeFile ? 'active' : ''} ${isFolder ? 'folder' : ''}`;
            div.style.paddingLeft = (15 + depth * 15) + 'px';
            
            let iconStr = isFolder ? `<span class="file-icon ${expandedDirs.includes(k) ? 'open' : ''}">▶</span>` : '';
            const nameSpan = document.createElement('span');
            nameSpan.innerText = isFolder ? pathParts[pathParts.length-1] + '/' : pathParts[pathParts.length-1];
            
            div.innerHTML = iconStr;
            div.appendChild(nameSpan);
            
            div.onclick = () => {
                autoSave();
                activeFile = k; // 更新当前激活节点（以便新建操作定位）
                
                if (isFolder) {
                    if (expandedDirs.includes(k)) {
                        expandedDirs = expandedDirs.filter(d => d !== k);
                    } else {
                        expandedDirs.push(k);
                    }
                } else {
                    document.getElementById('editor').value = storage[k];
                    document.getElementById('cur-filename').innerText = k;
                }
                renderFiles(); // 重新渲染以应用 active 样式
            };
            
            div.oncontextmenu = (e) => {
                ctxTarget = { path: k, el: nameSpan, isFolder: isFolder };
                handleCtx(e);
            };
            list.appendChild(div);
        });
        updateAiCtxOptions();
    }

    function startRenameFromCtx() {
        if (!ctxTarget) return;
        document.getElementById('ctx').style.display = 'none';
        const { el, path, isFolder } = ctxTarget;
        const currentName = el.innerText.replace(/\/$/, '');
        const input = document.createElement('input');
        input.className = 'file-rename-input';
        input.value = currentName;
        el.parentNode.replaceChild(input, el);
        input.focus();
        input.onblur = () => {
            const newName = input.value.trim();
            if (newName && newName !== currentName) applyRename(path, newName, isFolder);
            else renderFiles();
        };
        input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); };
    }

    function applyRename(oldPath, newName, isFolder) {
        let newPath;
        const parts = oldPath.split('/');
        if (isFolder) {
            parts[parts.length - 2] = newName.replace(/\//g, '');
            newPath = parts.join('/');
            Object.keys(storage).forEach(key => {
                if (key.startsWith(oldPath)) {
                    storage[newPath + key.substring(oldPath.length)] = storage[key];
                    delete storage[key];
                }
            });
        } else {
            parts[parts.length - 1] = newName;
            newPath = parts.join('/');
            storage[newPath] = storage[oldPath];
            delete storage[oldPath];
        }
        if (activeFile === oldPath) activeFile = newPath;
        autoSave(); renderFiles();
    }

    function copyPathFromCtx() {
        if (ctxTarget) {
            navigator.clipboard.writeText(ctxTarget.path);
            document.getElementById('ctx').style.display = 'none';
        }
    }

    function updateAiCtxOptions() {
        const container = document.getElementById('ai-ctx-options');
        container.innerHTML = `<div onclick="selectAiCtx('none')">-- NO_CONTEXT --</div>`;
        Object.keys(storage).forEach(k => {
            if (!k.endsWith('/')) {
                const div = document.createElement('div');
                div.innerText = k;
                div.onclick = () => selectAiCtx(k);
                container.appendChild(div);
            }
        });
    }

    function selectAiCtx(val) {
        selectedAiCtx = val;
        document.getElementById('ai-ctx-val').innerText = val === 'none' ? '-- NO_CONTEXT --' : val;
        document.getElementById('ai-ctx-options').style.display = 'none';
    }

    function addTerminal() {
        const id = 'term-' + (++termCount);
        const tab = document.createElement('div');
        tab.className = 'term-tab'; tab.id = 'tab-' + id; tab.innerText = 'TERM_' + termCount;
        tab.onclick = () => switchTerminal(id);
        document.getElementById('term-tabs').appendChild(tab);
        const body = document.createElement('div');
        body.className = 'term-body'; body.id = id;
        body.innerHTML = `<div class="term-out">Terminal ${termCount} Ready.</div><div class="term-input-wrap"><span>>></span><input type="text" class="cmd-in" autocomplete="off" spellcheck="false"><button class="ai-btn" onclick="handleCommand('${id}')">SEND</button></div>`;
        body.querySelector('.cmd-in').onkeydown = (e) => { if(e.key === 'Enter') handleCommand(id); };
        document.getElementById('term-container').appendChild(body);
        switchTerminal(id);
    }

    function switchTerminal(id) {
        document.querySelectorAll('.term-tab, .term-body').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.getElementById(id).classList.add('active');
        activeTermId = id;
        document.getElementById(id).querySelector('.cmd-in').focus();
    }

    async function handleCommand(id) {
        const body = document.getElementById(id);
        const input = body.querySelector('.cmd-in');
        const output = body.querySelector('.term-out');
        const val = input.value.trim();
        if(!val) return;
        const log = (txt, color = 'rgba(255,176,0,0.8)') => {
            const d = document.createElement('div'); d.style.color = color; d.innerText = txt;
            output.appendChild(d); output.scrollTop = output.scrollHeight;
        };
        log(`>> ${val}`, '#fff');
        const args = val.split(' '), cmd = args[0].toLowerCase(), fileName = args[1];
        switch(cmd) {
            case 'ls': log(Object.keys(storage).join('    ')); break;
            case 'clear': output.innerHTML = ''; break;
            case 'node':
                try {
                    new Function('console', storage[fileName])({ log: (m) => log(m) });
                } catch (e) { log(`ERR: ${e.message}`, 'var(--term-red)'); }
                break;
            case 'python':
                const py = await initPython();
                py.setStdout({ batched: (str) => log(str, 'var(--term-green)') });
                await py.runPythonAsync(storage[fileName]);
                break;
            default: log(`ERR: UNKNOWN_CMD`, 'var(--term-red)');
        }
        input.value = '';
    }

    function openModal() {
        // 判定当前选中的节点，如果是文件夹则作为父目录，如果是文件则取其所在目录
        const isFolder = activeFile.endsWith('/');
        const parentDir = isFolder ? activeFile : (activeFile.includes('/') ? activeFile.substring(0, activeFile.lastIndexOf('/') + 1) : '');
        
        document.getElementById('modal-title').innerText = "NEW_NODE_CREATION";
        document.getElementById('modal-content').innerHTML = `
            <div style="font-size:9px; color:var(--amber-dim); margin-bottom:10px;">TARGET_PATH: ${parentDir || 'ROOT/'}</div>
            <div class="type-selector">
                <label class="type-opt"><input type="radio" name="ntype" value="file" checked> FILE</label>
                <label class="type-opt"><input type="radio" name="ntype" value="folder"> DIR</label>
            </div>
            <input type="text" id="modal-input" class="modal-input" placeholder="NAME" autocomplete="off">
            <div class="modal-btns">
                <button class="ai-btn" onclick="closeModal()">CANCEL</button>
                <button class="ai-btn" style="background:var(--amber); color:#000" onclick="confirmModal('${parentDir}')">CONFIRM</button>
            </div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('modal-input').focus();
    }

    function confirmModal(parentDir) {
        let name = document.getElementById('modal-input').value.trim();
        const type = document.querySelector('input[name="ntype"]:checked').value;
        if (name) {
            let finalPath = parentDir + name;
            if (type === 'folder') { 
                if (!finalPath.endsWith('/')) finalPath += '/'; 
                storage[finalPath] = "DIR"; 
                activeFile = finalPath; // 选中新目录
            } else { 
                storage[finalPath] = ""; // 新建文件内容为空
                activeFile = finalPath; // 自动切换到新文件
                document.getElementById('editor').value = ""; // 清空编辑器
                document.getElementById('cur-filename').innerText = finalPath;
            }
            renderFiles(); 
            autoSave(); 
            closeModal();
        }
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function toggleAiSelect() { const opt = document.getElementById('ai-ctx-options'); opt.style.display = opt.style.display === 'block' ? 'none' : 'block'; }
    
    function openSettings() {
        document.getElementById('modal-title').innerText = "NEURAL_LINK_CONFIG";
        document.getElementById('modal-content').innerHTML = `<div>URL:</div><input type="text" id="cfg-base" class="modal-input" value="${config.apiBaseUrl}"><div>KEY:</div><input type="password" id="cfg-key" class="modal-input" value="${config.apiKey}"><div class="modal-btns"><button class="ai-btn" onclick="closeModal()">CANCEL</button><button class="ai-btn" style="background:var(--amber); color:#000" onclick="saveSettings()">SAVE</button></div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function saveSettings() {
        config.apiBaseUrl = document.getElementById('cfg-base').value.trim(); 
        config.apiKey = document.getElementById('cfg-key').value.trim();
        localStorage.setItem('ind_console_config', JSON.stringify(config)); closeModal();
    }

    async function sendAi() {
        const input = document.getElementById('ai-in');
        const query = input.value.trim();
        if (!query || !config.apiKey) return;
        const chat = document.getElementById('ai-chat');
        const uMsg = document.createElement('div');
        uMsg.className = 'msg user'; uMsg.innerText = `[CTX:${selectedAiCtx}] > ${query}`;
        chat.appendChild(uMsg); input.value = '';
        const aiMsg = document.createElement('div');
        aiMsg.className = 'msg ai'; aiMsg.innerText = 'AI: connecting...';
        chat.appendChild(aiMsg); chat.scrollTop = chat.scrollHeight;
        try {
            let fullPrompt = selectedAiCtx !== 'none' ? `Context file ${selectedAiCtx}:\n${storage[selectedAiCtx]}\n\nQuery: ${query}` : query;
            const response = await fetch(`${config.apiBaseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
                body: JSON.stringify({ model: 'gemini-flash-latest', messages: [{ role: 'user', content: fullPrompt }] })
            });
            const data = await response.json();
            const reply = data.choices[0].message.content;
            aiMsg.innerText = 'AI: ' + reply;
            if (reply.includes('```')) {
                const btn = document.createElement('div');
                btn.className = 'inject-btn'; btn.innerText = '>> EXTRACT_CODE';
                btn.onclick = () => { 
                    const code = reply.split('```')[1].split('\n').slice(1).join('\n');
                    document.getElementById('editor').value += "\n" + code; autoSave(); 
                };
                aiMsg.appendChild(document.createElement('br')); aiMsg.appendChild(btn);
            }
        } catch (err) { aiMsg.innerText = `[OFFLINE] Error: ${err.message}`; }
    }

    function handleCtx(e, x, y) {
        e.preventDefault();
        const ctxMenu = document.getElementById('ctx');
        const isItem = e.target.closest('.file-item');
        document.getElementById('ctx-rename').classList.toggle('disabled', !isItem);
        document.getElementById('ctx-copy-path').classList.toggle('disabled', !isItem);
        ctxMenu.style.display = 'block'; ctxMenu.style.left = (x || e.pageX) + 'px'; ctxMenu.style.top = (y || e.pageY) + 'px';
    }

    async function saveZip() {
        const zip = new JSZip(); 
        Object.keys(storage).forEach(k => { if(!k.endsWith('/')) zip.file(k, storage[k]); });
        const b = await zip.generateAsync({type:"blob"}), a = document.createElement('a');
        a.href = URL.createObjectURL(b); a.download = "archive.zip"; a.click();
    }
    
    function saveActive() { 
        const b = new Blob([document.getElementById('editor').value], {type:'text/plain'}), a = document.createElement('a');
        a.href = URL.createObjectURL(b); a.download = activeFile.split('/').pop(); a.click(); 
    }
    
    function clearTerm() { if(activeTermId) document.getElementById(activeTermId).querySelector('.term-out').innerHTML = 'READY.'; }

    // --- Init ---
    initResizer(document.getElementById('h-drag-left'), document.getElementById('explorer'), true);
    initResizer(document.getElementById('h-drag-right'), document.getElementById('ai-panel'), true, true);
    initResizer(document.getElementById('v-drag'), document.getElementById('terminal'), false);
    
    document.addEventListener('click', (e) => { 
        if (!document.getElementById('ctx').contains(e.target)) document.getElementById('ctx').style.display = 'none'; 
        if (!document.getElementById('plugin-ctx').contains(e.target)) document.getElementById('plugin-ctx').style.display = 'none'; 
        if (!document.getElementById('ai-ctx-trigger').contains(e.target)) document.getElementById('ai-ctx-options').style.display = 'none';
    });
    document.getElementById('ai-in').onkeydown = (e) => { if(e.key === 'Enter') sendAi(); };

    renderFiles(); renderPlugins(); addTerminal();
    document.getElementById('editor').value = storage[activeFile] || "";
    document.getElementById('cur-filename').innerText = activeFile;
</script>
</body>
</html>