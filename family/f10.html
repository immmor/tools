<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>王氏家族宗谱·典藏版</title>
    <style>
        :root {
            --stone-bg: #e5e5e0; 
            --ink: #1a1a1a;
            --bronze: #8c6d46; 
            --border-heavy: #2c2c2c;
            --paper: #f9f7f2;
            --highlight: #c0392b;
            --seal-red: #b32f25;
        }

        body {
            background-color: #d6d6d0;
            background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png");
            margin: 0;
            padding: 20px 10px 80px 10px;
            font-family: "Noto Serif SC", "Source Han Serif SC", "SimSun", serif;
            color: var(--ink);
        }

        /* 顶部装饰印章 */
        .seal {
            position: absolute;
            top: 40px;
            right: 40px;
            width: 60px;
            height: 60px;
            border: 3px solid var(--seal-red);
            color: var(--seal-red);
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            padding: 5px;
            opacity: 0.8;
            transform: rotate(5deg);
            border-radius: 3px;
            user-select: none;
        }

        .ancestral-shrine {
            max-width: 800px;
            margin: 0 auto;
            border: 8px double var(--border-heavy);
            padding: 50px 30px;
            background: var(--stone-bg);
            box-shadow: 0 25px 60px rgba(0,0,0,0.4);
            position: relative;
            min-height: 800px;
        }

        /* 顶部工具栏 */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .search-container {
            flex: 1;
        }

        .search-input {
            background: var(--paper);
            border: 1px solid var(--bronze);
            padding: 10px 15px;
            width: 90%;
            font-family: inherit;
            outline: none;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn-export {
            background: var(--border-heavy);
            color: var(--paper);
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-family: inherit;
            transition: 0.3s;
        }

        .btn-export:hover { background: var(--bronze); }

        /* 碑首 */
        .shrine-header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid var(--bronze);
            padding-bottom: 25px;
        }

        .shrine-header h1 {
            font-size: 64px;
            letter-spacing: 20px;
            margin: 0;
            font-weight: 900;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .family-info-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 13px;
            color: var(--bronze);
            font-weight: bold;
        }

        /* 树状结构 */
        #genealogy-tree {
            padding-left: 0;
        }

        ul {
            list-style: none;
            padding-left: 40px;
            margin: 0;
            position: relative;
        }

        li {
            position: relative;
            padding: 10px 0;
        }

        /* 连接线 */
        li::before {
            content: "";
            position: absolute;
            left: -20px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: var(--bronze);
            opacity: 0.5;
        }

        li:last-child::before { height: 32px; }

        /* 节点主体 */
        .tablet-node {
            background: var(--paper);
            border: 1px solid #d1d1c1;
            border-left: 8px solid var(--border-heavy);
            padding: 15px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            position: relative;
        }

        .tablet-node:hover {
            transform: translateX(12px);
            border-color: var(--bronze);
            box-shadow: 8px 8px 20px rgba(0,0,0,0.1);
        }

        /* 辈分色标（根据代数自动染色） */
        .gen-1 { border-left-color: #2c3e50; }
        .gen-2 { border-left-color: #34495e; }
        .gen-3 { border-left-color: #7f8c8d; }

        .search-match {
            border-left-color: var(--highlight) !important;
            background: #fff8f8 !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(192, 57, 43, 0); }
            100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); }
        }

        .avatar-box {
            width: 55px;
            height: 55px;
            border-radius: 4px; /* 改为方印状 */
            border: 1px solid var(--bronze);
            margin-right: 18px;
            overflow: hidden;
            background: #f0ede5;
            flex-shrink: 0;
        }

        .avatar-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: grayscale(0.8) sepia(0.3);
        }

        .name-area { flex: 1; }
        .full-name { font-size: 20px; font-weight: bold; color: #000; display: block; }
        .life-info { font-size: 13px; color: #666; margin-top: 5px; display: block; }

        .rank-tag {
            writing-mode: vertical-rl;
            font-size: 12px;
            color: var(--bronze);
            border-left: 1px solid #eee;
            padding: 5px 0 5px 10px;
            margin-left: 10px;
            height: 50px;
            display: flex;
            align-items: center;
            letter-spacing: 2px;
        }

        /* 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-card {
            background: var(--paper);
            width: 400px;
            padding: 30px;
            border: 10px double var(--bronze);
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .modal-close {
            position: absolute;
            top: 10px; right: 10px;
            cursor: pointer;
            font-size: 24px;
        }

        /* 响应式 */
        @media (max-width: 600px) {
            .shrine-header h1 { font-size: 40px; letter-spacing: 10px; }
            .tablet-node { padding: 10px; }
            .full-name { font-size: 16px; }
        }

        .sub-descendants { display: none; }
        .expanded > .sub-descendants { display: block; }

        .corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid var(--bronze);
            z-index: 10;
            pointer-events: none;
        }
        .tl { top: 15px; left: 15px; border-right: none; border-bottom: none; }
        .tr { top: 15px; right: 15px; border-left: none; border-bottom: none; }
        .bl { bottom: 15px; left: 15px; border-right: none; border-top: none; }
        .br { bottom: 15px; right: 15px; border-left: none; border-top: none; }
    </style>
</head>
<body>

<div class="ancestral-shrine">
    <div class="seal">王氏宗親</div>
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>

    <div class="shrine-header">
        <h1>王氏族譜</h1>
        <div id="stats" class="family-info-bar">
            <span id="stat-count">族员：加载中...</span>
            <span id="stat-gen">世系：加载中...</span>
        </div>
    </div>

    <div class="toolbar">
        <div class="search-container">
            <input type="text" id="memberSearch" class="search-input" placeholder="输入姓名或事迹搜索...">
        </div>
    </div>

    <div id="tree-container">
        <ul id="genealogy-tree"></ul>
    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal-card">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h2 id="modalName" style="margin-top:0; border-bottom:2px solid var(--bronze)">姓名</h2>
        <p id="modalMeta" style="color:var(--highlight); font-weight:bold"></p>
        <p id="modalBio" style="line-height:1.8; text-align:justify; height: 150px; overflow-y: auto;">
            暂无详细生平记载。据传此支脉族人秉承“耕读传家”之祖训，在当地颇有声望。
        </p>
        <div style="text-align: right; color: var(--bronze); font-size: 12px; border-top: 1px solid #ddd; padding-top: 10px;">
            —— 岁次乙巳年 敬立
        </div>
    </div>
</div>

<script>
    const familyData = [
        {
            name: "王公諱世傑",
            meta: "第一世 · 始遷祖 · 配李氏",
            rank: "正本清源",
            bio: "始祖世杰公，明初由山西洪洞大槐树迁入，定居青州。公生性淳厚，勤于农桑，开创了王氏百年基业。",
            children: [
                {
                    name: "王公諱繼先",
                    meta: "第二世 · 長房 · 宣德年间生",
                    rank: "枝繁葉茂",
                    children: [
                        {
                            name: "王公諱紹寬",
                            meta: "第三世 · 庠生 · 承嗣",
                            rank: "克紹箕裘",
                            children: []
                        },
                        {
                            name: "王公諱紹敏",
                            meta: "第三世 · 居城南",
                            rank: "兰馨桂馥",
                            children: []
                        }
                    ]
                },
                {
                    name: "王公諱繼德",
                    meta: "第二世 · 次房 · 居永安",
                    rank: "德厚流光",
                    children: [
                        {
                            name: "王公諱紹严",
                            meta: "第三世 · 岁贡生",
                            rank: "光宗耀祖",
                            children: []
                        }
                    ]
                }
            ]
        }
    ];

    let memberCount = 0;
    let maxGen = 0;
    const defaultAvatar = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2NjYyIgZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDIgMnp6bTAgM2MyLjIxIDAgNCAxLjc5IDQgNHMtMS43OSA0LTQgNC00LTEuNzktNC00IDEuNzktNCA0LTR6bTAgMTMuOTFjLTIuNTEgMC00LjczLTEuMjgtNS44Ni0zLjI0LjA4LTEuOTQgMy45OC0zIDUuODYtMyA0LjgyIDAgOC43OSAxLjA2IDguODYgM3YtLjA2Yy0xLjEzIDEuOTYtMy4zNSAzLjI0LTUuODYgMy4yNHoiLz48L3N2Zz4=";

    function renderTree(data, container, level = 1) {
        if (level > maxGen) maxGen = level;
        
        data.forEach(person => {
            memberCount++;
            const li = document.createElement('li');
            const hasChildren = person.children && person.children.length > 0;
            li.className = `item ${hasChildren ? 'has-children expanded' : ''}`;
            
            li.innerHTML = `
                <div class="tablet-node gen-${level}" data-name="${person.name}" data-bio="${person.bio || ''}">
                    <div class="avatar-box">
                        <img src="${person.avatar || defaultAvatar}" alt="头像">
                    </div>
                    <div class="name-area">
                        <span class="full-name">${person.name}</span>
                        <span class="life-info">${person.meta}</span>
                    </div>
                    <div class="rank-tag">${person.rank}</div>
                </div>
                ${hasChildren ? '<ul class="sub-descendants"></ul>' : ''}
            `;

            // 点击逻辑：区分折叠和查看详情
            const node = li.querySelector('.tablet-node');
            node.addEventListener('click', (e) => {
                // 点击头像或文字区域弹出详情
                if (e.target.closest('.name-area') || e.target.closest('.avatar-box')) {
                    showDetails(person);
                } else if (hasChildren) {
                    // 点击其余区域折叠
                    li.classList.toggle('expanded');
                }
            });

            if (hasChildren) {
                renderTree(person.children, li.querySelector('.sub-descendants'), level + 1);
            }
            container.appendChild(li);
        });
    }

    // 详情弹窗逻辑
    function showDetails(person) {
        document.getElementById('modalName').innerText = person.name;
        document.getElementById('modalMeta').innerText = person.meta;
        if(person.bio) document.getElementById('modalBio').innerText = person.bio;
        document.getElementById('detailModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('detailModal').style.display = 'none';
    }

    // 搜索功能（优化：支持模糊匹配元数据）
    document.getElementById('memberSearch').addEventListener('input', function(e) {
        const keyword = e.target.value.trim();
        const allNodes = document.querySelectorAll('.tablet-node');
        
        allNodes.forEach(node => {
            const content = node.innerText;
            if (keyword && content.includes(keyword)) {
                node.classList.add('search-match');
                expandParents(node);
            } else {
                node.classList.remove('search-match');
            }
        });
    });

    function expandParents(node) {
        let parent = node.parentElement.closest('.item');
        while (parent) {
            parent.classList.add('expanded');
            parent = parent.parentElement.closest('.item');
        }
    }

    // 初始化
    const treeRoot = document.getElementById('genealogy-tree');
    renderTree(familyData, treeRoot);
    
    document.getElementById('stat-count').innerText = `族员：${memberCount} 位`;
    document.getElementById('stat-gen').innerText = `世系：${maxGen} 代`;

    // 点击弹窗外部关闭
    window.onclick = function(event) {
        const modal = document.getElementById('detailModal');
        if (event.target == modal) closeModal();
    }
</script>

</body>
</html>