<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>immmor PS TITAN AI Max | 极客全设备响应版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        body { background: #020203; color: #e2e8f0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        
        /* 响应式布局：PC 4列，手机 1列 */
        .ps-layout { 
            display: grid; 
            grid-template-columns: 60px 280px 1fr 300px; 
            grid-template-rows: 50px 1fr; 
            height: 100vh; 
        }

        @media (max-width: 1024px) {
            .ps-layout {
                grid-template-columns: 50px 1fr; /* 手机端隐藏属性面板和图层面板 */
                grid-template-rows: 50px 1fr 60px; /* 增加底部操作栏 */
            }
            .sidebar-right, .sidebar-layers { display: none !important; }
            .mobile-bottom-bar { display: flex !important; }
        }

        .glass-panel { background: rgba(10, 10, 15, 0.98); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .tool-btn { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: 0.2s; color: #475569; position: relative; cursor: pointer; }
        .tool-btn.active { background: #3b82f6; color: white; }
        
        .canvas-area { background-color: #080808; background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 30px 30px; position: relative; overflow: hidden; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        
        /* 隐藏滚动条 */
        ::-webkit-scrollbar { width: 0; background: transparent; }
        
        /* 移动端浮动控制面板 */
        .mobile-float-panel { position: absolute; bottom: 80px; left: 10px; right: 10px; background: rgba(15,15,20,0.95); border-radius: 16px; padding: 15px; display: none; z-index: 100; border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-blue-500 mb-4"></div>
    <p class="text-blue-400 font-mono text-xs tracking-widest">AI VISION ENGINE LOADING...</p>
</div>

<div class="ps-layout">
    <header class="col-span-full glass-panel flex items-center px-4 md:px-6 justify-between border-b border-white/5 z-50">
        <div class="flex items-center space-x-4">
            <span class="font-black italic text-blue-500 text-xl tracking-tighter">im.PS AI</span>
            <div class="hidden md:flex space-x-6 text-[10px] uppercase font-bold tracking-widest text-gray-500">
                <button onclick="document.getElementById('fileInput').click()" class="hover:text-blue-400">Open</button>
                <button onclick="downloadImage()" class="text-blue-500">Export</button>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <button onclick="undo()" class="p-2 hover:text-blue-400"><i data-lucide="undo-2" class="w-4"></i></button>
            <button onclick="redo()" class="p-2 hover:text-blue-400"><i data-lucide="redo-2" class="w-4"></i></button>
            <button class="md:hidden p-2 text-white" onclick="toggleMobilePanel()"><i data-lucide="settings-2" class="w-4"></i></button>
        </div>
    </header>

    <aside class="glass-panel flex flex-col items-center py-4 border-r border-white/5 space-y-2 z-40">
        <button class="tool-btn active" id="tool-v" onclick="setMode('select')"><i data-lucide="mouse-pointer-2" class="w-5"></i></button>
        <button class="tool-btn" onclick="addRect()"><i data-lucide="square" class="w-5"></i></button>
        <button class="tool-btn" onclick="addText()"><i data-lucide="type" class="w-5"></i></button>
        <button class="tool-btn" id="tool-b" onclick="toggleDrawing()"><i data-lucide="paintbrush" class="w-5"></i></button>
        <button class="tool-btn text-purple-400" onclick="removeBackgroundAI()"><i data-lucide="sparkles" class="w-5"></i></button>
        <div class="w-6 h-[1px] bg-gray-800 my-2"></div>
        <button class="tool-btn text-red-500" onclick="deleteSelected()"><i data-lucide="trash-2" class="w-5"></i></button>
    </aside>

    <aside class="sidebar-right glass-panel p-6 border-r border-white/5 space-y-8 overflow-y-auto hidden lg:block">
        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">样式 Appearance</h3>
            <div class="space-y-4 text-xs">
                <div class="flex justify-between items-center">
                    <span>Opacity</span>
                    <input type="range" id="opacity" min="0" max="1" step="0.01" value="1" oninput="updateStyle()" class="w-32">
                </div>
                <div class="flex justify-between items-center">
                    <span>Color</span>
                    <input type="color" id="fill-color" oninput="updateStyle()" class="bg-transparent w-8 h-8">
                </div>
            </div>
        </section>
        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">混合模式 Blending</h3>
            <select id="blend-mode" class="w-full bg-white/5 text-[11px] p-3 rounded border-none outline-none" onchange="updateStyle()">
                <option value="source-over">Normal</option>
                <option value="multiply">Multiply</option>
                <option value="screen">Screen</option>
                <option value="overlay">Overlay</option>
            </select>
        </section>
    </aside>

    <main class="canvas-area flex items-center justify-center">
        <canvas id="main-canvas"></canvas>
        <input type="file" id="fileInput" class="hidden">
        
        <div id="mobile-panel" class="mobile-float-panel glass-panel">
            <div class="flex justify-between mb-4"><span class="text-xs font-bold text-blue-500">快速设置</span><button onclick="toggleMobilePanel()">×</button></div>
            <div class="space-y-4">
                <input type="range" id="mob-opacity" min="0" max="1" step="0.01" value="1" oninput="updateStyle(true)" class="w-full">
                <div class="flex gap-2">
                    <button onclick="downloadImage()" class="flex-1 py-2 bg-blue-600 rounded text-xs">导出作品</button>
                    <button onclick="document.getElementById('fileInput').click()" class="flex-1 py-2 bg-white/10 rounded text-xs">导入图片</button>
                </div>
            </div>
        </div>

        <div class="absolute bottom-4 left-4 bg-black/40 backdrop-blur px-3 py-1 rounded-full text-[9px] font-mono text-gray-400 md:block hidden">
            SPACE + DRAG TO PAN | PINCH TO ZOOM
        </div>
    </main>

    <aside class="sidebar-layers glass-panel border-l border-white/5 p-4 hidden lg:block">
        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">图层 Layers</h3>
        <div id="layer-stack" class="space-y-1"></div>
    </aside>

    <footer class="mobile-bottom-bar fixed bottom-0 left-0 right-0 h-[60px] glass-panel border-t border-white/5 px-6 flex items-center justify-between lg:hidden z-50">
        <button onclick="document.getElementById('fileInput').click()" class="text-gray-400"><i data-lucide="plus-circle"></i></button>
        <button onclick="setMode('select')" class="text-blue-400"><i data-lucide="mouse-pointer-2"></i></button>
        <button onclick="removeBackgroundAI()" class="text-purple-400"><i data-lucide="sparkles"></i></button>
        <button onclick="downloadImage()" class="text-green-400"><i data-lucide="download"></i></button>
    </footer>
</div>

<script>
    // 1. 初始化核心（加入响应式宽度）
    const canvas = new fabric.Canvas('main-canvas', {
        width: window.innerWidth > 1024 ? 900 : window.innerWidth - 60,
        height: window.innerHeight - 150,
        backgroundColor: '#080808',
        preserveObjectStacking: true
    });

    let history = [];
    let mods = 0;
    lucide.createIcons();

    // 2. AI 抠图引擎
    const selfieSegmentation = new SelfieSegmentation({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
    });
    selfieSegmentation.setOptions({ modelSelection: 1 });
    selfieSegmentation.onResults(onAIResults);

    async function removeBackgroundAI() {
        const obj = canvas.getActiveObject();
        if (!obj || obj.type !== 'image') return alert("请先选中一张图片");
        document.getElementById('loader').style.display = 'flex';
        await selfieSegmentation.send({ image: obj._element });
    }

    function onAIResults(results) {
        const temp = document.createElement('canvas');
        temp.width = results.image.width; temp.height = results.image.height;
        const ctx = temp.getContext('2d');
        ctx.drawImage(results.segmentationMask, 0, 0, temp.width, temp.height);
        ctx.globalCompositeOperation = 'source-in';
        ctx.drawImage(results.image, 0, 0, temp.width, temp.height);

        fabric.Image.fromURL(temp.toDataURL(), (newImg) => {
            const old = canvas.getActiveObject();
            newImg.set({ left: old.left, top: old.top, scaleX: old.scaleX, scaleY: old.scaleY });
            canvas.remove(old).add(newImg).setActiveObject(newImg);
            document.getElementById('loader').style.display = 'none';
            saveHistory(); renderLayers();
        });
    }

    // 3. 基础功能整合
    function addRect() { addObject(new fabric.Rect({ left: 50, top: 50, fill: '#3b82f6', width: 100, height: 100 })); }
    function addText() { addObject(new fabric.IText('TITAN AI', { left: 50, top: 50, fill: '#fff', fontSize: 30 })); }
    
    function addObject(obj) {
        obj.set({ cornerColor: '#3b82f6', cornerSize: 12, transparentCorners: false });
        canvas.add(obj).setActiveObject(obj);
        saveHistory(); renderLayers();
    }

    function updateStyle(isMobile = false) {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        const op = document.getElementById(isMobile ? 'mob-opacity' : 'opacity').value;
        obj.set({
            fill: document.getElementById('fill-color').value,
            opacity: parseFloat(op)
        });
        canvas.renderAll();
    }

    // 4. 移动端 UI 切换
    function toggleMobilePanel() {
        const p = document.getElementById('mobile-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }

    // 5. 交互交互 (适配 PC 和 移动端)
    canvas.on('mouse:wheel', function(opt) {
        let zoom = canvas.getZoom() * (0.999 ** opt.e.deltaY);
        canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
        opt.e.preventDefault();
    });

    // 空格键/单指平移逻辑
    let isPanning = false;
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') isPanning = true; });
    window.addEventListener('keyup', (e) => { if(e.code === 'Space') isPanning = false; });
    canvas.on('mouse:move', (opt) => {
        if (isPanning && opt.e) canvas.relativePan(new fabric.Point(opt.e.movementX, opt.e.movementY));
    });

    // 6. 系统辅助
    function saveHistory() {
        if(mods < history.length) history = history.slice(0, mods);
        history.push(JSON.stringify(canvas)); mods++;
    }
    function undo() { if(mods > 1) { mods--; canvas.loadFromJSON(history[mods-1], () => canvas.renderAll()); } }
    function redo() { if(mods < history.length) { canvas.loadFromJSON(history[mods], () => canvas.renderAll()); mods++; } }

    function renderLayers() {
        const stack = document.getElementById('layer-stack');
        if (!stack) return;
        stack.innerHTML = '';
        canvas.getObjects().reverse().forEach((obj) => {
            const div = document.createElement('div');
            div.className = `layer-item flex items-center p-3 text-[10px] cursor-pointer bg-white/5 ${canvas.getActiveObject() === obj ? 'active' : ''}`;
            div.innerHTML = `LAYER: ${obj.type.toUpperCase()}`;
            div.onclick = () => { canvas.setActiveObject(obj); canvas.renderAll(); renderLayers(); };
            stack.appendChild(div);
        });
    }

    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => fabric.Image.fromURL(f.target.result, img => addObject(img.scaleToWidth(canvas.width*0.8)));
        reader.readAsDataURL(e.target.files[0]);
    };

    function downloadImage() {
        const link = document.createElement('a');
        link.download = 'titan-mobile.png';
        link.href = canvas.toDataURL({ format: 'png' });
        link.click();
    }

    function deleteSelected() { canvas.remove(...canvas.getActiveObjects()); canvas.discardActiveObject(); renderLayers(); }
    
    // 初始化自适应
    window.addEventListener('resize', () => {
        canvas.setDimensions({ width: window.innerWidth > 1024 ? 900 : window.innerWidth - 60, height: window.innerHeight - 150 });
    });
</script>
</body>
</html>