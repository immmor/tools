<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>immmor Photoshop TITAN | 极客全功能图像旗舰版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background: #030303; color: #e2e8f0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .ps-layout { display: grid; grid-template-columns: 60px 280px 1fr 300px; grid-template-rows: 50px 1fr; height: 100vh; }
        .glass-panel { background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.04); }
        .tool-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 12px; transition: 0.2s; color: #475569; margin-bottom: 6px; position: relative; }
        .tool-btn:hover, .tool-btn.active { background: #3b82f6; color: white; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .canvas-area { background-color: #080808; background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 30px 30px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        input[type=range] { appearance: none; background: #1e293b; height: 3px; border-radius: 2px; width: 100%; }
        input[type=range]::-webkit-slider-thumb { appearance: none; height: 10px; width: 10px; border-radius: 50%; background: #3b82f6; cursor: pointer; }
        .layer-item { transition: 0.2s; border: 1px solid transparent; }
        .layer-item.active { border: 1px solid rgba(59, 130, 246, 0.5); background: rgba(59, 130, 246, 0.1); }
        .panel-title { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 12px; display: flex; justify-content: space-between; }
        .shortcut-tip { position: absolute; left: 50px; background: #1e293b; padding: 2px 6px; border-radius: 4px; font-size: 10px; opacity: 0; pointer-events: none; transition: 0.2s; }
        .tool-btn:hover .shortcut-tip { opacity: 1; }
    </style>
</head>
<body>

<div class="ps-layout">
    <header class="col-span-4 glass-panel flex items-center px-6 justify-between border-b border-white/5">
        <div class="flex items-center space-x-8">
            <span class="font-black italic text-blue-500 text-2xl tracking-tighter">im.PS TITAN</span>
            <div class="flex space-x-6 text-[10px] uppercase font-bold tracking-widest text-gray-500">
                <button onclick="document.getElementById('fileInput').click()" class="hover:text-blue-400">Open</button>
                <button onclick="exportProject()" class="hover:text-blue-400">Save Project (JSON)</button>
                <button onclick="downloadImage()" class="text-blue-500 hover:scale-105 transition">Export Final</button>
            </div>
        </div>
        <div class="flex items-center space-x-4 bg-white/5 px-4 py-1.5 rounded-full">
            <button onclick="undo()" title="Undo (Ctrl+Z)"><i data-lucide="undo-2" class="w-4"></i></button>
            <button onclick="redo()" title="Redo (Ctrl+Y)"><i data-lucide="redo-2" class="w-4"></i></button>
            <div class="w-px h-4 bg-gray-700 mx-2"></div>
            <button onclick="toggleFullscreen()"><i data-lucide="maximize" class="w-4"></i></button>
        </div>
    </header>

    <aside class="glass-panel flex flex-col items-center py-6 border-r border-white/5">
        <button class="tool-btn active" id="btn-select" onclick="setMode('select')"><i data-lucide="mouse-pointer-2"></i><span class="shortcut-tip">V</span></button>
        <button class="tool-btn" onclick="addRect()"><i data-lucide="square"></i><span class="shortcut-tip">R</span></button>
        <button class="tool-btn" onclick="addCircle()"><i data-lucide="circle"></i><span class="shortcut-tip">C</span></button>
        <button class="tool-btn" onclick="addPath()"><i data-lucide="pen-tool"></i><span class="shortcut-tip">P</span></button>
        <button class="tool-btn" onclick="addText()"><i data-lucide="type"></i><span class="shortcut-tip">T</span></button>
        <button class="tool-btn" id="btn-brush" onclick="toggleDrawing()"><i data-lucide="paintbrush"></i><span class="shortcut-tip">B</span></button>
        <div class="w-8 h-[1px] bg-gray-800 my-4"></div>
        <button class="tool-btn" onclick="groupObjects()"><i data-lucide="group"></i><span class="shortcut-tip">Ctrl+G</span></button>
        <button class="tool-btn text-red-500/80 hover:text-red-400" onclick="deleteSelected()"><i data-lucide="trash-2"></i></button>
    </aside>

    <aside class="glass-panel p-6 border-r border-white/5 space-y-8 overflow-y-auto">
        <section>
            <div class="panel-title">对齐 Alignment</div>
            <div class="grid grid-cols-4 gap-2">
                <button onclick="align('left')" class="p-2 bg-white/5 rounded hover:bg-white/10 flex justify-center"><i data-lucide="align-left" class="w-4"></i></button>
                <button onclick="align('center')" class="p-2 bg-white/5 rounded hover:bg-white/10 flex justify-center"><i data-lucide="align-center" class="w-4"></i></button>
                <button onclick="align('right')" class="p-2 bg-white/5 rounded hover:bg-white/10 flex justify-center"><i data-lucide="align-right" class="w-4"></i></button>
                <button onclick="changeZIndex('top')" class="p-2 bg-white/5 rounded hover:bg-white/10 flex justify-center"><i data-lucide="chevrons-up" class="w-4"></i></button>
            </div>
        </section>

        <section>
            <div class="panel-title">颜色与渐变 Color & Fill</div>
            <div class="space-y-4">
                <input type="color" id="fill-color" class="w-full h-10 bg-transparent rounded cursor-pointer" oninput="updateStyle()">
                <button onclick="applyGradient()" class="w-full py-2 bg-blue-600/20 text-blue-400 rounded text-[11px] font-bold">应用线性渐变</button>
            </div>
        </section>

        <section>
            <div class="panel-title">高级控制 Advanced</div>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-[11px] mb-2">画笔粗细 <span id="brush-val">5</span></div>
                    <input type="range" id="brush-width" min="1" max="100" value="5" oninput="updateBrush()">
                </div>
                <div>
                    <div class="flex justify-between text-[11px] mb-2">不透明度 <span id="op-val">100%</span></div>
                    <input type="range" id="opacity" min="0" max="1" step="0.01" value="1" oninput="updateStyle()">
                </div>
            </div>
        </section>

        <section>
            <div class="panel-title">混合模式 Blend Mode</div>
            <select id="blend-mode" class="w-full bg-white/5 text-xs p-3 rounded border-none outline-none" onchange="updateStyle()">
                <option value="source-over">正常 (Normal)</option>
                <option value="multiply">正片叠底 (Multiply)</option>
                <option value="screen">滤色 (Screen)</option>
                <option value="overlay">叠加 (Overlay)</option>
                <option value="difference">差值 (Difference)</option>
            </select>
        </section>
    </aside>

    <main class="canvas-area" id="canvas-wrapper">
        <canvas id="titan-canvas"></canvas>
        <input type="file" id="fileInput" class="hidden">
        
        <div class="absolute bottom-6 left-6 bg-white/10 backdrop-blur-md px-4 py-2 rounded-full text-[10px] font-mono tracking-widest text-gray-300 border border-white/5">
            ZOOM: <span id="zoom-val">100%</span> | PAN: SPACE + DRAG
        </div>
    </main>

    <aside class="glass-panel border-l border-white/5 p-4 flex flex-col">
        <div class="panel-title">图层 Layers <button onclick="renderLayers()"><i data-lucide="rotate-cw" class="w-3"></i></button></div>
        <div id="layer-stack" class="flex-1 space-y-2 overflow-y-auto pr-1"></div>
        <div class="mt-4 pt-4 border-t border-white/5">
            <button onclick="lockLayer()" class="w-full py-2 bg-white/5 rounded text-[10px] uppercase tracking-tighter hover:bg-red-500/20 transition">锁定/解锁 选中图层</button>
        </div>
    </aside>
</div>

<script>
    // 1. 初始化核心
    const canvas = new fabric.Canvas('titan-canvas', {
        width: 1000, height: 750,
        backgroundColor: '#080808',
        preserveObjectStacking: true,
        stopContextMenu: true
    });

    let history = [];
    let mods = 0;
    lucide.createIcons();

    // 2. 基础添加功能
    function addRect() { addObject(new fabric.Rect({ left: 100, top: 100, fill: '#3b82f6', width: 100, height: 100 })); }
    function addCircle() { addObject(new fabric.Circle({ left: 150, top: 150, fill: '#f472b6', radius: 50 })); }
    function addText() { addObject(new fabric.IText('TITAN TEXT', { left: 100, top: 100, fill: '#fff', fontSize: 40, fontFamily: 'sans-serif' })); }
    function addPath() { 
        // 简单的示例路径（心形）
        const path = new fabric.Path('M 0 0 L 50 50 L 100 0 Z');
        path.set({ left: 100, top: 100, fill: '#10b981' });
        addObject(path);
    }

    function addObject(obj) {
        obj.set({ cornerColor: '#3b82f6', cornerSize: 8, transparentCorners: false });
        canvas.add(obj);
        canvas.setActiveObject(obj);
        saveHistory();
        renderLayers();
    }

    // 3. 样式 & 渐变
    function updateStyle() {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        const opacity = document.getElementById('opacity').value;
        obj.set({
            fill: document.getElementById('fill-color').value,
            opacity: parseFloat(opacity),
            globalCompositeOperation: document.getElementById('blend-mode').value
        });
        document.getElementById('op-val').innerText = Math.round(opacity*100)+'%';
        canvas.renderAll();
    }

    function applyGradient() {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        obj.setGradient('fill', {
            x1: 0, y1: 0, x2: obj.width, y2: 0,
            colorStops: { 0: "#3b82f6", 1: "#f472b6" }
        });
        canvas.renderAll();
    }

    // 4. 对齐功能
    function align(type) {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        if(type === 'left') obj.set('left', 0);
        if(type === 'center') canvas.centerObject(obj);
        if(type === 'right') obj.set('left', canvas.width - obj.width * obj.scaleX);
        canvas.renderAll();
    }

    // 5. 分组与锁定
    function groupObjects() {
        if (!canvas.getActiveObject() || canvas.getActiveObject().type !== 'activeSelection') return;
        canvas.getActiveObject().toGroup();
        canvas.requestRenderAll();
        renderLayers();
    }

    function lockLayer() {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        obj.selectable = !obj.selectable;
        obj.evented = obj.selectable;
        obj.set('opacity', obj.selectable ? 1 : 0.5);
        canvas.discardActiveObject().renderAll();
    }

    // 6. 交互引擎 (缩放 & 平移)
    canvas.on('mouse:wheel', function(opt) {
        let delta = opt.e.deltaY;
        let zoom = canvas.getZoom();
        zoom *= 0.999 ** delta;
        canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
        document.getElementById('zoom-val').innerText = Math.round(zoom * 100) + '%';
        opt.e.preventDefault();
    });

    // 空格键平移实现
    let isPanning = false;
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') isPanning = true; });
    window.addEventListener('keyup', (e) => { if(e.code === 'Space') isPanning = false; });
    canvas.on('mouse:move', function(opt) {
        if (isPanning && opt.e) {
            canvas.relativePan(new fabric.Point(opt.e.movementX, opt.e.movementY));
        }
    });

    // 7. 画笔调节
    function toggleDrawing() {
        canvas.isDrawingMode = !canvas.isDrawingMode;
        document.getElementById('btn-brush').classList.toggle('active');
        updateBrush();
    }
    function updateBrush() {
        if(!canvas.freeDrawingBrush) return;
        const w = document.getElementById('brush-width').value;
        canvas.freeDrawingBrush.width = parseInt(w);
        canvas.freeDrawingBrush.color = document.getElementById('fill-color').value;
        document.getElementById('brush-val').innerText = w;
    }

    // 8. 图层列表渲染
    function renderLayers() {
        const stack = document.getElementById('layer-stack');
        stack.innerHTML = '';
        canvas.getObjects().reverse().forEach((obj, i) => {
            const div = document.createElement('div');
            div.className = `layer-item flex items-center justify-between p-3 rounded mb-2 bg-white/5 text-[10px] cursor-pointer ${canvas.getActiveObject() === obj ? 'active' : ''}`;
            div.innerHTML = `<span><i data-lucide="layers" class="w-3 inline mr-2"></i> ${obj.type.toUpperCase()}</span> <i data-lucide="${obj.selectable ? 'unlock' : 'lock'}" class="w-3"></i>`;
            div.onclick = () => { canvas.setActiveObject(obj).renderAll(); renderLayers(); };
            stack.appendChild(div);
        });
        lucide.createIcons();
    }

    // 9. 工程保存与载入
    function exportProject() {
        const json = JSON.stringify(canvas);
        const blob = new Blob([json], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `project-${Date.now()}.json`;
        a.click();
    }

    // 10. 撤销/重做
    function saveHistory() {
        if(mods < history.length) history = history.slice(0, mods);
        history.push(JSON.stringify(canvas));
        mods++;
    }
    function undo() { if(mods > 1) { mods--; canvas.loadFromJSON(history[mods-1], () => canvas.renderAll()); } }
    function redo() { if(mods < history.length) { canvas.loadFromJSON(history[mods], () => canvas.renderAll()); mods++; } }

    // 辅助初始化
    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => fabric.Image.fromURL(f.target.result, img => addObject(img.scaleToWidth(500)));
        reader.readAsDataURL(e.target.files[0]);
    };
    canvas.on('object:modified', saveHistory);
</script>
</body>
</html>