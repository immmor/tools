<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>immmor Photoshop ULTRA | 极客全功能图像实验室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background: #050505; color: #e2e8f0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .ps-layout { display: grid; grid-template-columns: 60px 280px 1fr 280px; grid-template-rows: 50px 1fr; height: 100vh; }
        .glass-panel { background: rgba(15, 15, 20, 0.9); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .tool-btn { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: 0.2s; color: #64748b; margin-bottom: 8px; }
        .tool-btn:hover, .tool-btn.active { background: #3b82f6; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .canvas-area { background-color: #111; background-image: radial-gradient(#222 1px, transparent 1px); background-size: 20px 20px; overflow: auto; display: flex; align-items: center; justify-content: center; position: relative; }
        input[type=range] { appearance: none; background: #2d2d35; height: 4px; border-radius: 2px; width: 100%; }
        input[type=range]::-webkit-slider-thumb { appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #3b82f6; cursor: pointer; }
        .layer-item.active { border-left: 3px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body>

<div class="ps-layout">
    <header class="col-span-4 glass-panel flex items-center px-4 justify-between border-b">
        <div class="flex items-center space-x-6">
            <span class="font-black italic text-blue-500 text-xl tracking-tighter">im.PS ULTRA</span>
            <div class="flex space-x-4 text-[11px] uppercase tracking-widest text-gray-400">
                <button onclick="document.getElementById('fileInput').click()" class="hover:text-white">Open</button>
                <button onclick="saveProject()" class="hover:text-white">Save Project</button>
                <button onclick="downloadImage()" class="text-blue-400 font-bold">Export PNG</button>
                <button onclick="toggleFullscreen()" class="hover:text-white">Fullscreen</button>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <button onclick="undo()" class="text-gray-400 hover:text-white"><i data-lucide="undo-2" class="w-4"></i></button>
            <button onclick="redo()" class="text-gray-400 hover:text-white"><i data-lucide="redo-2" class="w-4"></i></button>
        </div>
    </header>

    <aside class="glass-panel flex flex-col items-center py-4 border-r">
        <button class="tool-btn active" onclick="setMode('select')" id="btn-select"><i data-lucide="mouse-pointer-2"></i></button>
        <button class="tool-btn" onclick="addRect()" title="矩形"><i data-lucide="square"></i></button>
        <button class="tool-btn" onclick="addCircle()" title="圆形"><i data-lucide="circle"></i></button>
        <button class="tool-btn" onclick="addText()" title="文字"><i data-lucide="type"></i></button>
        <button class="tool-btn" onclick="toggleDrawing()" id="btn-brush"><i data-lucide="paintbrush"></i></button>
        <div class="w-8 h-[1px] bg-gray-800 my-2"></div>
        <button class="tool-btn" onclick="changeZIndex('up')" title="上移一层"><i data-lucide="layers-2"></i></button>
        <button class="tool-btn text-red-500" onclick="deleteSelected()" title="删除"><i data-lucide="trash-2"></i></button>
    </aside>

    <aside class="glass-panel p-5 border-r space-y-6 overflow-y-auto">
        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">变换与样式 Transform</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-xs">颜色</span>
                    <input type="color" id="fill-color" class="w-8 h-8 bg-transparent" oninput="updateStyle()">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-2">不透明度 <span id="op-val">100%</span></div>
                    <input type="range" id="opacity" min="0" max="1" step="0.01" value="1" oninput="updateStyle()">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-2">阴影距离 <span id="sh-val">0</span></div>
                    <input type="range" id="shadow-blur" min="0" max="50" value="0" oninput="updateStyle()">
                </div>
            </div>
        </section>

        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">混合模式 Blending</h3>
            <select id="blend-mode" class="w-full bg-gray-800 text-xs p-2 rounded border-none" onchange="updateStyle()">
                <option value="source-over">正常 (Normal)</option>
                <option value="multiply">正片叠底 (Multiply)</option>
                <option value="screen">滤色 (Screen)</option>
                <option value="overlay">叠加 (Overlay)</option>
                <option value="difference">差值 (Difference)</option>
            </select>
        </section>

        <section>
            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">视图 View</h3>
            <button onclick="toggleGrid()" class="w-full py-2 glass-panel rounded text-[11px] hover:bg-white/10 mb-2">切换网格辅助线</button>
            <button onclick="resetZoom()" class="w-full py-2 glass-panel rounded text-[11px] hover:bg-white/10">重置缩放</button>
        </section>
    </aside>

    <main class="canvas-area" id="canvas-container">
        <canvas id="main-canvas"></canvas>
        <input type="file" id="fileInput" class="hidden">
    </main>

    <aside class="glass-panel border-l p-4 flex flex-col">
        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">图层 Layers</h3>
        <div id="layer-stack" class="flex-1 space-y-2 overflow-y-auto"></div>
        <div class="mt-4 pt-4 border-t border-white/5 text-[10px] text-gray-600 font-mono">
            ZOOM: <span id="zoom-level">100%</span>
        </div>
    </aside>
</div>

<script>
    // 1. 初始化
    const canvas = new fabric.Canvas('main-canvas', {
        width: 1000, height: 700,
        backgroundColor: '#111',
        preserveObjectStacking: true
    });

    let history = [];
    let mods = 0;
    lucide.createIcons();

    // 2. 核心功能函数
    function addRect() {
        const rect = new fabric.Rect({ left: 100, top: 100, fill: '#3b82f6', width: 100, height: 100, cornerColor: '#3b82f6', cornerSize: 6 });
        addObject(rect);
    }

    function addCircle() {
        const circle = new fabric.Circle({ left: 150, top: 150, fill: '#f472b6', radius: 50 });
        addObject(circle);
    }

    function addText() {
        const text = new fabric.IText('ULTRA TYPE', { left: 100, top: 100, fill: '#fff', fontSize: 40 });
        addObject(text);
    }

    function addObject(obj) {
        canvas.add(obj);
        canvas.setActiveObject(obj);
        saveHistory();
        renderLayers();
    }

    // 3. 样式处理 (包含混合模式 & 阴影)
    function updateStyle() {
        const obj = canvas.getActiveObject();
        if(!obj) return;

        const color = document.getElementById('fill-color').value;
        const opacity = document.getElementById('opacity').value;
        const blend = document.getElementById('blend-mode').value;
        const shadowBlur = document.getElementById('shadow-blur').value;

        obj.set({
            fill: color,
            opacity: parseFloat(opacity),
            globalCompositeOperation: blend,
            shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: parseInt(shadowBlur) })
        });
        
        document.getElementById('op-val').innerText = Math.round(opacity*100)+'%';
        canvas.renderAll();
    }

    // 4. 历史记录 (Undo/Redo)
    function saveHistory() {
        if(mods < history.length) history = history.slice(0, mods);
        history.push(JSON.stringify(canvas));
        mods++;
    }

    function undo() {
        if(mods > 1) {
            mods--;
            canvas.loadFromJSON(history[mods-1], () => canvas.renderAll());
        }
    }

    function redo() {
        if(mods < history.length) {
            canvas.loadFromJSON(history[mods], () => canvas.renderAll());
            mods++;
        }
    }

    // 5. 缩放功能 (Mouse Wheel)
    canvas.on('mouse:wheel', function(opt) {
        let delta = opt.e.deltaY;
        let zoom = canvas.getZoom();
        zoom *= 0.999 ** delta;
        if (zoom > 20) zoom = 20;
        if (zoom < 0.01) zoom = 0.01;
        canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
        opt.e.preventDefault();
        opt.e.stopPropagation();
        document.getElementById('zoom-level').innerText = Math.round(zoom * 100) + '%';
    });

    // 6. 图层管理与置顶
    function changeZIndex(dir) {
        const obj = canvas.getActiveObject();
        if(!obj) return;
        if(dir === 'up') canvas.bringForward(obj);
        renderLayers();
    }

    function renderLayers() {
        const stack = document.getElementById('layer-stack');
        stack.innerHTML = '';
        canvas.getObjects().reverse().forEach((obj, i) => {
            const el = document.createElement('div');
            el.className = `layer-item flex items-center p-2 rounded bg-white/5 text-[10px] cursor-pointer ${canvas.getActiveObject() === obj ? 'active' : ''}`;
            el.innerHTML = `<i data-lucide="layers" class="w-3 mr-2"></i> LAYER ${obj.type.toUpperCase()}`;
            el.onclick = () => { canvas.setActiveObject(obj); canvas.renderAll(); renderLayers(); };
            stack.appendChild(el);
        });
        lucide.createIcons();
    }

    // 7. 辅助线
    let gridVisible = false;
    function toggleGrid() {
        gridVisible = !gridVisible;
        canvas.setBackgroundColor(gridVisible ? {source: 'https://www.transparenttextures.com/patterns/carbon-fibre.png', repeat: 'repeat'} : '#111', canvas.renderAll.bind(canvas));
    }

    // 其他辅助功能
    function deleteSelected() { canvas.remove(...canvas.getActiveObjects()); canvas.discardActiveObject(); renderLayers(); saveHistory(); }
    function resetZoom() { canvas.setZoom(1); document.getElementById('zoom-level').innerText = '100%'; }
    function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
    
    // 初始化背景图导入
    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => fabric.Image.fromURL(f.target.result, img => addObject(img.scaleToWidth(400)));
        reader.readAsDataURL(e.target.files[0]);
    };

    canvas.on('object:modified', saveHistory);
    canvas.on('selection:created', renderLayers);
</script>
</body>
</html>