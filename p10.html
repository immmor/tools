<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI 本地去背景（稳定版）</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; text-align: center; background: #f4f7f6; }
        .container { background: white; padding: 20px; border-radius: 10px; shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .preview-area { display: flex; justify-content: space-around; margin-top: 20px; }
        img { max-width: 350px; border: 1px solid #ddd; background: #eee; }
        #status { color: #2196F3; margin: 10px; font-weight: bold; }
        .transparent-bg { background-image: repeating-conic-gradient(#fff 0 90deg, #f0f0f0 0 180deg); background-size: 20px 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>本地 AI 去背景</h2>
    <input type="file" id="upload" accept="image/*">
    <div id="status">等待上传...</div>

    <div class="preview-area">
        <div><p>原图</p><img id="before" src=""></div>
        <div><p>结果</p><div class="transparent-bg"><img id="after" src=""></div></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/imgly-background-removal/1.4.5/index.js"></script>

<script>
    const upload = document.getElementById('upload');
    const status = document.getElementById('status');
    const beforeImg = document.getElementById('before');
    const afterImg = document.getElementById('after');

    // 关键修复：检测函数位置的函数
    function getRemoveFn() {
        // 尝试从不同的全局变量中寻找函数
        if (typeof imglyRemoveBackground === 'function') return imglyRemoveBackground;
        if (window.imglyRemoveBackground && typeof window.imglyRemoveBackground.removeBackground === 'function') {
            return window.imglyRemoveBackground.removeBackground;
        }
        return null;
    }

    upload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // 检查库是否加载
        const removeBackground = getRemoveFn();
        if (!removeBackground) {
            alert("SDK 尚未加载完成或路径错误，请刷新页面重试。");
            return;
        }

        beforeImg.src = URL.createObjectURL(file);
        status.innerText = "正在加载 AI 模型 (首次运行约 50MB)...";
        upload.disabled = true;

        try {
            const blob = await removeBackground(file, {
                progress: (key, current, total) => {
                    const p = Math.round((current / total) * 100);
                    status.innerText = `处理中: ${p}%`;
                }
            });

            afterImg.src = URL.createObjectURL(blob);
            status.innerText = "✅ 处理完成！";
        } catch (err) {
            console.error(err);
            status.innerText = "❌ 失败: " + err.message;
        } finally {
            upload.disabled = false;
        }
    });
</script>

</body>
</html>