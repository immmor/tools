<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMMMOR NEURAL ENGINE v6.0</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

    <style>
        :root {
            --amber: #ffb000;
            --amber-dim: #714e00;
            --bg: #0d0c08;
            --panel-bg: #161410;
            --term-green: #00ff41;
            --term-red: #ff3e3e;
            --glass: rgba(255, 176, 0, 0.05);
            --border: 1px solid var(--amber-dim);
        }

        * { box-sizing: border-box; }
        body, html {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: var(--bg); color: var(--amber);
            font-family: 'Consolas', monospace; overflow: hidden;
        }

        /* Â∏ÉÂ±ÄÁªìÊûÑ */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .top-nav { height: 35px; border-bottom: 2px solid var(--amber); display: flex; align-items: center; padding: 0 15px; background: var(--panel-bg); justify-content: space-between; font-size: 11px; font-weight: bold; }
        
        .main-content { display: flex; flex: 1; overflow: hidden; }

        /* ÈÄöÁî®Èù¢ÊùøÊ†∑Âºè */
        .panel { background: var(--panel-bg); display: flex; flex-direction: column; border-right: var(--border); }
        .p-head { padding: 8px 12px; font-size: 10px; background: #000; border-bottom: var(--border); letter-spacing: 1px; display: flex; justify-content: space-between; }

        /* ÁºñËæëÂô®Âå∫Âüü */
        .editor-section { flex: 1; display: flex; flex-direction: column; position: relative; }
        .tabs-bar { height: 32px; background: #000; display: flex; border-bottom: var(--border); overflow-x: auto; }
        .tab { padding: 6px 15px; font-size: 11px; border-right: var(--border); cursor: pointer !important; opacity: 0.5; display: flex; align-items: center; }
        .tab.active { opacity: 1; background: var(--panel-bg); border-bottom: 2px solid var(--amber); }

        #editor { flex: 1; background: transparent; color: var(--amber); border: none; outline: none; padding: 20px; font-size: 15px; line-height: 1.6; resize: none; font-family: inherit; }

        /* AI ‰æßËæπÈù¢Êùø */
        .ai-panel { width: 380px; border-left: 2px solid var(--amber-dim); }
        .ai-scroller { flex: 1; overflow-y: auto; padding: 15px; background: linear-gradient(180deg, #000 0%, var(--bg) 100%); }

        /* Êñ∞ÔºöMarkdown Ê†∑ÂºèÂÆöÂà∂ */
        .markdown-body { line-height: 1.6; font-size: 13px; }
        .markdown-body p { margin-bottom: 12px; color: #ccc; }
        .markdown-body pre { 
            background: #000 !important; border: 1px solid var(--amber-dim); 
            padding: 35px 12px 12px !important; margin: 15px 0; border-radius: 4px; position: relative;
        }
        .markdown-body code { color: var(--term-green); font-family: inherit; }

        /* Êñ∞ÔºöApply & Diff ÊåâÈíÆÊ†∑Âºè */
        .code-actions { position: absolute; top: 6px; right: 6px; display: flex; gap: 6px; }
        .ai-btn {
            padding: 2px 8px; font-size: 9px; font-weight: bold; cursor: pointer !important;
            border: 1px solid currentColor; background: transparent; transition: 0.2s;
        }
        .ai-btn-apply { color: var(--term-green); }
        .ai-btn-apply:hover { background: var(--term-green); color: #000; }
        .ai-btn-diff { color: var(--amber); }
        .ai-btn-diff:hover { background: var(--amber); color: #000; }

        /* AI ËæìÂÖ•Ê°ÜÊ†∑Âºè */
        .ai-input-area { padding: 15px; background: #000; border-top: var(--border); }
        .input-wrapper { display: flex; gap: 8px; border: 1px solid var(--amber-dim); padding: 5px; background: var(--bg); }
        #ai-in { flex: 1; background: transparent; border: none; color: #fff; outline: none; font-family: inherit; resize: none; height: 40px; }
        .send-btn { background: var(--amber-dim); color: #fff; border: none; padding: 0 15px; cursor: pointer !important; }

        /* Diff È¢ÑËßàÁïåÈù¢Ê†∑Âºè */
        #diff-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; z-index: 1000; flex-direction: column;
        }
        .diff-header { padding: 15px; border-bottom: 2px solid var(--amber); display: flex; justify-content: space-between; background: var(--panel-bg); }
        .diff-body { flex: 1; overflow: auto; padding: 20px; font-size: 13px; }
        .diff-row { display: flex; border-bottom: 1px solid #111; }
        .diff-line-num { width: 40px; color: #444; text-align: right; padding-right: 10px; user-select: none; }
        .diff-text { flex: 1; padding-left: 10px; white-space: pre-wrap; }
        .diff-added { background: rgba(0, 255, 65, 0.15); color: #afffaf; }
        .diff-removed { background: rgba(255, 62, 62, 0.15); color: #ffafaf; }

        /* ÁªàÁ´ØÂå∫Âüü */
        .terminal { height: 160px; background: #000; border-top: 2px solid var(--amber-dim); padding: 10px; overflow-y: auto; font-size: 12px; }
        .term-log { color: var(--term-green); opacity: 0.8; margin-bottom: 2px; }

        /* Âä®Áîª */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .thinking { animation: pulse 1s infinite; color: var(--amber); font-size: 11px; }
    </style>
</head>
<body>

<div class="app-container">
    <nav class="top-nav">
        <div>CORE // NEURAL_INTERFACE_v6.0</div>
        <div id="py-status">PYTHON_IDLE</div>
    </nav>

    <div class="main-content">
        <aside class="panel" style="width: 180px;">
            <div class="p-head">EXPLORER</div>
            <div id="file-tree" style="padding: 10px; font-size: 11px;">
                <div onclick="switchFile('main.js')" style="cursor:pointer; margin-bottom:8px;">üìÅ main.js</div>
                <div onclick="switchFile('utils.py')" style="cursor:pointer; margin-bottom:8px;">üìÅ utils.py</div>
            </div>
        </aside>

        <section class="editor-section">
            <div class="tabs-bar" id="tabs">
                <div class="tab active">main.js</div>
            </div>
            <textarea id="editor" spellcheck="false">
function neuralSync() {
    const status = "INITIALIZING";
    // AI: Optimize this connection logic
    console.log("Core Status:", status);
}
            </textarea>

            <div class="terminal" id="term-out">
                <div class="term-log">System neural link established...</div>
            </div>

            <div id="diff-overlay">
                <div class="diff-header">
                    <span>DIFF_PREVIEW (GREEN = NEW)</span>
                    <div style="display:flex; gap:10px;">
                        <button class="ai-btn ai-btn-apply" onclick="confirmApply()">MERGE_CHANGES</button>
                        <button class="ai-btn" style="color:var(--term-red)" onclick="closeDiff()">DISCARD</button>
                    </div>
                </div>
                <div class="diff-body" id="diff-content"></div>
            </div>
        </section>

        <aside class="ai-panel">
            <div class="p-head">
                <span>AI_CO-PROCESSOR</span>
                <span id="ai-status">READY</span>
            </div>
            
            <div class="ai-scroller" id="ai-chat">
                <div class="markdown-body">
                    <p>Welcome, Architect. I have full access to your environment. Use <b>/explain</b> or <b>/fix</b> to command me.</p>
                </div>
            </div>

            <div class="ai-input-area">
                <div class="input-wrapper">
                    <textarea id="ai-in" placeholder="Command AI... (Ctrl+Enter)"></textarea>
                    <button class="send-btn" onclick="sendAi()">SEND</button>
                </div>
            </div>
        </aside>
    </div>
</div>

<script>
    // --- Ê†∏ÂøÉÂèòÈáè ---
    const editor = document.getElementById('editor');
    const aiChat = document.getElementById('ai-chat');
    const aiIn = document.getElementById('ai-in');
    let pendingCode = "";

    // --- ÂàùÂßãÂåñ Markdown ---
    marked.setOptions({
        highlight: (code, lang) => Prism.highlight(code, Prism.languages.javascript || Prism.languages.clike, lang)
    });

    // --- AI ÂèëÈÄÅÈÄªËæë ---
    async function sendAi() {
        const query = aiIn.value.trim();
        if (!query) return;

        addBubble('user', query);
        aiIn.value = '';
        const thinking = addBubble('ai', '<span class="thinking">SYNCING NEURAL PATHWAYS...</span>');

        // Ê®°Êãü AI Â§ÑÁêÜÈÄªËæë
        setTimeout(() => {
            const mockCode = `function neuralSync() {\n    const status = "ESTABLISHED";\n    const latency = Math.random() * 20;\n    console.log(\`Neural Link: \${status} (\${latency.toFixed(2)}ms)\`);\n}`;
            const response = `ÊàëÈáçÊñ∞ËÆæËÆ°‰∫ÜÈìæÊé•ÈÄªËæëÔºåÂ¢ûÂä†‰∫ÜÂª∂ËøüËÆ°ÁÆó‰ª•Â¢ûÂº∫ÁõëÊéßÔºö\n\n\`\`\`javascript\n${mockCode}\n\`\`\``;
            
            thinking.innerHTML = marked.parse(response);
            
            // Êâ´Êèè‰ª£Á†ÅÂùóÂπ∂Ê≥®ÂÖ•ÊåâÈíÆ
            thinking.querySelectorAll('pre').forEach(pre => {
                const code = pre.querySelector('code').innerText;
                const container = document.createElement('div');
                container.className = 'code-actions';

                const dBtn = document.createElement('button');
                dBtn.className = 'ai-btn ai-btn-diff'; dBtn.innerText = 'DIFF';
                dBtn.onclick = () => showDiff(code);

                const aBtn = document.createElement('button');
                aBtn.className = 'ai-btn ai-btn-apply'; aBtn.innerText = 'APPLY';
                aBtn.onclick = () => { applyCode(code); aBtn.innerText = 'INJECTED'; };

                container.append(dBtn, aBtn);
                pre.appendChild(container);
            });

            Prism.highlightAll();
        }, 800);
    }

    // --- DIFF ÂºïÊìé (ÂàÜÊ†èÊ†∑Âºè) ---
    function showDiff(newCode) {
        pendingCode = newCode;
        const oldCode = editor.value;
        const diffBody = document.getElementById('diff-content');
        const oldLines = oldCode.split('\n');
        const newLines = newCode.split('\n');
        
        let html = "";
        const maxLines = Math.max(oldLines.length, newLines.length);

        for (let i = 0; i < maxLines; i++) {
            const oldL = oldLines[i] || "";
            const newL = newLines[i] || "";
            
            if (oldL === newL) {
                html += `<div class="diff-row"><div class="diff-line-num">${i+1}</div><div class="diff-text">${oldL}</div></div>`;
            } else {
                if (oldL) html += `<div class="diff-row diff-removed"><div class="diff-line-num">${i+1}</div><div class="diff-text">- ${oldL}</div></div>`;
                if (newL) html += `<div class="diff-row diff-added"><div class="diff-line-num">${i+1}</div><div class="diff-text">+ ${newL}</div></div>`;
            }
        }
        
        diffBody.innerHTML = html;
        document.getElementById('diff-overlay').style.display = 'flex';
    }

    function confirmApply() {
        editor.value = pendingCode;
        closeDiff();
        addLog("Neural merge successful.");
    }

    function closeDiff() { document.getElementById('diff-overlay').style.display = 'none'; }

    // --- ËæÖÂä©ÈÄªËæë ---
    function applyCode(code) {
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        if (start !== end) {
            editor.setRangeText(code, start, end, 'select');
        } else {
            editor.value = code;
        }
        addLog("Code block injected into editor.");
    }

    function addBubble(role, html) {
        const div = document.createElement('div');
        div.className = `markdown-body ${role === 'user' ? 'user-bubble' : ''}`;
        div.style.marginBottom = '20px';
        div.style.padding = '10px';
        div.style.borderLeft = role === 'user' ? '2px solid var(--amber)' : '2px solid var(--term-green)';
        div.innerHTML = html;
        aiChat.appendChild(div);
        aiChat.scrollTop = aiChat.scrollHeight;
        return div;
    }

    function addLog(msg) {
        const out = document.getElementById('term-out');
        const line = document.createElement('div');
        line.className = 'term-log';
        line.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        out.appendChild(line);
        out.scrollTop = out.scrollHeight;
    }

    // ÁÉ≠ÈîÆÂèëÈÄÅ
    aiIn.onkeydown = (e) => {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            sendAi();
        }
    };

    function switchFile(name) {
        document.getElementById('tabs').innerHTML = `<div class="tab active">${name}</div>`;
        addLog(`Switched to context: ${name}`);
    }
</script>

</body>
</html>